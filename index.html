<!DOCTYPE html>
<html lang="zh-TW" class="scroll-smooth">
<head>
    <meta name="robots" content="noindex, nofollow">
    <meta name="apple-mobile-web-app-title" content="å‡ºä¼ç©å›‰">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png?v=1">
    <link rel="icon" href="icon.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026 Korea Travel Guide</title>
	<script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@600&display=swap" rel="stylesheet">    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- è¼‰å…¥ Firebase SDK (æ¡ç”¨ ES Module æ–¹å¼) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        try {
            // å¾åŸ·è¡Œç’°å¢ƒè®Šæ•¸å–å¾— Firebase è¨­å®šï¼Œè‹¥ç„¡å‰‡æä¾›ç©ºç‰©ä»¶é˜²å‘†
            const firebaseConfig = {
			apiKey: "AIzaSyBpLmMrt7Yq6doywuDWcTVYen1P5o1sPfA",
			authDomain: "koreatripy.firebaseapp.com",
			projectId: "koreatripy",
			storageBucket: "koreatripy.firebasestorage.app",
			messagingSenderId: "324417509928",
			appId: "1:324417509928:web:1aecaf45fbc03e5faaf31d",
			measurementId: "G-ZZTYJE5QP2"
			};
            window.firebaseApp = initializeApp(firebaseConfig);
            window.firebaseAuth = getAuth(window.firebaseApp);
            window.firebaseDb = getFirestore(window.firebaseApp);
            
            // å°‡éœ€è¦ç”¨åˆ°çš„ Firestore èˆ‡ Auth æ–¹æ³•æ›è¼‰åˆ°å…¨åŸŸï¼Œä¾›ä¸‹æ–¹çš„ä¸»é‚è¼¯ä½¿ç”¨
            window.fsCollections = { collection, doc, setDoc, getDoc, onSnapshot, deleteDoc };
            window.fsAuthFns = { signInWithCustomToken, signInAnonymously, onAuthStateChanged };
            
            // ç™¼é€æº–å‚™å®Œæˆäº‹ä»¶
            window.dispatchEvent(new Event('firebaseReady'));
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—", e);
        }
	
    </script>

    <style>
        :root {
            --muji-bg: #F7F5F0; --muji-white: #FFFFFF; --muji-gray: #7F7F7F;
            --muji-dark: #333333; --muji-accent: #8E7358;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", sans-serif; 
            background-color: var(--muji-bg); 
            color: var(--muji-dark); 
            -webkit-tap-highlight-color: transparent; 
            -webkit-user-select: none; 
            user-select: none;
            line-height: 1.6;
            padding-bottom: calc(6rem + env(safe-area-inset-bottom));
        }

        nav { padding-top: env(safe-area-inset-top); }
        input, textarea, select, [contenteditable="true"] { -webkit-user-select: auto; user-select: auto; }
        .muji-card { background: var(--muji-white); border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .nav-btn { border-bottom: 2px solid transparent; transition: all 0.2s; }
        .nav-active { color: var(--muji-accent); border-bottom-color: var(--muji-accent); }
		/* â˜… å…¨é¢å‡ç´šç¶²é ç‰ˆæŒ‰éµå›é¥‹ â˜… */
        button, .nav-btn, a[class*="bg-"], label[class*="cursor-pointer"] { 
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1); 
            -webkit-tap-highlight-color: transparent;
        }
        button:active, .nav-btn:active, a[class*="bg-"]:active, label[class*="cursor-pointer"]:active { 
            transform: scale(0.92); 
            filter: brightness(0.92);
        }
        /* ç¢ºä¿è¨ˆç®—æ©Ÿç¶­æŒæ›´å¼·çƒˆçš„å°ˆå±¬å›é¥‹ */
        .calc-btn:active { transform: scale(0.85) !important; filter: brightness(0.9) !important; }
		/* å‡ç´šç‰ˆè¨ˆç®—æ©ŸæŒ‰éµå›é¥‹æ„Ÿèˆ‡é˜²é€£æŒ‰æ”¾å¤§ */
        .calc-btn { 
            background: #FFFFFF; 
            border: 1px solid rgba(0,0,0,0.05); 
            padding: 15px; 
            text-align: center;
            border-radius: 12px; 
            font-size: 1.3rem; 
            color: #333333; 
            box-shadow: 0 2px 0 rgba(0,0,0,0.02);
            transition: all 0.08s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            touch-action: manipulation; /* ç¦ç”¨æ‰‹æ©Ÿé›™æ“Šæ”¾å¤§ */
            -webkit-tap-highlight-color: transparent;
        }
        
        .calc-btn:active { 
            background: #E5E5EA; 
            transform: scale(0.85); 
            box-shadow: 0 0 0 rgba(0,0,0,0);
        }
        
        .calc-btn.bg-gray-200:active { background: #D1D1D6; }
        .calc-btn.bg-gray-800:active, .calc-btn.\!bg-gray-800:active { background: #000000 !important; filter: brightness(1.2); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* é‹ç®—ç¬¦è™ŸæŒ‰éˆ•ç‰¹æ®Šè‰² */
        .calc-btn.bg-gray-200:active { background: #E5E5EA; }
        
        /* ç­‰æ–¼æŒ‰éˆ•ç‰¹æ®Šè‰² */
        .calc-btn.col-span-4:active { filter: brightness(1.2); transform: scale(0.97); }        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .map-link { display: inline-flex; align-items: center; padding: 3px 6px; border-radius: 4px; font-size: 0.7rem; text-decoration: none; transition: all 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .icon-btn.selected { border-color: var(--muji-accent); background-color: #F7F5F0; color: var(--muji-accent); }
        .editable-title { border-bottom: 2px solid transparent; outline: none; transition: border-color 0.2s, background-color 0.2s; padding: 2px 6px; margin-left: -6px; border-radius: 4px; display: inline-block; min-width: 150px; }
        .editable-title:focus { border-bottom-color: var(--muji-accent); background-color: #fcfbf9; }
        .editable-title:hover { background-color: rgba(0,0,0,0.03); cursor: text; }
        @keyframes pulseBorder { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .editing-pulse { animation: pulseBorder 1.5s infinite; border-color: #3b82f6 !important; }
        
        /* éš±è—åŸç”Ÿé¡è‰²é¸æ“‡å™¨æ¨£å¼ */
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; }
        
        /* è¼‰å…¥ä¸­é®ç½©ç‰¹æ•ˆå·²ç§»é™¤ï¼Œæ”¹ç‚ºé›¢ç·šå„ªå…ˆé †æš¢é«”é©— */
    </style>
</head>
<body ontouchstart="">

    <!-- Top Navigation -->
    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-300 shadow-sm">
        <div class="px-4 py-3 flex flex-col items-center">
            <h1 class="text-lg font-bold tracking-widest text-gray-900">SEOUL & BUSAN 2026</h1>
            <div class="flex space-x-5 mt-2 text-gray-800 overflow-x-auto w-full justify-center hide-scrollbar">
                <button onclick="showTab('plan')" id="btn-plan" class="nav-btn pb-1 flex flex-col items-center w-[48px] shrink-0">
                    <span class="text-[13px] font-bold">è¡Œç¨‹</span><span class="text-[9px] font-normal uppercase mt-0.5 opacity-70">Plan</span>
                </button>
                <button onclick="showTab('flight')" id="btn-flight" class="nav-btn pb-1 flex flex-col items-center w-[48px] shrink-0">
                    <span class="text-[13px] font-bold">èˆªç­</span><span class="text-[9px] font-normal uppercase mt-0.5 opacity-70">Flight</span>
                </button>
                <button onclick="showTab('info')" id="btn-info" class="nav-btn pb-1 flex flex-col items-center w-[48px] shrink-0">
                    <span class="text-[13px] font-bold">è³‡è¨Š</span><span class="text-[9px] font-normal uppercase mt-0.5 opacity-70">Info</span>
                </button>
                <button onclick="showTab('wallet')" id="btn-wallet" class="nav-btn pb-1 flex flex-col items-center w-[48px] shrink-0">
                    <span class="text-[13px] font-bold">è¨˜å¸³</span><span class="text-[9px] font-normal uppercase mt-0.5 opacity-70">Wallet</span>
                </button>
                <button onclick="showTab('lists')" id="btn-lists" class="nav-btn pb-1 flex flex-col items-center w-[48px] shrink-0">
                    <span class="text-[13px] font-bold">å‚™å¿˜</span><span class="text-[9px] font-normal uppercase mt-0.5 opacity-70">Memo</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-md mx-auto px-4 mt-6" id="main-content">
        <section id="tab-plan" class="tab-content">
            <div class="flex justify-between items-center mb-6 border-b border-gray-300 pb-2">
                <h2 id="title-plan" contenteditable="true" onblur="saveTitle('plan', this.innerText)" class="text-2xl font-serif text-gray-900 font-bold editable-title">æ¯æ—¥è¡Œç¨‹å®‰æ’</h2>
                <button onclick="openInfoModal('plan')" class="text-xs bg-gray-800 text-white px-3 py-1.5 rounded font-bold hover:bg-gray-900 shadow-sm flex items-center shrink-0 ml-2">
                    <i class="fas fa-plus mr-1"></i>æ–°å¢è¡Œç¨‹
                </button>
            </div>
            <div id="plan-cards-container" class="space-y-6"></div>
        </section>

        <!-- TAB: FLIGHT (èˆªç­) -->
        <section id="tab-flight" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6 border-b border-gray-300 pb-2">
                <h2 id="title-flight" contenteditable="true" onblur="saveTitle('flight', this.innerText)" class="text-2xl font-serif text-gray-900 font-bold editable-title">èˆªç­è³‡è¨Šèˆ‡è¦å®š</h2>
                <button onclick="openInfoModal('flight')" class="text-xs bg-gray-800 text-white px-3 py-1.5 rounded font-bold hover:bg-gray-900 shadow-sm flex items-center shrink-0 ml-2">
                    <i class="fas fa-plus mr-1"></i>æ–°å¢å€å¡Š
                </button>
            </div>
            <div id="flight-cards-container" class="space-y-6"></div>
        </section>

        <!-- TAB: INFO (è³‡è¨Š) -->
        <section id="tab-info" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6 border-b border-gray-300 pb-2">
                <h2 id="title-info" contenteditable="true" onblur="saveTitle('info', this.innerText)" class="text-2xl font-serif text-gray-900 font-bold editable-title">é‡è¦è³‡è¨Šèˆ‡ä½å®¿</h2>
                <button onclick="openInfoModal('info')" class="text-xs bg-gray-800 text-white px-3 py-1.5 rounded font-bold hover:bg-gray-900 shadow-sm flex items-center shrink-0 ml-2">
                    <i class="fas fa-plus mr-1"></i>æ–°å¢å€å¡Š
                </button>
            </div>
            
            <!-- å¤©æ°£ Widget -->
            <div class="muji-card p-4 mb-6 border border-gray-200">
                <h3 class="font-bold mb-4 text-sm text-gray-900 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <span><i class="fas fa-cloud-sun mr-2 text-blue-500"></i>å³æ™‚å¤©æ°£é å ± <span class="text-[10px] text-gray-400 font-normal ml-1">(é»æ“Šçœ‹è©³ç´°)</span></span>
                    <div class="flex items-center space-x-2">
                        <span class="text-[10px] text-gray-500 font-normal" id="weather-update-time">è®€å–ä¸­...</span>
                        <button onclick="openWeatherSettings()" class="text-gray-400 hover:text-[#0284c7] p-1.5 rounded transition"><i class="fas fa-cog"></i></button>
                        <button onclick="fetchWeather(true)" class="text-gray-400 hover:text-gray-800 p-1.5 rounded-full bg-gray-50 active:bg-gray-200"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </h3>
                <div class="flex flex-nowrap overflow-x-auto gap-3 pb-2 hide-scrollbar" id="weather-container">
                    <!-- å‹•æ…‹æ¸²æŸ“å¤©æ°£å¡ç‰‡ -->
                </div>
            </div>

            <div id="info-cards-container" class="space-y-6"></div>
        </section>

        <!-- TAB: WALLET (è¨˜å¸³) -->
		<section id="tab-wallet" class="tab-content hidden">
            <div class="flex justify-between items-center border-b border-gray-300 pb-2 mb-4 w-full">
                <h2 id="title-wallet" contenteditable="true" onblur="saveTitle('wallet', this.innerText)" class="text-2xl font-serif text-gray-900 font-bold editable-title w-full">æ›åŒ¯èˆ‡è¨˜å¸³</h2>
            </div>            
            <div class="muji-card p-4 mb-4 border border-gray-200 mt-2">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center">
                        <span class="text-xs font-bold text-gray-800">åŒ¯ç‡ (1 TWD = KRW)</span>
                        <span id="exchange-update-time" class="text-[10px] text-gray-500 ml-2 font-normal">æ›´æ–°ä¸­...</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="fetchExchangeRate(true)" class="text-gray-400 hover:text-gray-800 p-1 rounded-full bg-gray-50 active:bg-gray-200" title="æ‰‹å‹•æ›´æ–°åŒ¯ç‡"><i class="fas fa-sync-alt text-xs"></i></button>
                        <input type="number" id="base-rate" value="41" onchange="updateCalcDisplay(); calcExpTwd();" class="w-16 text-right border-b border-gray-400 font-bold text-gray-900 focus:outline-none bg-transparent">
                    </div>
                </div>
                <div id="calc-display" class="text-right text-2xl font-bold text-gray-900 mb-4 py-2 border-b border-gray-300 min-h-[40px]">â‚© 0</div>
                <div id="calc-result-twd" class="text-right text-sm font-bold text-muji-accent mb-4">â‰ˆ NT$ 0</div>
                
				<div class="grid grid-cols-4 gap-2 w-full">
                    <button class="calc-btn col-span-2 text-red-600 font-bold bg-red-50 text-base" onclick="clearCalc()">C æ¸…é™¤</button>
                    <button class="calc-btn bg-gray-100 font-bold text-gray-500" onclick="backspaceCalc()">âŒ«</button>
                    <button class="calc-btn bg-[#f0f9ff] text-[#0369a1] font-bold text-xl" onclick="pressKey('/')">Ã·</button>
                    
                    <button class="calc-btn font-bold" onclick="pressKey('7')">7</button>
                    <button class="calc-btn font-bold" onclick="pressKey('8')">8</button>
                    <button class="calc-btn font-bold" onclick="pressKey('9')">9</button>
                    <button class="calc-btn bg-[#f0f9ff] text-[#0369a1] font-bold text-xl" onclick="pressKey('*')">Ã—</button>
                    
                    <button class="calc-btn font-bold" onclick="pressKey('4')">4</button>
                    <button class="calc-btn font-bold" onclick="pressKey('5')">5</button>
                    <button class="calc-btn font-bold" onclick="pressKey('6')">6</button>
                    <button class="calc-btn bg-[#f0f9ff] text-[#0369a1] font-bold text-xl" onclick="pressKey('-')">-</button>
                    
                    <button class="calc-btn font-bold" onclick="pressKey('1')">1</button>
                    <button class="calc-btn font-bold" onclick="pressKey('2')">2</button>
                    <button class="calc-btn font-bold" onclick="pressKey('3')">3</button>
                    <button class="calc-btn bg-[#f0f9ff] text-[#0369a1] font-bold text-xl" onclick="pressKey('+')">+</button>
                    
                    <button class="calc-btn col-span-2 font-bold" onclick="pressKey('0')">0</button>
                    <button class="calc-btn font-bold" onclick="pressKey('.')">.</button>
                    <button class="calc-btn !bg-gray-800 !text-white font-bold text-xl" onclick="evalCalc()">=</button>
                </div>
			</div>
			
            <!-- æ–°å¢/ä¿®æ”¹è¨˜å¸³è¡¨å–® -->
			<div class="muji-card p-4 mb-4 border border-gray-200 bg-white shadow-sm transition-colors duration-300 scroll-mt-24" id="expense-form-area">
                
                <div class="flex justify-between items-center mb-3 border-b border-gray-100 pb-2">
                    <span class="font-bold text-sm text-gray-900 flex items-center"><i class="fas fa-edit mr-1.5 text-muji-accent"></i><span id="exp-form-title">æ–°å¢è¨˜å¸³ç´€éŒ„</span></span>
                    <div class="flex items-center space-x-1.5">
                        <div class="flex items-center bg-gray-50 border border-gray-200 px-1.5 py-1 rounded shadow-sm">
                            <span class="text-[10px] text-gray-500 font-bold mr-1">åŒ¯ç‡</span>
                            <input type="number" id="exp-rate" oninput="calcExpTwd()" placeholder="è‡ªå‹•" class="w-16 text-[11px] font-bold text-gray-900 outline-none bg-transparent text-right">
                        </div>
                        <button onclick="copyCalcToExpense()" class="text-[10px] bg-gray-800 text-white px-2 py-1 rounded hover:bg-gray-900 shadow-sm shrink-0 font-bold"><i class="fas fa-calculator mr-1"></i>ä»£å…¥</button>
                    </div>
                </div>

                <div class="space-y-0 w-full">
                    <style>
                        .full-picker::-webkit-calendar-picker-indicator {
                            position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;
                        }
                    </style>
                    
                    <div class="border border-gray-300 rounded-xl bg-white shadow-sm mb-4 overflow-hidden flex flex-col">
                        
                        <div class="flex items-center px-3 py-2.5 border-b border-gray-200 bg-gray-50 relative">
                            <div class="relative flex-1 mr-2 border-r border-gray-300 pr-2 flex items-center">
                                <i class="fas fa-calendar-alt text-gray-400 w-5 text-center text-sm mr-1 pointer-events-none"></i>
                                <div id="exp-date-display" class="text-sm font-bold text-gray-800 pointer-events-none">2026/02/27 (äº”)</div>
                                <input type="date" id="exp-date" onchange="updateDateTimeDisplay()" onclick="try{this.showPicker()}catch(e){}" class="full-picker absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            </div>
                            <div class="relative w-[75px] flex items-center justify-end">
                                <i class="fas fa-clock text-gray-400 w-5 text-center text-sm mr-1 pointer-events-none"></i>
                                <div id="exp-time-display" class="text-sm font-bold text-gray-800 pointer-events-none">15:30</div>
                                <input type="time" id="exp-time-only" onchange="updateDateTimeDisplay()" onclick="try{this.showPicker()}catch(e){}" class="full-picker absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            </div>
                        </div>
                        
                        <div class="flex items-center px-3 py-2.5 border-b border-gray-200">
						<select id="exp-category" class="bg-white border border-gray-300 rounded-lg px-2 py-1.5 text-sm font-bold text-gray-800 outline-none w-[110px] shrink-0 mr-3 shadow-sm cursor-pointer hover:bg-gray-50 transition" style="text-align-last: center;">                                <option value="food" selected>ğŸ½ï¸ ç”¨é¤</option>
                                <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                                <option value="traffic">ğŸšŒ äº¤é€š</option>
                                <option value="ticket">ğŸ« é–€ç¥¨</option>
                                <option value="stay">ğŸ›ï¸ ä½å®¿</option>
                                <option value="other">ğŸ§¾ å…¶ä»–</option>
                            </select>
                            <input type="text" id="exp-name" placeholder="è¼¸å…¥æ¶ˆè²»å“é …..." class="flex-1 min-w-0 text-sm font-bold text-gray-900 bg-transparent outline-none">
                        </div>
                        
                        <div class="flex items-center px-3 py-3 bg-[#f0f9ff] border-b border-gray-200">
                            <div class="flex items-center flex-1 border-r border-[#bae6fd] pr-3">
                                <span class="text-[#0284c7] font-bold text-sm mr-2">â‚©</span>
                                <input type="number" id="exp-krw" placeholder="éŸ“å¹£" oninput="calcExpTwd()" class="w-full text-base font-bold text-gray-900 bg-transparent outline-none text-right">
                            </div>
                            <div class="flex items-center flex-1 pl-3">
                                <span class="text-[#0369a1] font-bold text-sm mr-2">NT$</span>
                                <input type="number" id="exp-twd" placeholder="å°å¹£" oninput="calcExpKrw()" class="w-full text-base font-bold text-gray-900 bg-transparent outline-none text-right">
                            </div>
                        </div>

                        <div class="px-3 py-2.5 border-b border-gray-200 bg-[#fffbeb]">
                            <div class="flex justify-between items-center mb-1.5">
                                <span class="text-xs font-bold text-[#854d0e] flex items-center">
                                    <i class="fas fa-user-check mr-1.5"></i>ä»£å¢Šäºº (èª°ä»˜éŒ¢)
                                </span>
                            </div>
                            <div id="payer-members-container" class="flex flex-wrap gap-2"></div>
                        </div>

                        <div class="px-3 py-2.5 bg-[#f0f9ff]">
                            <div class="flex justify-between items-center mb-1.5">
                                <span class="text-xs font-bold text-[#0369a1] flex items-center">
                                    <i class="fas fa-users mr-1.5"></i>åƒèˆ‡åˆ†æ”¤æˆå“¡
                                </span>
                                <button onclick="editMembers()" class="text-[10px] text-[#0284c7] font-bold bg-white border border-[#bae6fd] px-1.5 py-0.5 rounded shadow-sm hover:bg-white/80 transition">
                                    <i class="fas fa-cog mr-1"></i>åå–®ç®¡ç†
                                </button>
                            </div>
                            <div id="split-members-container" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <div class="flex space-x-2 pt-2">
                        <label class="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded text-xs font-bold cursor-pointer hover:bg-gray-50 flex items-center justify-center flex-1 shadow-sm">
                            <i class="fas fa-camera mr-1.5"></i> æ‹ç…§/åœ–ç‰‡
                            <input type="file" id="exp-photo" accept="image/*" class="hidden" onchange="previewExpPhoto(event)">
                        </label>
                        <button id="btn-cancel-exp" onclick="cancelEditExp()" class="hidden bg-gray-50 border border-gray-300 text-gray-700 px-4 py-2 rounded text-xs font-bold shadow-sm hover:bg-gray-100">å–æ¶ˆ</button>
                        <button id="btn-save-exp" onclick="saveExpense()" class="bg-gray-800 text-white px-4 py-2 rounded text-xs font-bold flex-1 shadow-sm hover:bg-black transition">å„²å­˜è¨˜å¸³</button>
                    </div>

                    <div id="exp-photo-preview" class="hidden mt-2 relative inline-block">
                        <img id="exp-img-tag" src="" class="h-24 object-cover rounded border border-gray-300 shadow-sm">
                        <button onclick="removeExpPhoto()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center shadow"><i class="fas fa-times text-[10px]"></i></button>
                    </div>
                </div>
            </div>
			
            <!-- æ­·å²ç´€éŒ„åˆ—è¡¨ -->
			<div class="flex justify-between items-center mb-3 mt-6 border-b border-gray-200 pb-2">
                <h3 class="font-bold text-sm text-gray-900"><i class="fas fa-list-ul mr-1 text-muji-accent"></i>æ­·å²è¨˜å¸³ç´€éŒ„</h3>
                <button onclick="openSettlementModal()" class="text-xs bg-[#0369a1] text-white px-3 py-1.5 rounded font-bold hover:bg-[#0284c7] shadow-sm flex items-center shrink-0 transition">
                    <i class="fas fa-calculator mr-1"></i>ä¸€éµçµç®—
                </button>
            </div>
            <div id="expense-list" class="mb-6 space-y-3"></div>
			</section>

        <!-- TAB: MEMO (å‚™å¿˜) -->
        <section id="tab-lists" class="tab-content hidden">
            <h2 id="title-lists" contenteditable="true" onblur="saveTitle('lists', this.innerText)" class="text-2xl font-serif text-gray-900 border-b border-gray-300 pb-2 mb-6 font-bold editable-title w-full">è¡Œç¨‹å‚™å¿˜éŒ„</h2>
            
            <div class="muji-card p-4 mb-6 border border-gray-200">
				<div class="text-[10px] text-gray-500 mb-2 font-bold">ğŸ’ æ­¤æ¸…å–®åƒ…å­˜æ–¼æ‚¨çš„æ‰‹æ©Ÿï¼Œä¸æœƒèˆ‡æ—…ä¼´åŒæ­¥</div>
                <div id="checklist-container" class="mb-4 space-y-3"></div>
                <div class="flex items-center space-x-2 border-t border-gray-200 pt-4">
                    <input type="text" id="new-check-item" placeholder="æ–°å¢è‡ªè¨‚é …ç›®..." class="flex-1 text-sm font-bold p-2 bg-gray-50 border border-gray-300 rounded outline-none text-gray-900">
                    <button onclick="addChecklistItem()" class="bg-gray-800 text-white px-4 py-2 rounded text-sm font-bold">æ–°å¢</button>
                </div>
            </div>
            
			<div class="flex justify-between items-center mb-4 border-b border-gray-300 pb-2 mt-6">
                <h3 id="title-lists-sub" contenteditable="true" onblur="saveTitle('listsSub', this.innerText)" class="font-bold text-lg text-gray-900 editable-title min-w-[150px]">å…¶ä»–å‚™å¿˜éŒ„</h3>
                <button onclick="openInfoModal('lists')" class="text-xs bg-[#0369a1] text-white px-3 py-1.5 rounded font-bold hover:bg-[#0284c7] shadow-sm transition flex items-center shrink-0">                    <i class="fas fa-plus mr-1"></i>æ–°å¢ç·¨è¼¯å€å¡Š
                </button>
            </div>
            <div id="lists-cards-container" class="space-y-6 mb-6"></div>			
            <!-- â˜… é›²ç«¯åŒæ­¥ç‹€æ…‹å€å¡Š â˜… -->
            <div class="muji-card p-4 mb-5 border border-gray-200 bg-gradient-to-br from-[#f0fdf4] to-[#dcfce7] shadow-sm relative overflow-hidden">
                <div class="absolute top-0 right-0 p-3 opacity-20"><i class="fas fa-cloud text-5xl text-green-700"></i></div>
                <h3 class="font-bold text-sm mb-2 text-[#166534] flex items-center justify-between relative z-10">
                    <span><i class="fas fa-cloud-upload-alt mr-2 text-[#15803d]"></i>é›²ç«¯å³æ™‚åŒæ­¥ä¸­</span>
                    <span class="flex h-3 w-3 relative mr-1">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                </h3>
                <p class="text-[11px] text-[#166534] opacity-90 leading-relaxed relative z-10">
                    é€™ä»½æŒ‡å—å·²å‡ç´šç‚ºåœ˜éšŠé›²ç«¯å…±ç”¨ç‰ˆï¼<br>
                    é™¤äº†å‚™å¿˜éŒ„å·²å¤–çš„æ‰€æœ‰è³‡è¨Šéƒ½æœƒè‡ªå‹•å„²å­˜ã€‚åªè¦å°‡é€™å€‹ç¶²é çš„ç¶²å€å‚³çµ¦æ—…ä¼´ï¼Œå¤§å®¶å°±èƒ½å³æ™‚çœ‹åˆ°ä¸¦ç·¨è¼¯æœ€æ–°è³‡æ–™å–”ï¼
                </p>
            </div>
        </section>

    </main>

    <!-- æˆå“¡ç®¡ç† Modal -->
    <div id="members-modal" class="fixed inset-0 bg-black/60 z-[150] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg border border-gray-200 p-5 w-[90%] max-w-[320px] shadow-2xl">
            <h3 class="font-bold text-gray-900 mb-4">è¨­å®šå‡ºéŠæˆå“¡åå–®</h3>
            <div class="space-y-2 mb-4" id="members-edit-list"></div>
            <div class="flex space-x-2 mb-4 w-full">
                <input type="text" id="new-member-name" placeholder="æ–°å¢åå­—" class="flex-1 min-w-0 border border-gray-300 rounded p-2 text-sm font-bold outline-none">
                <button onclick="addMember()" class="bg-gray-800 text-white px-3 py-2 rounded text-sm font-bold shrink-0">åŠ å…¥</button>
            </div>
            <button onclick="closeMembersModal()" class="text-sm bg-gray-800 text-white px-4 py-2 rounded font-bold shadow w-full">å®Œæˆ</button>
        </div>
    </div>

    <!-- å¤©æ°£è©³æƒ… Modal -->
    <div id="weather-detail-modal" class="fixed inset-0 bg-black/60 z-[400] hidden items-center justify-center p-4 backdrop-blur-sm" onclick="closeWeatherDetail()">
        <div class="bg-white rounded-xl w-full max-w-[320px] shadow-2xl overflow-hidden animate-fade-in" onclick="event.stopPropagation()">
            <div class="bg-gray-100 p-4 flex justify-between items-center border-b border-gray-200">
                <h3 class="font-bold text-gray-800 text-base" id="weather-detail-title">å¤©æ°£è©³æƒ…</h3>
                <button onclick="closeWeatherDetail()" class="text-gray-500 rounded-full w-7 h-7 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-2 px-4 bg-white flex justify-between text-xs font-bold text-gray-500 border-b border-gray-100">
                <span class="w-12">æ™‚é–“</span><span class="w-8 text-center">å¤©æ°£</span><span class="w-12 text-right">æº«åº¦</span><span class="w-12 text-right">é™é›¨æ©Ÿç‡</span>
            </div>
            <div class="p-2 max-h-[55vh] overflow-y-auto hide-scrollbar space-y-1 bg-white" id="weather-detail-content"></div>
        </div>
    </div>

    <!-- å¤©æ°£é¢æ¿è¨­å®š Modal -->
	<div id="weather-settings-modal" class="fixed inset-0 bg-black/60 z-[500] hidden items-center justify-center backdrop-blur-sm" style="padding-top: max(env(safe-area-inset-top), 15px); padding-bottom: max(env(safe-area-inset-bottom), 15px); padding-left: 10px; padding-right: 10px;" onclick="closeWeatherSettings()">
        <div class="bg-white rounded-xl w-full max-w-[340px] shadow-2xl overflow-hidden flex flex-col h-full max-h-full sm:h-auto sm:max-h-[85vh]" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 shrink-0">
                <h3 class="font-bold text-gray-900 text-base"><i class="fas fa-cog mr-2 text-gray-500"></i>å¤©æ°£é¢æ¿è¨­å®š</h3>
                <button onclick="closeWeatherSettings()" class="text-gray-500 hover:text-gray-900 text-xl w-8 h-8 flex items-center justify-center bg-gray-200 rounded-full transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 overflow-y-auto space-y-3 bg-gray-100 flex-1 overscroll-contain" id="weather-settings-list"></div>
        </div>
    </div>
	
    <!-- åœ–ç‰‡å¤§åœ– Modal -->
    <div id="photo-modal" class="fixed inset-0 bg-black/90 z-[200] hidden items-center justify-center p-4 backdrop-blur-sm" onclick="closePhotoModal()">
        <img id="photo-modal-img" src="" class="max-w-full max-h-[80vh] object-contain rounded">
    </div>

    <!-- è¨Šæ¯æç¤º Modal -->
    <div id="msg-modal" class="fixed inset-0 bg-black/60 z-[700] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg border border-gray-200 p-5 w-full max-w-[280px] shadow-2xl text-center">
            <div id="msg-modal-icon" class="text-3xl mb-2 text-[#89b0ae]"><i class="fas fa-info-circle"></i></div>
            <h3 id="msg-modal-text" class="font-bold text-gray-900 mb-4 whitespace-pre-wrap leading-relaxed text-sm">è¨Šæ¯</h3>
            <div class="flex justify-center space-x-3 mt-4" id="msg-modal-btns"></div>
        </div>
    </div>

    <!-- å¡ç‰‡ç·¨è¼¯å™¨ Modal -->
	<div id="info-modal" class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center backdrop-blur-sm" style="padding-top: max(env(safe-area-inset-top), 15px); padding-bottom: max(env(safe-area-inset-bottom), 15px); padding-left: 10px; padding-right: 10px;">
        <div class="bg-gray-50 rounded-xl border border-gray-300 w-full max-w-md shadow-2xl flex flex-col h-full max-h-full sm:h-auto sm:max-h-[85vh] overflow-hidden">
            
            <div class="bg-white px-4 py-3 border-b border-gray-200 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-gray-900 text-lg">ç·¨è¼¯å€å¡Šå…§å®¹</h3>
                <button onclick="closeInfoModal()" class="text-gray-500 hover:text-gray-800 transition p-1"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="p-4 space-y-5 overflow-y-auto hide-scrollbar flex-1 overscroll-contain">
                <div class="bg-white p-3 rounded border border-gray-200 shadow-sm space-y-3">
				<div id="info-edit-title-preview" class="mb-3"></div>
                    <div>
                        <label class="text-xs font-bold text-gray-700 block mb-1">å¡ç‰‡æ¨™é¡Œ</label>
                        <input type="text" id="info-edit-title" oninput="editState.title=this.value; updateInfoModalUI()" class="w-full border border-gray-300 rounded p-2 text-sm font-bold text-gray-900">
                    </div>
                    <div><label class="text-xs font-bold text-gray-700 block mb-1">å¡ç‰‡ä¸»è‰²èª¿</label><div id="info-edit-color-picker"></div></div>
                    <div><label class="text-xs font-bold text-gray-700 block mb-1">æ¨™é¡Œåœ–ç¤º</label><div class="h-28 overflow-y-auto border border-gray-200 rounded p-2 grid grid-cols-6 gap-2 bg-gray-50 hide-scrollbar overscroll-contain" id="info-edit-icon-picker"></div></div>
                </div>
                <div id="info-edit-blocks-container" class="space-y-3"></div>
                
                <div class="grid grid-cols-2 gap-2 pt-2 border-t border-gray-200">
                    <button onclick="addInfoBlock('badge')" class="bg-white border border-gray-300 py-2 rounded text-xs font-bold shadow-sm hover:bg-gray-50 transition">+ æ¨™ç±¤åˆ—</button>
                    <button onclick="addInfoBlock('alert')" class="bg-white border border-gray-300 py-2 rounded text-xs font-bold shadow-sm hover:bg-gray-50 transition">+ æé†’æ¡†</button>
                    <button onclick="addInfoBlock('grid')" class="bg-white border border-gray-300 py-2 rounded text-xs font-bold shadow-sm hover:bg-gray-50 transition">+ è¡¨æ ¼</button>
                    <button onclick="addInfoBlock('text')" class="bg-white border border-gray-300 py-2 rounded text-xs font-bold shadow-sm hover:bg-gray-50 transition">+ ç´”æ–‡å­—</button>
                    <button onclick="addInfoBlock('split')" class="col-span-2 bg-[#f0f9ff] border border-[#bae6fd] py-2 rounded text-xs font-bold shadow-sm hover:bg-[#e0f2fe] transition text-[#0369a1]">+ åˆ†çµ„è·¯ç·š (å·¦å³ä¸¦åˆ—)</button>
                </div>
            </div>

            <div class="bg-white px-4 py-3 border-t border-gray-200 flex justify-between items-center shadow-[0_-2px_10px_rgba(0,0,0,0.05)] shrink-0">
                <button onclick="deleteCurrentInfoCard()" class="text-sm text-red-600 font-bold hover:text-red-800 px-2 py-1">åˆªé™¤å¡ç‰‡</button>
                <button onclick="saveInfoCard()" class="text-sm bg-gray-900 text-white px-6 py-2 rounded font-bold shadow-md hover:bg-black transition">å„²å­˜è®Šæ›´</button>
            </div>
        </div> 
    </div>
	
    <script>
        // --- é›²ç«¯èˆ‡åŸºæœ¬è®Šæ•¸å®šç¾© ---
        let editState = null;
        let currentEditTab = 'plan';
        
        let db, auth;
        let currentUser = null;
        let appId = typeof __app_id !== 'undefined' ? __app_id : 'korea-trip-shared';
        
        let planCardsData = [];
        let flightCardsData = [];
		let infoCardsData = [];
        let listsCardsData = JSON.parse(localStorage.getItem('korea_lists_v1')) || [];
        let weatherLocs = [];
        let expenses = [];
        let travelMembers = [];
        let selectedSplitMembers = []; let selectedPayer = ''; 
        let currentCalc = ""; let currentExpBase64 = null; let editingExpId = null; 
        let currentExpColor = '#ffffff';
        let memo = '';
        let checklist = [];
        let editingChecklistIdx = -1;
        let titles = {};

        // è«è˜­è¿ªèª¿è‰²ç›¤ (ç”±æ·ºåˆ°æ·±æ’åˆ—)
        const morandiColors = [
            { name: 'é›ªç™½', hex: '#ffffff' }, { name: 'å¥¶ç™½', hex: '#fbfbf9' }, { name: 'æ·ºç°', hex: '#f3f4f6' },
            { name: 'ç‡•éº¥', hex: '#f4ebd9' }, { name: 'å¥¶é»ƒ', hex: '#fef9c3' }, { name: 'å¥¶æ©˜', hex: '#ffedd5' },
            { name: 'èœœæ¡ƒ', hex: '#fcd3c1' }, { name: 'æ«»èŠ±', hex: '#f5d0d6' }, { name: 'å¥¶ç²‰', hex: '#fce7f3' },
            { name: 'å¥¶ç´«', hex: '#f3e8ff' }, { name: 'å†°è—', hex: '#d0e8f2' }, { name: 'å¥¶è—', hex: '#e0f2fe' },
            { name: 'å¥¶ç¶ ', hex: '#dcfce7' }, { name: 'ç°ç¶ ', hex: '#8eb69b' }, { name: 'éœ§è—', hex: '#89b0ae' },
            { name: 'ç°ç´«', hex: '#9b89b3' }, { name: 'è±†æ²™', hex: '#d291bc' }, { name: 'ç¥ç€', hex: '#d97757' },
            { name: 'å¥¶èŒ¶', hex: '#d8c8b8' }, { name: 'ç„¡å°æ£•', hex: '#8E7358' }, { name: 'è«è˜­ç°', hex: '#b4b4b8' },
            { name: 'ç‚­ç°', hex: '#4b5563' }, { name: 'æ·±é»ƒ', hex: '#a16207' }, { name: 'æ·±ç¶ ', hex: '#14532d' },
            { name: 'æ·±è—', hex: '#0369a1' }, { name: 'æ·±ç´«', hex: '#581c87' }, { name: 'æ·±ç²‰', hex: '#9d174d' },
            { name: 'ç´”é»‘', hex: '#111827' }
        ];

        function toHex(val) {
            if(!val) return '#333333';
            if(val.startsWith('#')) return val;
            const map = {
                'blue': '#e0f2fe', 'green': '#dcfce7', 'red': '#fce7f3', 'yellow': '#fef9c3', 'orange': '#ffedd5', 'purple': '#f3e8ff', 'gray': '#f3f4f6', 'white': '#ffffff'
            };
            return map[val] || val;
        }

        function getClothingSuggestion(temp) {
            if (temp >= 28) return 'çŸ­è¢–é€æ°£';
            if (temp >= 22) return 'çŸ­è¢–+è–„å¤–å¥—';
            if (temp >= 15) return 'é•·è¢–+ç§‹è£å¤–å¥—';
            if (temp >= 10) return 'æ¯›è¡£+é˜²é¢¨å¤–å¥—';
            return 'ç™¼ç†±è¡£+åšå¤–å¥—';
        }

		// --- ç³»çµ±æ‰€éœ€åœ–ç¤ºèˆ‡å¤©æ°£å°ç…§è¡¨ ---
        const iconsList = ['fa-plane', 'fa-suitcase', 'fa-passport', 'fa-map-marker-alt', 'fa-bed', 'fa-utensils', 'fa-shopping-bag', 'fa-camera', 'fa-subway', 'fa-bus', 'fa-ticket-alt', 'fa-star', 'fa-heart', 'fa-exclamation-circle', 'fa-info-circle', 'fa-flag', 'fa-coffee', 'fa-store', 'fa-won-sign', 'fa-calendar-alt', 'fa-clock', 'fa-user-friends', 'fa-bullhorn'];
        const weatherCodeMap = {
            0:{icon:'â˜€ï¸'}, 1:{icon:'ğŸŒ¤ï¸'}, 2:{icon:'â›…'}, 3:{icon:'â˜ï¸'},
            45:{icon:'ğŸŒ«ï¸'}, 48:{icon:'ğŸŒ«ï¸'}, 51:{icon:'ğŸŒ§ï¸'}, 53:{icon:'ğŸŒ§ï¸'}, 55:{icon:'ğŸŒ§ï¸'},
            61:{icon:'â˜”'}, 63:{icon:'â˜”'}, 65:{icon:'â˜”'}, 71:{icon:'â„ï¸'}, 73:{icon:'â„ï¸'}, 75:{icon:'â„ï¸'},
            80:{icon:'ğŸŒ¦ï¸'}, 81:{icon:'ğŸŒ¦ï¸'}, 82:{icon:'â˜”'}, 95:{icon:'â›ˆï¸'}, 96:{icon:'â›ˆï¸'}, 99:{icon:'â›ˆï¸'}
        };

        // --- â˜… é è¨­è³‡æ–™ â˜… ---
const defaultPlanCards = [
            { id: 'p1', title: 'Day 1ï¼š5/22 (äº”) å•Ÿç¨‹èˆ‡æŠµé”', icon: 'fa-plane-arrival', color: '#0369a1', blocks: [
                { type: 'badge', items: [{ style: '#e0f2fe', textColor: '#0369a1', titleColor: '#0369a1', badge: '20:00', title: 'é£›å¾€éŸ“åœ‹ (æ¡ƒåœ’ -> ä»å·)', details: [{text: 'âœˆï¸ å°ç£è™èˆª IT602'}, {text: 'â³ é£›è¡Œæ™‚é–“ç´„ 2.5 å°æ™‚'}] }] },
                { type: 'alert', style: '#fce7f3', textColor: '#9d174d', icon: 'ğŸš¨', text: '23:30 æŠµé”ä»å·æ©Ÿå ´ (ICN)\nã€é‡è¦é›†åˆæ™‚é–“ã€‘é ˜å®Œè¡Œæå¾Œè«‹æ–¼å…¥å¢ƒå¤§å»³ã€ŒåŒ…è»Šè™•é›†åˆã€ï¼Œé€¾æ™‚ä¸å€™ï¼' },
                { type: 'badge', items: [{ style: '#f3f4f6', textColor: '#374151', titleColor: '#111827', badge: '01:00', title: 'å…¥ä½ äº¨å¾·é£¯åº— (Hound Hotel)', details: [{text: 'ğŸš‡ äº¤é€šï¼šé›²è¥¿ç«™ 1è™Ÿå‡ºå£ (ç«™å…§è¨­æœ‰æ‰‹æ‰¶æ¢¯/å¤§å‹é›»æ¢¯)'}, {text: 'ğŸ•’ ä½å®¿è³‡è¨Šï¼šå…¥ä½ 15:00 / é€€æˆ¿ 12:00'}, {text: 'https://www.google.com/maps/search/?api=1&query=Hound+Hotel+Incheon+Airport', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/Hound%20Hotel%20Incheon%20Airport', isLink: true, linkName: 'Naverå°èˆª'}] }] }
            ]},
            { id: 'p2', title: 'Day 2ï¼š5/23 (å…­) æ›åŒ¯ã€æ±Ÿå—èˆ‡è–æ°´æ´', icon: 'fa-shopping-bag', color: '#4b5563', blocks: [
                { type: 'alert', style: '#fef9c3', textColor: '#a16207', icon: 'ğŸ’¡', text: 'æ—©ä¸Šé€€æˆ¿å¾Œï¼Œå¸¶è‘—å°å¹£ç›´å¥”å¼˜å¤§ï¼\nå…ˆå»åœ°éµç«™å¯„æ”¾è¡Œæï¼Œæ¥è‘—é¦¬ä¸Šå»æ›éŸ“å¹£ï¼Œæ‰æœ‰ç¾é‡‘å¯ä»¥åƒå–ç©æ¨‚ï¼' },
                { type: 'badge', items: [
                    { style: '#f3f4f6', textColor: '#374151', titleColor: '#111827', badge: '09:30', title: 'å¼˜å¤§å…¥å£ç«™ è¡Œæå¯„æ”¾ (T-Luggage)', details: [{text: 'ğŸš‡ äº¤é€šï¼šæ­ä¹˜æ©Ÿå ´å¿«ç·š(AREX)å¾é›²è¥¿ç›´é”å¼˜å¤§å…¥å£ç«™ (è½‰ä¹˜é€šé“æœ‰å¤§å‹é›»æ¢¯)'}, {text: 'ğŸ§³ ç‡Ÿæ¥­æ™‚é–“ï¼š09:00~22:00'}, {text: 'https://www.google.com/maps/search/?api=1&query=T-Luggage+Hongik+University+Station', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/T-Luggage%20í™ëŒ€ì…êµ¬ì—­', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#e0f2fe', textColor: '#0284c7', titleColor: '#0369a1', badge: '10:00', title: 'å¼˜å¤§æ›éŒ¢æ‰€ (å°å¹£æ›éŸ“å…ƒ)', details: [{text: 'ğŸš¶ äº¤é€šï¼šå¾ T-Luggage æ­¥è¡Œå‡ºç™¼ (ç´„èµ° 5-10 åˆ†é˜)'}, {text: 'ğŸª æ›éŒ¢æ‰€ç‡Ÿæ¥­æ™‚é–“ï¼šé€šå¸¸ 10:00~21:00'}, {text: 'https://www.google.com/maps/search/?api=1&query=Hongdae+Money+Exchange', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/í™ëŒ€%20í™˜ì „ì†Œ', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#ffedd5', textColor: '#c2410c', titleColor: '#9a3412', badge: '11:30', title: 'æ—©åˆé¤ï¼šmmn 17 (æ±Ÿå—å€å»³ç«™)', details: [{text: 'ğŸš‡ äº¤é€šï¼šå¼˜å¤§å…¥å£ç«™ â” æ±Ÿå—å€å»³ç«™ | åœ°éµç´„ 45åˆ† (3è™Ÿå‡ºå£æœ‰æ‰‹æ‰¶æ¢¯/2è™Ÿæœ‰é›»æ¢¯)'}, {text: 'ğŸª ç‡Ÿæ¥­æ™‚é–“ï¼š10:00~19:00'}, {text: 'â³ å»ºè­°åœç•™ï¼š1.5 å°æ™‚'}, {text: 'https://www.google.com/maps/search/?api=1&query=mmn+Seoul+Cafe', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/mmn%20ê°•ë‚¨êµ¬ì²­', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#f3f4f6', textColor: '#374151', titleColor: '#111827', badge: '13:30', title: 'è–æ°´æ´ (å’–å•¡å»³èˆ‡å•†åœˆé€›è¡—)', details: [{text: 'ğŸš‡ äº¤é€šï¼šæ±Ÿå—å€å»³ç«™ â” è–æ°´ç«™ | è½‰è»Šç´„ 20åˆ† (3è™Ÿ/4è™Ÿå‡ºå£æœ‰é›»æ¢¯èˆ‡æ‰‹æ‰¶æ¢¯)'}, {text: 'â³ å»ºè­°åœç•™ï¼š3 å°æ™‚ (é€›è¡—æ‹ç…§è¡Œç¨‹)'}, {text: 'https://www.google.com/maps/search/?api=1&query=Seongsu-dong+cafe+street', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ì„±ìˆ˜ë™%20ì¹´í˜ê±°ë¦¬', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#fce7f3', textColor: '#be185d', titleColor: '#9d174d', badge: '17:00', title: 'æ™šé¤ï¼šé¦¬å ´æ´éŸ“ç‰›æ‘', details: [{text: 'ğŸš‡ äº¤é€šï¼šè–æ°´ç«™ â” é¦¬å ´ç«™ | åœ°éµç´„ 20åˆ† (2è™Ÿå‡ºå£æœ‰é›»æ¢¯)'}, {text: 'ğŸª ç‡Ÿæ¥­æ™‚é–“ï¼š11:00~23:00'}, {text: 'â³ å»ºè­°åœç•™ï¼š2 å°æ™‚ (ä¸åƒç‰›ä¹Ÿæœ‰è±¬è‚‰å¯é¸)'}, {text: 'https://www.google.com/maps/search/?api=1&query=Majang+Meat+Market', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ë§ˆì¥ë™%20ì¶•ì‚°ë¬¼ì‹œì¥', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#f3f4f6', textColor: '#374151', titleColor: '#111827', badge: '19:30', title: 'å¼˜å¤§å•†åœˆé€›è¡— & å–è¡Œæ', details: [{text: 'ğŸš‡ äº¤é€šï¼šé¦¬å ´ç«™ â” å¼˜å¤§å…¥å£ç«™ | åœ°éµç´„ 35åˆ† (9è™Ÿå‡ºå£äººå¤šï¼Œ8è™Ÿæœ‰é›»æ¢¯)'}, {text: 'â³ å»ºè­°åœç•™ï¼š2.5 å°æ™‚ (è¨˜å¾— 22:00 å‰è¦å»æ‹¿è¡Œæå–”ï¼)'}, {text: 'https://www.google.com/maps/search/?api=1&query=Hongdae+Seoul', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/í™ëŒ€ì…êµ¬ì—­', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#fef9c3', textColor: '#a16207', titleColor: '#854d0e', badge: '22:30', title: 'å…¥ä½ æ¾å·ç«™ Airbnb', details: [{text: 'ğŸš‡ äº¤é€šï¼šæ­è‡³æ¾å·ç«™ (2è™Ÿå‡ºå£æœ‰é›»æ¢¯ï¼Œæ­¥è¡Œ5åˆ†é˜)'}, {text: 'ğŸ•’ ä½å®¿è³‡è¨Šï¼šå·²é” 16:00 å¯éš¨æ™‚è‡ªåŠ©å…¥ä½ / é€€æˆ¿ 11:00'}, {text: 'https://www.google.com/maps/search/?api=1&query=Solsam+Station', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ì†”ìƒ˜ì—­', isLink: true, linkName: 'Naverå°èˆª'}] }
                ]}
            ]},
            { id: 'p3', title: 'Day 3ï¼š5/24 (æ—¥) æ¨‚å¤©æ¨‚åœ’èˆ‡æ¢¨æ³°é™¢', icon: 'fa-ticket-alt', color: '#14532d', blocks: [
                { type: 'badge', items: [
                    { style: '#dcfce7', textColor: '#15803d', titleColor: '#14532d', badge: '10:00', title: 'æ¨‚å¤©éŠæ¨‚åœ’ (Lotte World)', details: [{text: 'ğŸš‡ äº¤é€šï¼šæ¾å·ç«™ â” è ¶å®¤ç«™ | åœ°éµç´„ 55åˆ† (3è™Ÿ/4è™Ÿå‡ºå£åœ°ä¸‹é€£é€šé“ç›´é”ï¼Œå…å‡ºç«™å¹é¢¨)'}, {text: 'ğŸª ç‡Ÿæ¥­æ™‚é–“ï¼š10:00~21:00'}, {text: 'â³ å»ºè­°åœç•™ï¼š4~5 å°æ™‚ (è¦–æ’éšŠç‹€æ³)'}, {text: 'https://www.google.com/maps/search/?api=1&query=Lotte+World+Seoul', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ë¡¯ë°ì›”ë“œ', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#f3f4f6', textColor: '#374151', titleColor: '#111827', badge: '15:30', title: 'é¦–çˆ¾ç«™ æ¨‚å¤©è¶…å¸‚ & æ¨‚å¤©Outlets', details: [{text: 'ğŸš‡ äº¤é€šï¼šè ¶å®¤ç«™ â” é¦–çˆ¾ç«™ | åœ°éµç´„ 45åˆ† (1è™Ÿå‡ºå£æ­ä¹˜æ‰‹æ‰¶æ¢¯ç›´é”è¶…å¸‚é–€å£)'}, {text: 'ğŸª è¶…å¸‚ç‡Ÿæ¥­æ™‚é–“ï¼š10:00~24:00'}, {text: 'â³ å»ºè­°åœç•™ï¼š2.5 å°æ™‚ (å¤§æ¡è³¼è¡Œç¨‹)'}, {text: 'https://www.google.com/maps/search/?api=1&query=Lotte+Mart+Seoul+Station', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ë¡¯ë°ë§ˆíŠ¸%20ì„œìš¸ì—­ì ', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#ffedd5', textColor: '#c2410c', titleColor: '#9a3412', badge: '19:00', title: 'æ™šé¤ï¼š17å“¥çƒ¤è‚‰åº— (æ¢¨æ³°é™¢)', details: [{text: 'ğŸš‡ äº¤é€šï¼šé¦–çˆ¾ç«™ â” æ¢¨æ³°é™¢ç«™ | åœ°éµç´„ 25åˆ† (1è™Ÿå‡ºå£æœ‰é›»æ¢¯)'}, {text: 'ğŸª ç‡Ÿæ¥­æ™‚é–“ï¼š16:00~23:00'}, {text: 'â³ å»ºè­°åœç•™ï¼š2 å°æ™‚'}, {text: 'https://www.google.com/maps/search/?api=1&query=Itaewon+BBQ', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ì´íƒœì›%20ê³ ê¸°ì§‘', isLink: true, linkName: 'Naverå°èˆª'}] }
                ]}
            ]},
            { id: 'p4', title: 'Day 4ï¼š5/25 (ä¸€) å¸‚å ´ç¾é£Ÿèˆ‡è³¼ç‰©', icon: 'fa-utensils', color: '#9d174d', blocks: [
                { type: 'badge', items: [
                    { style: '#fce7f3', textColor: '#be185d', titleColor: '#9d174d', badge: '11:00', title: 'æ—©åˆé¤ï¼šç´«è˜‡æ²¹æ‹Œéºµ (é˜¿å³´ç«™)', details: [{text: 'ğŸš‡ äº¤é€šï¼šæ¾å·ç«™ â” é˜¿å³´ç«™(Ahyeon) | åœ°éµç´„ 40åˆ† (1è™Ÿå‡ºå£æ—æœ‰æ‰‹æ‰¶æ¢¯/é›»æ¢¯)'}, {text: 'ğŸª ç‡Ÿæ¥­æ™‚é–“ï¼š11:30~21:00 (å¹³æ—¥ä¸‹åˆ 15:00-17:00 ä¼‘æ¯)'}, {text: 'â³ å»ºè­°åœç•™ï¼š1 å°æ™‚'}, {text: 'https://www.google.com/maps/search/?api=1&query=Ahyeon+Station+Noodles', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ì•„í˜„ì—­%20ë§‰êµ­ìˆ˜', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#fef9c3', textColor: '#a16207', titleColor: '#854d0e', badge: '13:00', title: 'äº¬æ±å¸‚å ´ (Gyeongdong Market)', details: [{text: 'ğŸš‡ äº¤é€šï¼šé˜¿å³´ç«™ â” ç¥­åŸºæ´ç«™ | åœ°éµç´„ 25åˆ† (2è™Ÿå‡ºå£æœ‰é›»æ¢¯/æ‰‹æ‰¶æ¢¯)'}, {text: 'ğŸª ç‡Ÿæ¥­æ™‚é–“ï¼š08:30~18:00'}, {text: 'â³ å»ºè­°åœç•™ï¼š2 å°æ™‚ (å¯åƒå®‰æ±æ¹¯éºµ / é€›æ˜Ÿå·´å…‹äº¬æ±1960)'}, {text: 'https://www.google.com/maps/search/?api=1&query=Gyeongdong+Market', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ê²½ë™ì‹œì¥', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#ffedd5', textColor: '#c2410c', titleColor: '#9a3412', badge: '18:00', title: 'æ™šé¤ï¼šåˆ©ç‰¹æ¨è–¦é¤å»³ (ë³´ë°°ë°˜ì )', details: [{text: 'ğŸš‡ äº¤é€šï¼šå¾å¸‚å ´æ­¥è¡Œæˆ–æ­å…¬è»Šå‰å¾€'}, {text: 'ğŸª ç‡Ÿæ¥­æ™‚é–“ï¼š11:30~22:00'}, {text: 'â³ å»ºè­°åœç•™ï¼š1.5 å°æ™‚'}, {text: 'https://www.google.com/maps/search/?api=1&query=Bobae+Banjum', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ë³´ë°°ë°˜ì ', isLink: true, linkName: 'Naverå°èˆª'}] }
                ]}
            ]},
            { id: 'p5', title: 'Day 5ï¼š5/26 (äºŒ) å•Ÿç¨‹å‰å¾€é‡œå±±', icon: 'fa-train', color: '#8E7358', blocks: [
                { type: 'alert', style: '#fce7f3', textColor: '#9d174d', icon: 'ğŸš¨', text: 'ã€è·¨åŸå¸‚ç§»å‹•æ³¨æ„ã€‘\nä»Šæ—¥éœ€å¸¶è‘—æ‰€æœ‰è¡Œææ­ä¹˜ KTX å‰å¾€é‡œå±±ï¼Œè«‹é ç•™ 30 åˆ†é˜æ–¼é¦–çˆ¾è»Šç«™æ‰¾æœˆå°ï¼Œé¿å…éŒ¯éç­æ¬¡ã€‚' },
                { type: 'badge', items: [
                    { style: '#f3f4f6', textColor: '#374151', titleColor: '#111827', badge: '10:00', title: 'æ­ä¹˜ KTX (é¦–çˆ¾ â” é‡œå±±)', details: [{text: 'ğŸš‡ äº¤é€šï¼šé¦–çˆ¾è»Šç«™æ­ä¹˜ | è»Šç¨‹ç´„ 2.5 å°æ™‚ (ç«™å…§æœ‰å¤šéƒ¨å¤§å‹é›»æ¢¯)'}, {text: 'https://www.google.com/maps/search/?api=1&query=Seoul+Station', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ì„œìš¸ì—­', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#e0f2fe', textColor: '#0284c7', titleColor: '#0369a1', badge: '14:00', title: 'é‡œå±±æµ·é›²å° Airbnb æ”¾è¡Œæ', details: [{text: 'ğŸš‡ äº¤é€šï¼šé‡œå±±ç«™ â” æµ·é›²å°ç«™ | åœ°éµç´„ 50åˆ† (3è™Ÿ/5è™Ÿå‡ºå£æœ‰é›»æ¢¯èˆ‡æ‰‹æ‰¶æ¢¯)'}, {text: 'ğŸ•’ ä½å®¿è³‡è¨Šï¼šå…¥ä½ 16:00 / é€€æˆ¿ 12:00 (å¯å…ˆå¯„å­˜è¡Œæ)'}, {text: 'https://www.google.com/maps/search/?api=1&query=Haeundae+Station', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/í•´ìš´ëŒ€ì—­', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#d0e8f2', textColor: '#0369a1', titleColor: '#0369a1', badge: '16:00', title: 'é‡œå±± X the Sky è§€æ™¯å°', details: [{text: 'ğŸ‘Ÿ äº¤é€šï¼šå¾æµ·é›²å°æ­¥è¡Œç´„ 15åˆ†'}, {text: 'ğŸª ç‡Ÿæ¥­æ™‚é–“ï¼š10:00~21:00'}, {text: 'â³ å»ºè­°åœç•™ï¼š1.5 å°æ™‚ (100æ¨“çµ•ç¾æµ·æ™¯)'}, {text: 'https://www.google.com/maps/search/?api=1&query=Busan+X+the+Sky', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ë¶€ì‚°ì—‘ìŠ¤ë”ìŠ¤ì¹´ì´', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#ffedd5', textColor: '#c2410c', titleColor: '#9a3412', badge: '18:30', title: 'æ™šé¤ï¼šæµ·é›²å°å‚³çµ±å¸‚å ´', details: [{text: 'ğŸ‘Ÿ äº¤é€šï¼šæ­¥è¡Œ 1 åˆ†é˜å³å¯æŠµé”'}, {text: 'ğŸª ç‡Ÿæ¥­æ™‚é–“ï¼š09:00~22:00'}, {text: 'â³ å»ºè­°åœç•™ï¼š2 å°æ™‚ (ç›²é°»ã€ç³–é¤…ã€å„ç¨®å°åƒ)'}, {text: 'https://www.google.com/maps/search/?api=1&query=Haeundae+Traditional+Market', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/í•´ìš´ëŒ€%20ì „í†µì‹œì¥', isLink: true, linkName: 'Naverå°èˆª'}] }
                ]}
            ]},
            { id: 'p6', title: 'Day 6ï¼š5/27 (ä¸‰) é‡œå±±æµ·é™¸ç©ºåˆ†æµä¹‹æ—…', icon: 'fa-ship', color: '#0369a1', blocks: [
                { type: 'badge', items: [
                    { style: '#dcfce7', textColor: '#15803d', titleColor: '#14532d', badge: '10:00', title: 'æµ·é›²å°è† å›Šåˆ—è»Š (Blue Line Park)', details: [{text: 'ğŸ‘Ÿ äº¤é€šï¼šå°¾æµ¦ç«™æ­ä¹˜ (éœ€å…ˆä¸Šç¶²é ç´„)'}, {text: 'ğŸª ç‡Ÿæ¥­æ™‚é–“ï¼š09:30~19:00'}, {text: 'â³ å»ºè­°åœç•™ï¼šæ­ä¹˜å–®ç¨‹ç´„ 30åˆ† + æ‹ç…§'}, {text: 'https://www.google.com/maps/search/?api=1&query=Haeundae+Blue+Line+Park+Mipo+Station', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/í•´ìš´ëŒ€%20ë¸”ë£¨ë¼ì¸íŒŒí¬%20ë¯¸í¬ì •ê±°ì¥', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#fef9c3', textColor: '#a16207', titleColor: '#854d0e', badge: '12:30', title: 'Skyline Luge é‡œå±±æ–œå¡æ»‘è»Š', details: [{text: 'ğŸš‡ äº¤é€šï¼šå¾é’æ²™æµ¦æˆ–æ­å…¬è»Š/è¨ˆç¨‹è»Šå‰å¾€å¥§è¥¿åˆ©äº(Osiria)ç«™ (1è™Ÿå‡ºå£)'}, {text: 'ğŸª ç‡Ÿæ¥­æ™‚é–“ï¼š10:00~19:00'}, {text: 'â³ å»ºè­°åœç•™ï¼š4 å°æ™‚ (Luge + æ¨‚å¤©è¶…å¸‚/Outlets)'}, {text: 'https://www.google.com/maps/search/?api=1&query=Skyline+Luge+Busan', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ìŠ¤ì¹´ì´ë¼ì¸ë£¨ì§€%20ë¶€ì‚°', isLink: true, linkName: 'Naverå°èˆª'}] }
                ]},
                { type: 'alert', style: '#e0f2fe', textColor: '#0369a1', icon: 'ğŸ”€', text: 'ã€ä¸‹åˆåˆ†æµå½ˆæ€§è¡Œç¨‹ã€‘\né€›å®Œ Outlets å¾Œï¼Œå¤§å®¶å¯ä¾è‡ªèº«å–œå¥½å…µåˆ†å…©è·¯ï¼Œæ™šä¸Šå†é›†åˆæ­éŠè‰‡ï¼' },
                { type: 'badge', items: [
                    { style: '#f3e8ff', textColor: '#6b21a8', titleColor: '#581c87', badge: 'Açµ„', title: 'Spa Land æ±—è’¸å¹• (Centum City)', details: [{text: 'ğŸš‡ äº¤é€šï¼šæ­è»Šè‡³ Centum City ç«™ (12è™Ÿå‡ºå£åœ°ä¸‹é€£é€šæ‰‹æ‰¶æ¢¯)'}, {text: 'ğŸª ç‡Ÿæ¥­æ™‚é–“ï¼š09:00~22:00'}, {text: 'â³ å»ºè­°åœç•™ï¼š2.5 å°æ™‚ (é«”é©—ç¾Šè§’é ­é›è›‹èˆ‡ç†±ç™‚)'}, {text: 'https://www.google.com/maps/search/?api=1&query=Spa+Land+Centum+City', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ìŠ¤íŒŒëœë“œ%20ì„¼í…€ì‹œí‹°', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#ffedd5', textColor: '#c2410c', titleColor: '#9a3412', badge: 'Bçµ„', title: 'å»£å®‰é‡Œæµ·æ™¯å’–å•¡å»³æ”¾ç©º', details: [{text: 'ğŸš‡ äº¤é€šï¼šæ­è»Šè‡³ å»£å®‰ç«™ æˆ– é‡‘è“®å±±ç«™ (çš†æœ‰é›»æ¢¯/æ‰‹æ‰¶æ¢¯)'}, {text: 'â³ å»ºè­°åœç•™ï¼š2.5 å°æ™‚ (æ‰¾é–“é †çœ¼çš„å’–å•¡å»³çœ‹æ©‹)'}, {text: 'https://www.google.com/maps/search/?api=1&query=Gwangalli+Beach+Cafe', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ê´‘ì•ˆë¦¬', isLink: true, linkName: 'Naverå°èˆª'}] },
                ]},
                { type: 'badge', items: [
                    { style: '#111827', textColor: '#ffffff', titleColor: '#111827', badge: 'é›†åˆ', title: 'é‘½çŸ³ç£éŠè‰‡å¤œéŠ (Diamond Bay)', details: [{text: 'ğŸš• äº¤é€šï¼šAã€Bçµ„å„è‡ªæ­è»Šå‰å¾€éŠè‰‡ç¢¼é ­æœƒåˆ'}, {text: 'ğŸª èˆªç­æ™‚é–“ï¼šé€šå¸¸ç‚º 19:30 æˆ– 20:30'}, {text: 'â³ å»ºè­°åœç•™ï¼šèˆ¹ç¨‹ç´„ 50åˆ†'}, {text: 'https://www.google.com/maps/search/?api=1&query=Diamond+Bay+Busan', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ë‹¤ì´ì•„ëª¬ë“œë² ì´', isLink: true, linkName: 'Naverå°èˆª'}] }
                ]}
            ]},
            { id: 'p7', title: 'Day 7ï¼š5/28 (å››) æ¾å³¶ç¾æ™¯èˆ‡å¹³å®‰è³¦æ­¸', icon: 'fa-plane-departure', color: '#4b5563', blocks: [
                { type: 'badge', items: [
                    { style: '#e0f2fe', textColor: '#0284c7', titleColor: '#0369a1', badge: '10:30', title: 'æ¾å³¶æµ·ä¸Šçºœè»Š (Songdo Cable Car)', details: [{text: 'ğŸš‡ äº¤é€šï¼šæµ·é›²å° â” å—æµ¦ç«™ (8è™Ÿå‡ºå£æœ‰é›»æ¢¯) è½‰å…¬è»Š/è¨ˆç¨‹è»Š'}, {text: 'ğŸª ç‡Ÿæ¥­æ™‚é–“ï¼š09:00~20:00'}, {text: 'â³ å»ºè­°åœç•™ï¼š1.5 å°æ™‚ (æ°´æ™¶è»Šå»‚çœ‹æµ·)'}, {text: 'https://www.google.com/maps/search/?api=1&query=Songdo+Marine+Cable+Car', isLink: true, linkName: 'Googleå°èˆª'}, {text: 'https://map.naver.com/v5/search/ì†¡ë„í•´ìƒì¼€ì´ë¸”ì¹´', isLink: true, linkName: 'Naverå°èˆª'}] },
                    { style: '#fef9c3', textColor: '#a16207', titleColor: '#854d0e', badge: '13:00', title: 'æ¾å³¶é›·å°„æ§ç«¶æŠ€å ´', details: [{text: 'ğŸ‘Ÿ äº¤é€šï¼šä½æ–¼çºœè»Šç«™å‘¨é‚Šæˆ–å²©å—å…¬åœ’å…§'}, {text: 'â³ å»ºè­°åœç•™ï¼š1.5 å°æ™‚'}] },
                    { style: '#f3f4f6', textColor: '#374151', titleColor: '#111827', badge: '17:30', title: 'å‰å¾€ é‡‘æµ·åœ‹éš›æ©Ÿå ´ (PUS)', details: [{text: 'ğŸš‡ äº¤é€šï¼šæ­ä¹˜åœ°éµ/è¼•è»Œæˆ–åŒ…è»Šå‰å¾€é‡‘æµ·æ©Ÿå ´ (æ²™ä¸Šç«™è½‰ä¹˜è¼•è»Œæœ‰å¤§å‹é›»æ¢¯)'}] }
                ]},
                { type: 'alert', style: '#fce7f3', textColor: '#9d174d', icon: 'âœˆï¸', text: 'å›ç¨‹ç­æ©Ÿè³‡è¨Šï¼š\n21:05 é‡œå±±èµ·é£› â” 22:50 æŠµé”å°ç£æ¡ƒåœ’\nè«‹å‹™å¿…æ–¼ 18:30 å‰æŠµé”æ©Ÿå ´è¾¦ç†é€€ç¨…èˆ‡å ±åˆ°æ‰‹çºŒï¼' }
            ]}
        ];

        const defaultFlightCards = [
            { id: 'f1', title: 'èˆªç­è³‡è¨Š', icon: 'fa-plane', color: '#0369a1', blocks: [
                { type: 'badge', items: [
                    { style: '#e0f2fe', textColor: '#0284c7', titleColor: '#0369a1', badge: 'å»ç¨‹', title: 'æ¡ƒåœ’ï¼ä»å· (ğŸ‡¹ğŸ‡¼ å°ç£æ¡ƒåœ’ â” ğŸ‡°ğŸ‡· éŸ“åœ‹ä»å·)', details: [{text: 'è©³ç´°ç­æ©Ÿæ™‚é–“ï¼š20:00 èµ·é£› - 23:30 æŠµé”'}] },
                    { style: '#dcfce7', textColor: '#15803d', titleColor: '#14532d', badge: 'å›ç¨‹', title: 'é‡œå±±ï¼æ¡ƒåœ’ (ğŸ‡°ğŸ‡· éŸ“åœ‹é‡œå±± â” ğŸ‡¹ğŸ‡¼ å°ç£æ¡ƒåœ’)', details: [{text: 'è©³ç´°ç­æ©Ÿæ™‚é–“ï¼š21:05 èµ·é£› - 22:50 æŠµé”'}] }
                ]}
            ]},
			{ id: 'f2', title: 'è¨—é‹èˆ‡æ‰‹æè¡Œæè¦å®š', icon: 'fa-suitcase-rolling', color: '#4b5563', blocks: [
                { type: 'alert', style: '#e0f2fe', textColor: '#0369a1', icon: 'ğŸ§³', text: 'ã€æ‰‹æè¡Œæã€‘\nâ€¢ 1ä»¶æ‰‹æè¡Œæ(ç™»æ©Ÿç®±) + 1ä»¶éš¨èº«ç‰©å“(å°åŒ…/æè¢‹)\nâ€¢ åˆè¨ˆä¸å¯è¶…é 10 å…¬æ–¤\nâ€¢ å°ºå¯¸é™åˆ¶ï¼š54cm x 38cm x 23cm (åŒ…å«è¼ªå­)' },
                { type: 'alert', style: '#ffedd5', textColor: '#9a3412', icon: 'ğŸ“¦', text: 'ã€è¨—é‹è¡Œæã€‘\nâ€¢ ä¸é™ä»¶æ•¸ï¼Œç¸½é‡é‡ä¸å¯è¶…éé¡åº¦\nâ€¢ å–®ä»¶è¡Œæä¸å¯è¶…é 30 å…¬æ–¤\nâ€¢ å°ºå¯¸é™åˆ¶ï¼šé•·+å¯¬+é«˜ â‰¦ 203 å…¬åˆ†\nâ€¢ é¡åº¦å…±ç”¨ï¼šåŒä¸€è¨‚ä½ä»£è™Ÿä¸”åŒæ™‚è¾¦ç†å ±åˆ°ï¼Œå¯åˆä½µè¨ˆç®—' },
                { type: 'alert', style: '#f3e8ff', textColor: '#6b21a8', icon: 'âš ï¸', text: 'ã€é‡è¦æé†’èˆ‡é•ç¦å“ã€‘\nâ€¢ è¡Œå‹•é›»æº / é‹°é›»æ± ï¼šå¿…é ˆéš¨èº«æ‰‹æï¼Œä¸å¯è¨—é‹\nâ€¢ æ‰“ç«æ©Ÿï¼šå¿…é ˆéš¨èº«æ‰‹æï¼Œä¸å¯è¨—é‹ (é™1é¡†)\nâ€¢ æš–æš–åŒ…ï¼šâš ï¸ ç¦æ­¢è¨—é‹ï¼è«‹éš¨èº«æ”œå¸¶æˆ–æ”¾æ‰‹æè¡Œæ\nâ€¢ æ¶²é«”ã€è† ç‹€ç‰©å“ï¼šå–®ç“¶â‰¦100ml éœ€è£å…¥é€æ˜è¢‹æ‰å¯æ‰‹æï¼Œè¶…éå‰‡è¨—é‹' },
                { type: 'alert', style: '#fce7f3', textColor: '#9d174d', icon: 'ğŸš«', text: 'ã€æ—…éŠç¦å¿Œèˆ‡å‡ºå…¥å¢ƒé•ç¦å“ã€‘\nâ€¢ éŸ“åœ‹å…¥å¢ƒç¦å¸¶ï¼šè‚‰é¡åŠåŠ å·¥å“(å«æ³¡éºµè‚‰å¡Š)ã€ç”Ÿé®®è”¬æœã€‚\nâ€¢ éŸ“åœ‹ç‰¹åˆ¥ç¦å¸¶ï¼šâš ï¸ EVE é ­ç—›è—¥ (éŸ“åœ‹æµ·é—œç¦æ­¢æ”œå¸¶å…¥å¢ƒï¼)\nâ€¢ å°ç£å…¥å¢ƒç¦å¸¶ï¼šè±¬è‚‰åŠæ‰€æœ‰å«è‚‰è£½å“ã€å‹•æ¤ç‰©ç”¢å“ã€‚' }
            ]},            { id: 'f3', title: 'å¯è¨—é‹é‡é‡ç¸½è¡¨', icon: 'fa-balance-scale', color: '#8E7358', blocks: [
                { type: 'grid', cols: 2, rows: [
                    ['å®¶èŒµ', 'å»ç¨‹ 20kg / å›ç¨‹ 20kg'], ['å…ƒçš‡', 'å»ç¨‹ ç„¡ / å›ç¨‹ 20kg'],
                    ['è»’ç‘„', 'å»ç¨‹ 20kg / å›ç¨‹ 25kg'], ['é‡‘å³°', 'å»ç¨‹ ç„¡ / å›ç¨‹ 25kg'],
                    ['ç‘‹ç³', 'å»ç¨‹ 20kg / å›ç¨‹ 30kg'], ['å† ä¼¶', 'å»ç¨‹ 20kg / å›ç¨‹ 35kg']
                ] }
            ]},
            { id: 'f4', title: 'å¯åˆä½µè¨ˆç®—è¨—é‹åå–®', icon: 'fa-users', color: '#14532d', blocks: [
                { type: 'alert', style: '#fef9c3', textColor: '#a16207', icon: 'ğŸ¤', text: 'ã€å»ç¨‹å¯ä»¥åˆä½µè¨ˆç®—ã€‘\nâ€¢ è»’ç‘„ & ç‘‹ç³ & å† ä¼¶\n\nã€å›ç¨‹å¯ä»¥åˆä½µè¨ˆç®—ã€‘\nâ€¢ å®¶èŒµ & å…ƒçš‡\nâ€¢ è»’ç‘„ & ç‘‹ç³' }
            ]}
        ];

        const defaultInfoCards = [
            { id: 'c_stay', title: 'ä½å®¿è³‡è¨Š', icon: 'fa-home', color: '#374151', blocks: [
                { type: 'badge', items: [
                    { style: '#e0f2fe', textColor: '#0284c7', titleColor: '#0369a1', badge: '5/22 (äº”)', title: 'äº¨å¾·é£¯åº— (Hound Hotel Incheon Airport)', details: [
                        {text: 'ğŸ•’ å…¥ä½æ™‚é–“ï¼š15:00 | é€€æˆ¿æ™‚é–“ï¼š12:00'},
                        {text: 'ğŸ¥ å…è²»æ—©é¤æ™‚é–“ï¼š06:00 ~ 10:00'},
                        {text: 'ğŸ›ï¸ è¨­æ–½ï¼šé›»æ¢¯ / å¹é¢¨æ©Ÿ'},
                        {text: 'ğŸš‡ åœ°éµï¼šé›²è¥¿ç«™(Unseo) 1è™Ÿå‡ºå£æ­¥è¡Œ5åˆ†é˜ (è¨­æœ‰é›»æ¢¯/æ‰‹æ‰¶æ¢¯)'},
                        {text: 'https://www.google.com/maps/search/?api=1&query=Hound+Hotel+Incheon+Airport', isLink: true, linkName: 'Googleå°èˆª'},
                        {text: 'https://map.naver.com/v5/search/Hound%20Hotel%20Incheon%20Airport', isLink: true, linkName: 'Naverå°èˆª'},
                        {text: 'https://www.agoda.com/zh-tw/incheon-airport-hotel-queen_7/hotel/incheon-kr.html', isLink: true, linkName: 'Agodaè¨‚æˆ¿ç¶²å€'}
                    ]},
                    { style: '#ffedd5', textColor: '#c2410c', titleColor: '#9a3412', badge: '5/23 (å…­)', title: 'é¦–çˆ¾ä½å®¿ (æ¾å·ç«™)', details: [
                        {text: 'ğŸ•’ å…¥ä½æ™‚é–“ï¼š16:00 | é€€æˆ¿æ™‚é–“ï¼š11:00'},
                        {text: 'ğŸ›ï¸ è¨­æ–½ï¼šé›»æ¢¯ / æ´—è¡£æ©Ÿ / çƒ˜è¡£æ©Ÿ / å¹é¢¨æ©Ÿ'},
                        {text: 'ğŸš‡ åœ°éµï¼šæ¾å·ç«™(Solsam)2è™Ÿå‡ºå£æ­¥è¡Œ5åˆ†é˜ (2è™Ÿå‡ºå£æœ‰é›»æ¢¯)'},
                        {text: 'ğŸ“Œ å‚™è¨»ï¼šå¯å¯„æ”¾è¡Œæ / è‡ªåŠ©å…¥ä½ | éœ€å®‰éœæ™‚æ®µï¼š22:00 ~ 07:00'},
                        {text: 'https://www.google.com/maps/search/?api=1&query=Solsam+Station', isLink: true, linkName: 'Googleå°èˆª'},
                        {text: 'https://map.naver.com/v5/search/ì†”ìƒ˜ì—­', isLink: true, linkName: 'Naverå°èˆª'},
                        {text: 'https://www.airbnb.com.tw/rooms/1220064098724409526', isLink: true, linkName: 'Airbnbè¨‚æˆ¿ç¶²å€'}
                    ]},
                    { style: '#dcfce7', textColor: '#15803d', titleColor: '#14532d', badge: '5/27 (ä¸‰)', title: 'é‡œå±±ä½å®¿ (æµ·é›²å°ç«™)', details: [
                        {text: 'ğŸ•’ å…¥ä½æ™‚é–“ï¼š16:00 | é€€æˆ¿æ™‚é–“ï¼š12:00'},
                        {text: 'ğŸ›ï¸ è¨­æ–½ï¼šé›»æ¢¯ / æ´—è¡£æ©Ÿ / å¹é¢¨æ©Ÿ'},
                        {text: 'ğŸš‡ åœ°éµï¼šæµ·é›²å°ç«™3è™Ÿå‡ºå£ (3è™Ÿ/5è™Ÿçš†æœ‰æ‰‹æ‰¶æ¢¯èˆ‡é›»æ¢¯)'},
                        {text: 'ğŸ“Œ å‚™è¨»ï¼šå¯å¯„æ”¾è¡Œæ / è‡ªåŠ©å…¥ä½'},
                        {text: 'https://www.google.com/maps/search/?api=1&query=Haeundae+Station', isLink: true, linkName: 'Googleå°èˆª'},
                        {text: 'https://map.naver.com/v5/search/í•´ìš´ëŒ€ì—­', isLink: true, linkName: 'Naverå°èˆª'},
                        {text: 'https://www.airbnb.com.tw/rooms/1364104568778915783', isLink: true, linkName: 'Airbnbè¨‚æˆ¿ç¶²å€'},
                        {text: 'https://theplace34-eng.my.canva.site/engver', isLink: true, linkName: 'æˆ¿å±‹æ‰‹å†Š'}
                    ]}
                ]}
            ]},
            
			{ id: 'c_entry2026', title: '2026éŸ“åœ‹é›»å­å…¥å¢ƒå¡(e-Arrival Card)', icon: 'fa-passport', color: '#0369a1', blocks: [
                { type: 'alert', style: '#fef9c3', textColor: '#a16207', icon: 'ğŸš¨', text: 'å¡«å¯«æ™‚é–“ï¼šæŠµé”éŸ“åœ‹å‰72 å°æ™‚å…§ï¼Œå‹™å¿…å®Œæˆã€‚\nè²»ç”¨ï¼šå®Œå…¨å…è²»ï¼ï¼ˆè¦åˆ·å¡çš„æ˜¯è©é¨™ï¼‰ã€‚\næ³¨æ„äº‹é …ï¼š å¼·åˆ¶ç·šä¸Šå¡«å¯«ï¼Œé£›æ©Ÿä¸Šä¸ç™¼æ”¾ç´™æœ¬å…¥å¢ƒå¡ï¼Œä¸€å®šå…ˆå¡«å¥½ï¼' },
                { type: 'badge', items: [
                { style: '#e0f2fe', textColor: '#0284c7', titleColor: '#0369a1', badge: 'æ­¥é©Ÿä¸€', title: 'å¡«å¯«å®˜ç¶²èˆ‡è³‡æ–™', details: [
                {text: 'è­·ç…§è³‡æ–™é çš„ç…§ç‰‡æª”ã€‚'},
                {text: 'èˆªç­è™Ÿç¢¼:IT602ã€‚'},
				{text: 'ç¬¬ä¸€å¤©é£¯åº—åç¨±ï¼š Hound Hotel Incheon Airport'},
				{text: 'è‹±æ–‡åœ°å€ï¼š 10 Sindosinam-ro 150beon-gil, Jung-gu, Incheon'},
				{text: 'éŸ“æ–‡åœ°å€ï¼š ì¸ì²œ ì¤‘êµ¬ ì‹ ë„ì‹œë‚¨ë¡œ150ë²ˆê¸¸ 10'},
                {text: 'https://www.e-arrivalcard.go.kr/', isLink: true, linkName: 'å®˜ç¶²'}
            ]},
            { style: '#dcfce7', textColor: '#15803d', titleColor: '#14532d', badge: 'æ­¥é©ŸäºŒ', title: 'å¡«å¯«æ­¥é©Ÿ', details: [
                {text: 'æ­¥é©Ÿï¼š ç¶²å€ â” å³ä¸Šè§’é¸ã€Œä¸­æ–‡(ç¹)ã€ â” é»ã€Œå€‹äººç”³å ±ã€ â” ä¸Šå‚³è­·ç…§ç…§ç‰‡ â” å¡«å¯«èˆªç­èˆ‡é£¯åº—è³‡è¨Š â” æäº¤ã€‚'}
            ]},
        ]}
    ]},
            { id: 'c_emg', title: 'éŸ“åœ‹ç·Šæ€¥è¯çµ¡è³‡è¨Š', icon: 'fa-ambulance', color: '#9d174d', blocks: [
                { type: 'alert', style: '#fef9c3', textColor: '#a16207', icon: 'ğŸ’¡', text: 'ã€ç„¡éŸ“åœ‹é–€è™Ÿæ’¥æ‰“æ–¹å¼ã€‘\n1. æ’¥æ‰“ç•¶åœ°ï¼šåŠ åœ‹ç¢¼ +82 ä¸¦å»æ‰å€ç¢¼çš„ 0\n   (ä¾‹ï¼š02-399-2767 âœ +82-2-399-2767)\n2. è¯çµ¡å°ç£ï¼šå»ºè­°ä½¿ç”¨ Line/Skype ç­‰ç¶²è·¯é›»è©±\n3. æ’¥æ‰“å°ç£ï¼šåŠ åœ‹ç¢¼ +886 ä¸¦å»æ‰ 0\n   (ä¾‹ï¼š0912-xxx âœ +886-912-xxx)' },
                { type: 'grid', cols: 2, rows: [ ['è­¦å¯Ÿ', '112'], ['ç«è­¦/æ•‘è­·è»Š', '119'], ['æ—…éŠè«®è©¢(ä¸­/è‹±)', '1330'] ] },
                { type: 'alert', style: '#e0f2fe', textColor: '#0369a1', icon: 'ğŸ“', text: 'é§éŸ“åœ‹å°åŒ—ä»£è¡¨è™• (é¦–çˆ¾)ï¼š\né›»è©±ï¼š(02) 399-2767~68\nç·Šæ€¥è¯çµ¡é›»è©±ï¼š010-9080-2761' },
                { type: 'alert', style: '#e0f2fe', textColor: '#0369a1', icon: 'ğŸ“', text: 'é§éŸ“åœ‹å°åŒ—ä»£è¡¨è™• é‡œå±±è¾¦äº‹è™•ï¼š\né›»è©±ï¼š(051) 463-7965\nç·Šæ€¥è¯çµ¡é›»è©±ï¼š010-4537-7961' }
            ]}
        ];
        
        let defaultWeatherLocs = [
            { id:'seoul', name:'é¦–çˆ¾', lat:37.5665, lon:126.9780, color:'#e0f2fe' },
            { id:'busan', name:'é‡œå±±', lat:35.1796, lon:129.0756, color:'#dcfce7' },
            { id:'bade', name:'å…«å¾·', lat:24.9298, lon:121.2939, color:'#f3f4f6' },
            { id:'linkou', name:'æ—å£', lat:25.0777, lon:121.3725, color:'#fbfbf9' },
            { id:'yunlin', name:'é›²æ—', lat:23.7093, lon:120.4313, color:'#f4ebd9' }
        ];

        const defaultMemo = `ğŸŒŸ éŸ“åœ‹æ—…éŠå¯¦ç”¨å‚™å¿˜éŒ„\n\n1. ğŸ‡°ğŸ‡· éŸ“åœ‹å…¥å¢ƒè³‡æ–™ (å‡ºç™¼å‰å¿…å¡«ï¼)\nâ€¢ K-ETA (é›»å­æ—…è¡Œè¨±å¯)ï¼šå‡ºç™¼å‰ 72 å°æ™‚ä¸Šç¶²å¡«å¯«ä¸¦ç¹³è²» (æŒå°ç£è­·ç…§ä¾ç•¶æ™‚æ”¿ç­–å¯èƒ½å…é™¤ï¼Œè«‹ç¢ºèªæœ€æ–°å…¬å‘Š)ã€‚\n  ç¶²å€: https://www.k-eta.go.kr/\nâ€¢ Q-Code (æª¢ç–«è³‡è¨Š)ï¼šå‡ºç™¼å‰ 3 å¤©å…§å¡«å¯«ï¼Œå…¥å¢ƒæ™‚å‡ºç¤º QR Code æƒæé€šé—œæœ€å¿«ã€‚\n  ç¶²å€: https://qcode.kdca.go.kr/\nâ€¢ æµ·é—œç”³å ±ï¼šç¾åœ¨å¤§å¤šå¯èµ°ã€Œç„¡ç”³å ±é€šé“ã€å…å¡«ç´™æœ¬ï¼Œæˆ–ç”¨ã€Œæ—…å®¢æµ·é—œç”³å ±ã€APPã€‚\n\n2. ğŸ“± å¿…å‚™ APP æ¨è–¦\nâ€¢ Naver Map / Kakao Map (éŸ“åœ‹ä¸æ”¯æ´Googleå°èˆª)\nâ€¢ Papago (éŸ“åœ‹æœ€å¼·ç¿»è­¯APPï¼Œæ”¯æ´åœ–ç‰‡ç¿»è­¯)\nâ€¢ T-money Pay / WOWPASS (è¡Œå‹•æ”¯ä»˜)\n\n3. ğŸ’° é€€ç¨…æ³¨æ„äº‹é …\nâ€¢ å–®ç­†æ»¿ 15,000 éŸ“å…ƒå³å¯é€€ç¨…ï¼\nâ€¢ è¨˜å¾—éš¨èº«æ”œå¸¶è­·ç…§ï¼Œçµå¸³æ™‚ç›´æ¥èªªã€ŒTax Freeã€ã€‚\n\n4. ğŸ”Œ è¡Œæèˆ‡é›»å£“\nâ€¢ éŸ“åœ‹é›»å£“ç‚º 220Vï¼Œæ’åº§æ˜¯ã€Œé›™åœ“å­”ã€(è±¬é¼»æ’é ­)ã€‚\nâ€¢ è¨˜å¾—å¸¶è½‰æ¥é ­ï¼\n\n5. â˜ï¸ ç·Šæ€¥è¯çµ¡é›»è©±\nâ€¢ é§éŸ“ä»£è¡¨è™•ç·Šæ€¥è¯çµ¡ï¼š010-9080-2761\nâ€¢ æ—…éŠè«®è©¢ç†±ç·šï¼š1330 (æœ‰ä¸­æ–‡æœå‹™)`;

        const defaultChecklist = [
            {text:'é›»å­å…¥å¢ƒå¡(e-Arrival Card)',checked:false}, {text:'è­·ç…§(è‡³å°‘6å€‹æœˆæ•ˆæœŸ)',checked:false},
            {text:'ç¶²å¡(e-SIM)',checked:false}, {text:'è¡Œå‹•é›»æº',checked:false},
            {text:'å……é›»å™¨æ',checked:false}, {text:'è½‰æ¥é ­ (é›™åœ“å­” 220V)',checked:false},
            {text:'äº¤é€šå¡(ç„¡é™å¡/T-moneyå¡)',checked:false}, {text:'å¸¸å‚™è—¥å“(æ„Ÿå†’è—¥/è…¸èƒƒè—¥)',checked:false},
            {text:'ä¿å¥é£Ÿå“',checked:false}, {text:'ä¸‹è¼‰Naver Map',checked:false},
			{text:'ä¸‹è¼‰Papagoç¿»è­¯',checked:false}, 
        ];
        
        const defaultTitles = { plan: 'æ¯æ—¥è¡Œç¨‹å®‰æ’', flight: 'èˆªç­è³‡è¨Šèˆ‡è¦å®š', info: 'é‡è¦è³‡è¨Šèˆ‡ä½å®¿', wallet: 'æ›åŒ¯èˆ‡è¨˜å¸³', lists: 'è¡Œç¨‹å‚™å¿˜éŒ„' };

        // --- é›¢ç·šå„ªå…ˆ (Offline-First) åˆå§‹ç¶å®š ---
        // ç‚ºäº†é”åˆ°ç§’é–‹é€Ÿåº¦ï¼Œç›´æ¥å¾ localStorage è¼‰å…¥ï¼Œå¾ŒçºŒé›²ç«¯å†è¦†è“‹
        planCardsData = JSON.parse(localStorage.getItem('korea_plan_v6')) || defaultPlanCards;
        flightCardsData = JSON.parse(localStorage.getItem('korea_flight_v4')) || defaultFlightCards;
        infoCardsData = JSON.parse(localStorage.getItem('korea_info_v8')) || defaultInfoCards;
        weatherLocs = JSON.parse(localStorage.getItem('korea_weather_locs_v3')) || defaultWeatherLocs;
        expenses = JSON.parse(localStorage.getItem('korea_expenses_v3')) || [];
        travelMembers = JSON.parse(localStorage.getItem('korea_travel_members_v1')) || ['å®¶èŒµ', 'å…ƒçš‡', 'è»’ç‘„', 'é‡‘å³°', 'ç‘‹ç³', 'å† ä¼¶', 'åº­æ·³', 'è±«é™½'];
        memo = localStorage.getItem('korea_memo_2026_v3') || defaultMemo;
        checklist = JSON.parse(localStorage.getItem('korea_chk_2026_v7')) || defaultChecklist;
        titles = JSON.parse(localStorage.getItem('korea_titles_v2')) || defaultTitles;

        // --- Firebase åˆå§‹åŒ–èˆ‡è³‡æ–™ç¶å®š ---
        window.addEventListener('firebaseReady', () => {
            db = window.firebaseDb;
            auth = window.firebaseAuth;
            initApp();
        });

        async function initApp() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await window.fsAuthFns.signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await window.fsAuthFns.signInAnonymously(auth);
            }
            
            window.fsAuthFns.onAuthStateChanged(auth, user => {
                currentUser = user;
                if(user) {
                    setupRealtimeListeners();
                }
            });
            fetchWeather(); 
            fetchExchangeRate(false);
        }

        // --- é›²ç«¯å„²å­˜èˆ‡ç›£è½ ---
        function setupRealtimeListeners() {
            if(!currentUser) return;
            const globalRef = window.fsCollections.doc(db, 'artifacts', appId, 'public', 'data', 'appState', 'global');
            
            window.fsCollections.onSnapshot(globalRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // ç”±æ–¼ Firestore ä¸æ”¯æ´å·¢ç‹€é™£åˆ— (Nested arrays)ï¼Œå¡ç‰‡è³‡æ–™è¢«è½‰æ›æˆ JSON å­—ä¸²å„²å­˜èˆ‡è®€å–
                    if(data.planCardsStr) planCardsData = JSON.parse(data.planCardsStr);
                    if(data.flightCardsStr) flightCardsData = JSON.parse(data.flightCardsStr);
                    if(data.infoCardsStr) infoCardsData = JSON.parse(data.infoCardsStr);
					if(data.listsCardsStr) listsCardsData = JSON.parse(data.listsCardsStr);
                    if(data.weatherLocs) weatherLocs = data.weatherLocs;
                    if(data.travelMembers) travelMembers = data.travelMembers;
                    if(data.memo !== undefined) memo = data.memo;
					if(data.memoList) memoList = data.memoList;
                    if(data.titles) titles = data.titles;
                    
                    // Trigger Re-renders (é›²ç«¯è³‡æ–™è¼‰å…¥å¾Œé»˜é»˜æ›´æ–°ç•«é¢)
                    initTitlesUI();
                    renderCards('plan'); renderCards('flight'); renderCards('info'); renderCards('lists');
                    renderWeatherSettingsList(); 
                    renderChecklist();
                    renderMembersEditList(); renderPayerRadios(); renderSplitMembersCheckboxes();
                    
                    // é˜²å‘†ï¼šå¦‚æœä½¿ç”¨è€…æ­£åœ¨ç·¨è¼¯ memoï¼Œä¸è¦å¼·åˆ¶è¦†è“‹ä»¥å…ä¸­æ–·æ‰“å­—
                    if(document.getElementById('memo-input') && document.activeElement !== document.getElementById('memo-input')) {
                        document.getElementById('memo-input').value = memo;
                        detectLinks();
                    }
                } else {
                    // å¦‚æœé›²ç«¯æ²’è³‡æ–™ï¼ŒåŸ·è¡Œç„¡ç—›é·ç§» (å°‡åŸ localStorage è³‡æ–™æ”¾ä¸Šé›²ç«¯)
                    // å°‡å«æœ‰ Grid (å·¢ç‹€é™£åˆ—) çš„å¡ç‰‡è³‡æ–™è½‰ç‚ºå­—ä¸²ï¼Œé¿å… Firestore å ±éŒ¯
                    const migratedData = {
                        planCardsStr: JSON.stringify(planCardsData),
                        flightCardsStr: JSON.stringify(flightCardsData),
                        infoCardsStr: JSON.stringify(infoCardsData),
                        weatherLocs: weatherLocs,
                        travelMembers: travelMembers,
                        checklist: checklist,
                        memo: memo,
                        titles: titles
                    };
                    window.fsCollections.setDoc(globalRef, migratedData);
                    
                    // é·ç§»è¨˜å¸³ç´€éŒ„
                    const expRefColl = window.fsCollections.collection(db, 'artifacts', appId, 'public', 'data', 'expenses');
                    expenses.forEach(ex => {
                        window.fsCollections.setDoc(window.fsCollections.doc(expRefColl, ex.id), ex);
                    });
                }
            }, (error) => { console.error("Global state sync error:", error); });

            const expRef = window.fsCollections.collection(db, 'artifacts', appId, 'public', 'data', 'expenses');
            window.fsCollections.onSnapshot(expRef, (snapshot) => {
                const loadedExpenses = [];
                snapshot.forEach(doc => {
                    loadedExpenses.push({ id: doc.id, ...doc.data() });
                });
                loadedExpenses.sort((a,b) => {
                    const idA = parseInt(a.id.replace('exp','')) || 0;
                    const idB = parseInt(b.id.replace('exp','')) || 0;
                    return idB - idA;
                });
                expenses = loadedExpenses;
                renderExpenses();
            }, (error) => { console.error("Expenses sync error:", error); });
        }

        window.saveGlobalState = async function(partialData) {
            if(!currentUser) return;
            const globalRef = window.fsCollections.doc(db, 'artifacts', appId, 'public', 'data', 'appState', 'global');
            try {
                await window.fsCollections.setDoc(globalRef, partialData, { merge: true });
            } catch(e) {
                console.error("Save failed", e);
            }
        };

		// --- é€šç”¨åŠŸèƒ½æ”¹å¯«ç‚ºé›²ç«¯å„²å­˜ ---
        window.saveTitle = function(key, val) { 
            titles[key] = val;
            localStorage.setItem('korea_titles_v2', JSON.stringify(titles)); // å…ˆå­˜æœ¬æ©Ÿ
            window.saveGlobalState({ titles: titles }); // å†å‚³é›²ç«¯
        }		
		
		function initTitlesUI() {
            document.getElementById('title-plan').innerText = titles.plan || 'æ¯æ—¥è¡Œç¨‹å®‰æ’';
            document.getElementById('title-flight').innerText = titles.flight || 'èˆªç­è³‡è¨Šèˆ‡è¦å®š';
            document.getElementById('title-info').innerText = titles.info || 'é‡è¦è³‡è¨Šèˆ‡ä½å®¿';
            document.getElementById('title-wallet').innerText = titles.wallet || 'æ›åŒ¯èˆ‡è¨˜å¸³';
            document.getElementById('title-lists').innerText = titles.lists || 'è¡Œç¨‹å‚™å¿˜éŒ„';
            if(document.getElementById('title-lists-sub')) document.getElementById('title-lists-sub').innerText = titles.listsSub || 'å…¶ä»–å‚™å¿˜éŒ„';
        }
		
        // --- è³‡æ–™æ¸²æŸ“ ---
		window.renderCards = function(tab) {
            const dataArr = tab === 'plan' ? planCardsData : (tab === 'flight' ? flightCardsData : (tab === 'lists' ? listsCardsData : infoCardsData));
            const container = document.getElementById(tab + '-cards-container');
            if(!container) return;
            container.innerHTML = dataArr.map((card, idx) => `
                <div class="muji-card p-4 border border-gray-200 relative mb-4 animate-fade-in">
                    <div class="absolute top-3 right-3 flex space-x-1">
                        <button onclick="moveCard('${tab}', '${card.id}', -1)" class="text-gray-400 p-1 bg-white border rounded text-xs hover:bg-gray-100">â†‘</button>
                        <button onclick="moveCard('${tab}', '${card.id}', 1)" class="text-gray-400 p-1 bg-white border rounded text-xs hover:bg-gray-100">â†“</button>
                        <button onclick="openInfoModal('${tab}', '${card.id}')" class="text-gray-400 p-1 bg-white border rounded text-xs hover:bg-gray-100">âœ</button>
                    </div>
                    <h3 class="font-bold mb-4 text-base border-b pb-2 pr-16" style="color: ${toHex(card.color)};"><i class="fas ${card.icon} mr-2"></i>${card.title}</h3>
                    <div class="space-y-3">${card.blocks.map(b => renderBlockView(b)).join('')}</div>
                </div>`).join('');
        }
		
		function renderBlockView(b) {
            if (b.type === 'badge') {
                return `<div class="space-y-2">` + b.items.map(item => `
                    <div class="flex items-start">
                        <div class="text-[10px] px-2 py-0.5 rounded mr-3 mt-0.5 border border-black/5 shrink-0" style="background-color: ${toHex(item.style)}; color: ${toHex(item.textColor)};">${item.badge}</div>
                        <div class="flex-1 w-full overflow-hidden">
                            <p class="text-sm font-bold break-words" style="color: ${toHex(item.titleColor)};">${item.title}</p>
							${item.details ? `<div class="mt-1.5 flex flex-wrap gap-1.5">` + item.details.map(d => 
                                d.isLink && d.text ? (function(){
                                    let url = d.text;
                                    const isNaver = url.includes('naver.com') || url.includes('naver.me');
                                    const isGoogle = url.includes('google.com') || url.includes('goo.gl');
                                    
                                    if (isNaver && !url.includes('language=')) {
                                        url += (url.includes('?') ? '&' : '?') + 'language=zh';
                                    }

                                    let btnClass = "bg-white/70 text-gray-700 border-gray-300";
                                    let icon = "<i class='fas fa-link mr-1'></i>";
                                    if (isNaver) {
                                        btnClass = "bg-[#03C75A] text-white border-transparent";
                                        icon = "<i class='fas fa-map-pin mr-1'></i>";
                                    } else if (isGoogle) {
                                        btnClass = "bg-[#4285F4] text-white border-transparent";
                                        icon = "<i class='fab fa-google mr-1'></i>";
                                    }

                                    const label = d.linkName || "ç¶²å€";
                                    return `<a href="${url}" target="_blank" class="text-[10px] ${btnClass} px-2.5 py-1.5 rounded-lg border inline-flex items-center font-bold truncate w-fit max-w-full shadow-sm active:scale-95 transition-transform hover:opacity-90">${icon}${label}</a>`;
                                })()
                                : (d.text ? `<p class="text-[11px] text-gray-700 w-full break-words whitespace-pre-wrap mb-0.5">${d.text}</p>` : '')
                            ).join('') + `</div>` : ''}
							</div>
                    </div>`).join('') + `</div>`;
            } else if (b.type === 'alert') {
                return `<div class="p-3 rounded border text-xs flex items-start border-black/5 shadow-sm" style="background-color: ${toHex(b.style)}; color: ${toHex(b.textColor||'#333')};">${b.icon ? `<span class="mr-2 text-base">${b.icon}</span>` : ''}<div class="whitespace-pre-wrap flex-1 leading-relaxed break-words">${b.text}</div></div>`;
            } else if (b.type === 'grid') {
                return `<div class="grid gap-1 text-[11px]" style="grid-template-columns: repeat(${b.cols}, minmax(0, 1fr));">${b.rows.flatMap(r => r).map(cell => `<div class="bg-gray-50 border p-1 rounded text-center break-words">${cell}</div>`).join('')}</div>`;
            } else if (b.type === 'text') {
                return `<p class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed break-words">${b.text}</p>`;
			} else if (b.type === 'split') {
                return `<div class="flex overflow-x-auto snap-x snap-mandatory gap-3 pb-3 mt-2 hide-scrollbar w-full">
                    ${b.routes.map(r => {
                        let content = r.text || '';
                        content = content.replace(/(https?:\/\/[^\s\)]+)/g, match => {
                            let url = match;
                            let isNaver = url.includes('naver'); let isGoogle = url.includes('google') || url.includes('goo.gl');
                            if (isNaver && !url.includes('language=')) url += (url.includes('?') ? '&' : '?') + 'language=zh';
                            let btnClass = isNaver ? 'bg-[#03C75A] text-white border-transparent' : (isGoogle ? 'bg-[#4285F4] text-white border-transparent' : 'bg-white text-gray-700 border-gray-300');
                            let icon = isNaver ? 'fa-map-pin' : (isGoogle ? 'fa-google' : 'fa-external-link-alt');
                            let label = isNaver ? 'Naverå°èˆª' : (isGoogle ? 'Googleå°èˆª' : 'é–‹å•Ÿé€£çµ');
                            return `<a href="${url}" target="_blank" class="text-[10px] ${btnClass} px-2.5 py-1.5 rounded-lg border inline-flex items-center font-bold shadow-sm active:scale-95 transition-transform mt-1.5 mr-1.5"><i class="fas ${icon} mr-1"></i>${label}</a>`;
                        });
                        
                        let detailsHtml = '';
                        if(r.details && r.details.length > 0) {
                            detailsHtml = `<div class="mt-1.5 flex flex-wrap gap-1.5 border-t border-black/5 pt-2">` + r.details.map(d => {
                                if(!d.text) return '';
                                
                                let textTrimmed = d.text.trim();
                                let isOnlyUrl = /^https?:\/\/[^\s]+$/.test(textTrimmed);
                                
                                if(d.isLink || isOnlyUrl) {
                                    let url = textTrimmed;
                                    const isNaver = url.includes('naver.com') || url.includes('naver.me');
                                    const isGoogle = url.includes('google.com') || url.includes('goo.gl');
                                    if (isNaver && !url.includes('language=')) { url += (url.includes('?') ? '&' : '?') + 'language=zh'; }
                                    let btnClass = "bg-white/70 text-gray-700 border-gray-300"; let icon = "<i class='fas fa-link mr-1'></i>";
                                    if (isNaver) { btnClass = "bg-[#03C75A] text-white border-transparent"; icon = "<i class='fas fa-map-pin mr-1'></i>"; } 
                                    else if (isGoogle) { btnClass = "bg-[#4285F4] text-white border-transparent"; icon = "<i class='fab fa-google mr-1'></i>"; }
                                    const label = d.linkName || (isNaver ? "Naverå°èˆª" : (isGoogle ? "Googleå°èˆª" : "é–‹å•Ÿé€£çµ"));
                                    return `<a href="${url}" target="_blank" class="text-[10px] ${btnClass} px-2.5 py-1.5 rounded-lg border inline-flex items-center font-bold shadow-sm active:scale-95 transition-transform hover:opacity-90"><i class="fas ${icon} mr-1"></i>${label}</a>`;
                                } else {
                                    // æƒ…æ³Bï¼šæ··é›œæ–‡å­— âœ â˜…å¾¹åº•ç§»é™¤é»‘é»é»â˜…ï¼Œä¸¦å°‡å…§æ–‡ç¶²å€è‡ªå‹•è½‰æŒ‰éˆ•
                                    let processedText = d.text.replace(/(https?:\/\/[^\s\)]+)/g, match => {
                                        let url = match;
                                        let isNaver = url.includes('naver'); let isGoogle = url.includes('google') || url.includes('goo.gl');
                                        if (isNaver && !url.includes('language=')) url += (url.includes('?') ? '&' : '?') + 'language=zh';
                                        let btnClass = isNaver ? 'bg-[#03C75A] text-white border-transparent' : (isGoogle ? 'bg-[#4285F4] text-white border-transparent' : 'bg-white text-gray-700 border-gray-300');
                                        let icon = isNaver ? 'fa-map-pin' : (isGoogle ? 'fa-google' : 'fa-external-link-alt');
                                        let label = isNaver ? 'Naverå°èˆª' : (isGoogle ? 'Googleå°èˆª' : 'é–‹å•Ÿé€£çµ');
                                        return `<a href="${url}" target="_blank" class="text-[10px] ${btnClass} px-2.5 py-1.5 rounded-lg border inline-flex items-center font-bold shadow-sm active:scale-95 transition-transform mt-1 mb-0.5 mr-1.5 inline-block"><i class="fas ${icon} mr-1"></i>${label}</a>`;
                                    });
                                    return `<div class="w-full text-[11px] text-gray-700 break-words whitespace-pre-wrap leading-tight">${processedText}</div>`;
                                }
                            }).join('') + `</div>`;
                        }

                        return `
                        <div class="snap-center shrink-0 w-[85%] p-4 rounded-xl shadow-sm flex flex-col h-full border border-black/5 relative overflow-hidden" style="background-color: ${toHex(r.style)};">
                            <div class="absolute -right-3 -top-3 text-6xl opacity-[0.04] pointer-events-none"><i class="fas fa-route"></i></div>
                            <div class="flex items-center mb-2.5 border-b border-black/5 pb-2 relative z-10">
                                <span class="text-[11px] px-2 py-0.5 rounded-md mr-2 shrink-0 font-bold bg-white/60 shadow-sm border border-black/5" style="color: ${toHex(r.textColor)};">${r.badge}</span>
                                <span class="text-sm font-bold truncate pr-4" style="color: ${toHex(r.titleColor)};">${r.title}</span>
                            </div>
                            <div class="flex-1 relative z-10 flex flex-col">
                                ${content ? `<div class="text-xs leading-relaxed whitespace-pre-wrap mb-1" style="color: ${toHex(r.titleColor)};">${content}</div>` : ''}
                                ${detailsHtml}
                            </div>
                        </div>`;
                    }).join('')}
                </div>
                <div class="text-[10px] text-gray-400 text-center font-bold mt-0.5 animate-pulse flex justify-center items-center gap-2">
                    <i class="fas fa-chevron-left text-[8px]"></i> å·¦å³æ»‘å‹•æŸ¥çœ‹ä¸åŒæ–¹æ¡ˆ <i class="fas fa-chevron-right text-[8px]"></i>
                </div>`;
            }
            return '';
        }
		
		window.moveCard = function(tab, id, dir) {
            let dataArr = tab === 'plan' ? planCardsData : (tab === 'flight' ? flightCardsData : (tab === 'lists' ? listsCardsData : infoCardsData));
            const idx = dataArr.findIndex(x => x.id === id);
            if (dir === -1 && idx > 0) [dataArr[idx-1], dataArr[idx]] = [dataArr[idx], dataArr[idx-1]];
            if (dir === 1 && idx < dataArr.length - 1) [dataArr[idx], dataArr[idx+1]] = [dataArr[idx+1], dataArr[idx]];
            saveCardsToStorage(tab);
        }

        window.saveCardsToStorage = function(tab) {
            // 1. åŒæ­¥å­˜å…¥æœ¬æ©Ÿè¨˜æ†¶é«” (ç¢ºä¿é‡æ•´ä¸éºå¤±)
            if (tab === 'plan') localStorage.setItem('korea_plan_v6', JSON.stringify(planCardsData));
            if (tab === 'flight') localStorage.setItem('korea_flight_v4', JSON.stringify(flightCardsData));
            if (tab === 'info') localStorage.setItem('korea_info_v8', JSON.stringify(infoCardsData));
            if (tab === 'lists') localStorage.setItem('korea_lists_v1', JSON.stringify(listsCardsData));

            // 2. èƒŒæ™¯ä¸Šå‚³åˆ° Firebase é›²ç«¯
            if (tab === 'plan') window.saveGlobalState({ planCardsStr: JSON.stringify(planCardsData) });
            if (tab === 'flight') window.saveGlobalState({ flightCardsStr: JSON.stringify(flightCardsData) });
            if (tab === 'info') window.saveGlobalState({ infoCardsStr: JSON.stringify(infoCardsData) });
            if (tab === 'lists') window.saveGlobalState({ listsCardsStr: JSON.stringify(listsCardsData) });
            
            // 3. ç«‹å³å¼·åˆ¶åˆ·æ–°ç•«é¢ï¼Œç¬é–“çœ‹åˆ°ä¿®æ”¹çµæœ
            if(typeof renderCards === 'function') renderCards(tab);
        }
		
		const colorPaletteHTML = (currentVal, actionTemplate) => {
            const currentHex = toHex(currentVal).toLowerCase();
            
            // â˜… çµ‚æ¥µé˜²é–ƒé€€ï¼šå®Œå…¨å‰é›¢é‡æ•´ç•«é¢çš„æŒ‡ä»¤ï¼ŒåªæŠŠé¡è‰²å­˜é€²èƒŒå¾Œè³‡æ–™ â˜…
            const safeDataAction = actionTemplate.replace(/;\s*renderBlocksEditor\(\)/g, '').replace(/;\s*updateInfoModalUI\(\)/g, '');

            return `
            <div class="flex overflow-x-auto gap-2 py-1 hide-scrollbar w-full items-center pl-1">
                <div class="relative w-6 h-6 flex-shrink-0 rounded-full overflow-hidden border border-gray-300 shadow-sm" style="background-color: ${currentHex};">
                    <input type="color" value="${currentHex}" 
                        oninput="${safeDataAction.replace('$$VAL$$', `'+this.value+'`)}; this.parentElement.style.backgroundColor=this.value;" 
                        class="absolute -top-2 -left-2 w-10 h-10 cursor-pointer opacity-0">
                </div>
                
                <div class="w-[1px] h-4 bg-gray-300 mx-1 shrink-0"></div>
                
                ${morandiColors.map(c => `
                    <button type="button" onclick="${actionTemplate.replace('$$VAL$$', c.hex)}" class="w-6 h-6 rounded-full flex-shrink-0 border flex items-center justify-center transition-transform ${currentHex === c.hex.toLowerCase() ? 'border-gray-800 scale-110 ring-1 ring-gray-400' : 'border-black/10 hover:scale-110'}" style="background-color: ${c.hex};" title="${c.name}"></button>
                `).join('')}
            </div>`;
        };
		
        window.closeInfoModal = function() { 
            document.getElementById('info-modal').classList.add('hidden'); 
            document.getElementById('info-modal').classList.remove('flex'); 
            editState = null;
        }
        
        window.updateInfoModalUI = function() {
            if(!editState) return;
            const previewColor = toHex(editState.color);
            const previewIcon = editState.icon ? `<i class="fas ${editState.icon} mr-2"></i>` : '';
            
            // â˜… è¨˜æ†¶è¡“ï¼šåœ¨é‡æ•´å°å€å¡Šå‰ï¼Œè¨˜ä½èª¿è‰²ç›¤ç›®å‰æ»‘åˆ°å“ªè£¡ â˜…
            const cpContainer = document.querySelector('#info-edit-color-picker > div');
            const savedScrollLeft = cpContainer ? cpContainer.scrollLeft : 0;

            const previewEl = document.getElementById('info-edit-title-preview');
            if(previewEl) {
                previewEl.innerHTML = `
                    <div class="mt-2 p-3 rounded bg-white border border-dashed border-gray-300 shadow-sm">
                        <span class="text-[10px] font-bold text-gray-400 block mb-1 uppercase">ä¸»æ¨™é¡Œé è¦½ Preview</span>
                        <h3 class="font-bold text-base border-b pb-1" style="color: ${previewColor};">${previewIcon}${editState.title || 'å¡ç‰‡æ¨™é¡Œ'}</h3>
                    </div>
                `;
            }
            
            const cp = document.getElementById('info-edit-color-picker');
            if(cp) {
                cp.innerHTML = colorPaletteHTML(editState.color, `editState.color='$$VAL$$'; updateInfoModalUI()`);
                // â˜… æ¢å¾©è¡“ï¼šé‡æ•´å®Œç¬é–“ï¼ŒæŠŠæ²è»¸æ‹‰å›å‰›å‰›è¨˜ä½çš„ä½ç½® â˜…
                const newCpContainer = document.querySelector('#info-edit-color-picker > div');
                if(newCpContainer) newCpContainer.scrollLeft = savedScrollLeft;
            }
            
            const ip = document.getElementById('info-edit-icon-picker');
            if(ip) ip.innerHTML = iconsList.map(ic => `<button onclick="editState.icon='${ic}'; updateInfoModalUI()" class="p-2 rounded border icon-btn shrink-0 ${editState.icon===ic?'selected border-gray-400':'border-transparent hover:bg-gray-200'}"><i class="fas ${ic} text-gray-700"></i></button>`).join('');
        }
        
        window.openInfoModal = function(tab, cardId = null) {
            currentEditTab = tab;
            const m = document.getElementById('info-modal');
            const dataArr = tab === 'plan' ? planCardsData : (tab === 'flight' ? flightCardsData : (tab === 'lists' ? listsCardsData : infoCardsData));
            if (cardId) { 
                editState = JSON.parse(JSON.stringify(dataArr.find(x => x.id === cardId)));
            } else { 
                editState = { id: 'ic' + Date.now(), title: '', icon: 'fa-star', color: '#111827', blocks: [] };
            }
            const titleInput = document.getElementById('info-edit-title');
            if(titleInput) titleInput.value = editState.title; 
            updateInfoModalUI(); 
            if(typeof renderBlocksEditor === 'function') renderBlocksEditor(); 
            if(m) { m.classList.remove('hidden'); m.classList.add('flex'); }
        }

        window.saveInfoCard = function() {
            const titleInput = document.getElementById('info-edit-title');
            editState.title = titleInput ? titleInput.value : 'æœªå‘½åå¡ç‰‡';
            const dataArr = currentEditTab === 'plan' ? planCardsData : (currentEditTab === 'flight' ? flightCardsData : (currentEditTab === 'lists' ? listsCardsData : infoCardsData));
            const idx = dataArr.findIndex(x => x.id === editState.id);
            if (idx >= 0) dataArr[idx] = editState; else dataArr.push(editState);
            saveCardsToStorage(currentEditTab); 
            closeInfoModal();
            if(typeof showMsg === 'function') showMsg('å¡ç‰‡å…§å®¹å·²å„²å­˜ä¸¦åŒæ­¥è‡³é›²ç«¯ï¼âœ¨');
        }

        window.deleteCurrentInfoCard = function() { 
            if(typeof showMsg === 'function') {
                showMsg('ç¢ºå®šè¦åˆªé™¤é€™æ•´å¼µå¡ç‰‡å—ï¼Ÿ', true, () => { 
                    if (currentEditTab === 'plan') planCardsData = planCardsData.filter(x => x.id !== editState.id);
                    else if (currentEditTab === 'flight') flightCardsData = flightCardsData.filter(x => x.id !== editState.id);
                    else if (currentEditTab === 'lists') listsCardsData = listsCardsData.filter(x => x.id !== editState.id);
                    else infoCardsData = infoCardsData.filter(x => x.id !== editState.id);
                    saveCardsToStorage(currentEditTab); 
                    closeInfoModal(); 
                });
            }
        }
		
        window.addInfoBlock = function(type) {
            if (type === 'badge') editState.blocks.push({ type: 'badge', items: [{ style: '#e0f2fe', textColor: '#0369a1', titleColor: '#111827', badge: 'æ¨™ç±¤', title: '', details: [{text: '', isLink: false, linkName: ''}] }] });
            if (type === 'alert') editState.blocks.push({ type: 'alert', style: '#fef9c3', textColor: '#854d0e', icon: 'âš ï¸', text: '' });
            if (type === 'grid') editState.blocks.push({ type: 'grid', cols: 2, rows: [['é …ç›®1', 'æ•¸å€¼'], ['é …ç›®2', 'æ•¸å€¼']] });
			if (type === 'text') editState.blocks.push({ type: 'text', text: '' });
            if (type === 'split') { 
				editState.blocks.push({ 
				type: 'split', 
				routes: [
					{ style: '#f3e8ff', textColor: '#6b21a8', titleColor: '#581c87', badge: 'Açµ„', title: 'è·¯ç·šA', text: 'å¡«å¯«Açµ„ä¸»è¦èªªæ˜...', details: [] },
					{ style: '#ffedd5', textColor: '#c2410c', titleColor: '#9a3412', badge: 'Bçµ„', title: 'è·¯ç·šB', text: 'å¡«å¯«Bçµ„ä¸»è¦èªªæ˜...', details: [] }
				] 
			    }); 
			}
			renderBlocksEditor();
        }
        window.deleteBlock = function(idx) { editState.blocks.splice(idx, 1); renderBlocksEditor(); }
        window.moveBlock = function(idx, dir) { if (dir===-1 && idx>0) { const temp = editState.blocks[idx]; editState.blocks[idx] = editState.blocks[idx-1]; editState.blocks[idx-1] = temp; } if (dir===1 && idx<editState.blocks.length-1) { const temp = editState.blocks[idx]; editState.blocks[idx] = editState.blocks[idx+1]; editState.blocks[idx+1] = temp; } renderBlocksEditor(); }
        
        window.ub = function(idx, field, val) { 
            editState.blocks[idx][field] = val; 
            const alertTextEl = document.getElementById(`preview-alert-text-${idx}`);
            if(field === 'text' && alertTextEl) alertTextEl.innerText = val || 'æé†’å…§å®¹';
        }
		
		window.usplit = function(bIdx, rIdx, field, val) { 
            editState.blocks[bIdx].routes[rIdx][field] = val; 
        }
		
        window.ug = function(bIdx, iIdx, field, val) { 
            editState.blocks[bIdx].items[iIdx][field] = val; 
            const badgeEl = document.getElementById(`preview-badge-${bIdx}-${iIdx}`);
            const titleEl = document.getElementById(`preview-title-${bIdx}-${iIdx}`);
            if(field === 'badge' && badgeEl) badgeEl.innerText = val || 'æ¨™ç±¤';
            if(field === 'title' && titleEl) titleEl.innerText = val || 'æ¨™é¡Œæ–‡å­—';
        }
        
        window.addBadgeDetail = function(bIdx, iIdx) { editState.blocks[bIdx].items[iIdx].details.push({text: '', isLink: false, linkName: ''}); renderBlocksEditor(); }
        window.delBadgeDetail = function(bIdx, iIdx, dIdx) { editState.blocks[bIdx].items[iIdx].details.splice(dIdx, 1); renderBlocksEditor(); }
        window.udg = function(bIdx, iIdx, dIdx, field, val) { const detail = editState.blocks[bIdx].items[iIdx].details[dIdx]; if (field === 'isLink') detail.isLink = (val === 'true'); else detail[field] = val; }
        window.updateGridCols = function(idx, delta) { const b = editState.blocks[idx]; const newCols = b.cols + delta; if (newCols > 0 && newCols <= 5) { b.cols = newCols; b.rows.forEach(r => { if (delta > 0) r.push(''); else r.pop(); }); renderBlocksEditor(); } }
        window.addGridRow = function(idx) { const b = editState.blocks[idx]; b.rows.push(new Array(b.cols).fill('')); renderBlocksEditor(); }
        window.delGridRow = function(idx, rIdx) { editState.blocks[idx].rows.splice(rIdx, 1); renderBlocksEditor(); }
        window.ugData = function(bIdx, rIdx, cIdx, val) { editState.blocks[bIdx].rows[rIdx][cIdx] = val; }
        window.addBadgeItem = function(idx) { editState.blocks[idx].items.push({ style: '#f3f4f6', textColor: '#374151', titleColor: '#111827', badge: 'æ–°æ¨™ç±¤', title: '', details: [{text: '', isLink: false, linkName: ''}] }); renderBlocksEditor(); }
        window.delBadgeItem = function(bIdx, iIdx) { editState.blocks[bIdx].items.splice(iIdx, 1); renderBlocksEditor(); }
		window.setIconAndRender = function(idx, val) { ub(idx, 'icon', val); renderBlocksEditor(); }

        window.addSplitRoute = function(bIdx) { editState.blocks[bIdx].routes.push({ style: '#f3f4f6', textColor: '#374151', titleColor: '#111827', badge: 'æ–°æ¨™ç±¤', title: 'æ–°è·¯ç·š', text: '', details: [] }); renderBlocksEditor(); }
        window.delSplitRoute = function(bIdx, rIdx) { editState.blocks[bIdx].routes.splice(rIdx, 1); renderBlocksEditor(); }
        
        // â˜… æ–°å¢åˆ†æµå¡ç‰‡å°ˆå±¬çš„æ˜ç´°æ“ä½œåŠŸèƒ½ â˜…
        window.addSplitDetail = function(bIdx, rIdx) { 
            if(!editState.blocks[bIdx].routes[rIdx].details) editState.blocks[bIdx].routes[rIdx].details = [];
            editState.blocks[bIdx].routes[rIdx].details.push({text: '', isLink: false, linkName: ''}); 
            renderBlocksEditor(); 
        }
        window.delSplitDetail = function(bIdx, rIdx, dIdx) { editState.blocks[bIdx].routes[rIdx].details.splice(dIdx, 1); renderBlocksEditor(); }
        window.udgSplit = function(bIdx, rIdx, dIdx, field, val) { 
            const detail = editState.blocks[bIdx].routes[rIdx].details[dIdx]; 
            if (field === 'isLink') detail.isLink = (val === 'true'); 
            else detail[field] = val; 
        }

		window.renderBlocksEditor = function() {
            const container = document.getElementById('info-edit-blocks-container');
            container.innerHTML = editState.blocks.map((b, idx) => `
                <div class="bg-white border border-gray-300 rounded overflow-hidden shadow-sm">
                    <div class="bg-gray-100 px-2 py-1.5 flex justify-between items-center border-b border-gray-200">
                        <span class="text-[11px] font-bold text-gray-600 bg-gray-200 px-2 rounded">${b.type==='badge'?'æ¨™ç±¤åˆ—':b.type==='alert'?'æé†’æ¡†':b.type==='grid'?'è¡¨æ ¼':b.type==='split'?'åˆ†çµ„è·¯ç·š':'ç´”æ–‡å­—'}</span>
                        <div class="flex space-x-1"><button onclick="moveBlock(${idx}, -1)" class="p-1 text-gray-500 hover:text-gray-900"><i class="fas fa-arrow-up text-[10px]"></i></button><button onclick="moveBlock(${idx}, 1)" class="p-1 text-gray-500 hover:text-gray-900"><i class="fas fa-arrow-down text-[10px]"></i></button><button onclick="deleteBlock(${idx})" class="p-1 text-red-400 hover:text-red-600 ml-2"><i class="fas fa-times text-xs"></i></button></div>
                    </div>
                    <div class="p-3 space-y-2">
                        ${b.type === 'badge' ? `
                            <div class="space-y-3">
                                ${b.items.map((it, i) => `
                                    <div class="p-2 border border-gray-200 rounded bg-gray-50 relative pb-3">
                                        ${b.items.length > 1 ? `<button onclick="delBadgeItem(${idx}, i)" class="absolute top-1 right-1 text-red-400 hover:text-red-600 p-1"><i class="fas fa-times text-[10px]"></i></button>` : ''}
                                        
                                        <div class="mb-3 p-2 rounded bg-white border border-dashed border-gray-300 shadow-sm">
                                            <span class="text-[10px] font-bold text-gray-400 block mb-1 uppercase">æ¨£å¼é è¦½ Preview</span>
                                            <div class="flex items-start">
                                                <div id="preview-badge-${idx}-${i}" class="text-[10px] px-2 py-0.5 rounded mr-2 border border-black/5 shrink-0 mt-0.5" style="background-color: ${toHex(it.style)}; color: ${toHex(it.textColor)};">${it.badge || 'æ¨™ç±¤'}</div>
                                                <div id="preview-title-${idx}-${i}" class="text-sm font-bold flex-1" style="color: ${toHex(it.titleColor)};">${it.title || 'æ¨™é¡Œæ–‡å­—'}</div>
                                            </div>
                                        </div>

                                        <div class="space-y-1.5 pr-6">
                                            <input type="text" value="${it.badge||''}" oninput="ug(${idx}, ${i}, 'badge', this.value)" placeholder="æ¨™ç±¤(ä¾‹:æ™‚é–“/å»ç¨‹)" class="w-full border border-gray-300 rounded p-1.5 text-xs font-bold outline-none bg-white">
                                            <input type="text" value="${it.title||''}" oninput="ug(${idx}, ${i}, 'title', this.value)" placeholder="ä¸»æ¨™é¡Œæ–‡å­—" class="w-full border border-gray-300 rounded p-1.5 text-sm font-bold outline-none bg-white">
                                        </div>
                                        <div class="space-y-1.5 mt-2 bg-white border border-gray-200 p-2 rounded shadow-sm">
                                            <div class="flex items-center"><span class="text-[10px] font-bold text-gray-500 w-10 shrink-0">åº•è‰²</span>${colorPaletteHTML(it.style, `ug(${idx}, ${i}, 'style', '$$VAL$$'); renderBlocksEditor()`)}</div>
                                            <div class="flex items-center"><span class="text-[10px] font-bold text-gray-500 w-10 shrink-0">æ¨™é¡Œ</span>${colorPaletteHTML(it.textColor, `ug(${idx}, ${i}, 'textColor', '$$VAL$$'); renderBlocksEditor()`)}</div>
                                            <div class="flex items-center"><span class="text-[10px] font-bold text-gray-500 w-10 shrink-0">å…§æ–‡</span>${colorPaletteHTML(it.titleColor, `ug(${idx}, ${i}, 'titleColor', '$$VAL$$'); renderBlocksEditor()`)}</div>
                                        </div>
                                        <div class="space-y-1.5 mt-2">
                                            ${it.details.map((d, dIdx) => `
                                                <div class="flex space-x-1 mt-1.5">
                                                    <select onchange="udg(${idx}, ${i}, ${dIdx}, 'isLink', this.value); renderBlocksEditor()" class="border border-gray-300 rounded p-1 text-[10px] font-bold bg-gray-100 shrink-0 outline-none"><option value="false" ${!d.isLink ? 'selected' : ''}>æ–‡å­—</option><option value="true" ${d.isLink ? 'selected' : ''}>ç¶²å€</option></select>
                                                    ${d.isLink ? `<input type="text" value="${d.linkName||''}" oninput="udg(${idx}, ${i}, ${dIdx}, 'linkName', this.value)" placeholder="æŒ‰éˆ•å" class="w-16 border border-gray-300 rounded p-1.5 text-xs font-bold outline-none bg-white text-gray-700 shrink-0">` : ''}
                                                    <input type="text" value="${d.text||''}" oninput="udg(${idx}, ${i}, ${dIdx}, 'text', this.value)" placeholder="${d.isLink?'https://...':'é™„åŠ èªªæ˜å…§å®¹'}" class="flex-1 min-w-0 border border-gray-300 rounded p-1.5 text-xs font-bold outline-none bg-white">
                                                    <button onclick="delBadgeDetail(${idx}, ${i}, ${dIdx})" class="text-red-400 px-1 shrink-0"><i class="fas fa-minus-circle text-[10px]"></i></button>
                                                </div>
                                            `).join('')}
                                            <button onclick="addBadgeDetail(${idx}, ${i})" class="w-full mt-1.5 py-1 text-[10px] font-bold text-gray-500 bg-white border border-dashed border-gray-300 rounded hover:bg-gray-100">+ æ–°å¢æ˜ç´°åˆ—</button>
                                        </div>
                                    </div>
                                `).join('')}
                                <button onclick="addBadgeItem(${idx})" class="w-full py-1.5 text-[11px] font-bold text-gray-600 bg-gray-100 border border-dashed border-gray-300 rounded hover:bg-gray-200 transition">+ æ–°å¢æ¨™ç±¤å€å¡Š</button>
                            </div>
                        ` : b.type === 'alert' ? `
                            <div class="space-y-2">
                                <div class="mb-2 p-2 rounded bg-white border border-dashed border-gray-300 shadow-sm">
                                    <span class="text-[10px] font-bold text-gray-400 block mb-1 uppercase">æ¨£å¼é è¦½ Preview</span>
                                    <div class="p-2 rounded border text-xs flex items-start border-black/5" style="background-color: ${toHex(b.style)}; color: ${toHex(b.textColor||'#333')};">
                                        ${b.icon ? `<span class="mr-2 text-sm">${b.icon}</span>` : ''}
                                        <div id="preview-alert-text-${idx}" class="whitespace-pre-wrap flex-1 leading-relaxed">${b.text || 'æé†’å…§å®¹'}</div>
                                    </div>
                                </div>

                                <div class="space-y-1.5 mt-1 bg-white border border-gray-200 p-2 rounded shadow-sm">
                                    <div class="flex items-center"><span class="text-[10px] font-bold text-gray-500 w-12 shrink-0">èƒŒæ™¯è‰²</span>${colorPaletteHTML(b.style, `ub(${idx}, 'style', '$$VAL$$'); renderBlocksEditor()`)}</div>
                                    <div class="flex items-center"><span class="text-[10px] font-bold text-gray-500 w-12 shrink-0">æ–‡å­—é¡è‰²</span>${colorPaletteHTML(b.textColor||'#333333', `ub(${idx}, 'textColor', '$$VAL$$'); renderBlocksEditor()`)}</div>
                                </div>
                                
                                <textarea oninput="ub(${idx}, 'text', this.value)" rows="5" placeholder="æé†’å…§å®¹" class="w-full border border-gray-300 rounded p-1.5 text-sm font-bold outline-none">${b.text}</textarea>
                            </div>
                        ` : b.type === 'grid' ? `
                            <div class="flex items-center space-x-2 mb-2 bg-gray-50 p-1.5 rounded border border-gray-200"><span class="text-[11px] font-bold text-gray-700">æ¬„ä½æ•¸:</span><button onclick="updateGridCols(${idx}, -1)" class="w-5 h-5 flex items-center justify-center bg-white border border-gray-300 rounded text-xs font-bold">-</button><span class="text-xs font-bold text-gray-900 w-4 text-center">${b.cols}</span><button onclick="updateGridCols(${idx}, 1)" class="w-5 h-5 flex items-center justify-center bg-white border border-gray-300 rounded text-xs font-bold">+</button></div>
                            <div class="space-y-1">
                                ${b.rows.map((row, rIdx) => `
                                    <div class="flex space-x-1">
                                        ${row.map((cell, cIdx) => `<input type="text" value="${cell}" oninput="ugData(${idx}, ${rIdx}, ${cIdx}, this.value)" class="w-full min-w-0 border border-gray-300 rounded p-1 text-xs font-bold text-center" placeholder="å…§å®¹">`).join('')}
                                        <button onclick="delGridRow(${idx}, ${rIdx})" class="text-red-400 px-1 shrink-0"><i class="fas fa-minus-circle text-[10px]"></i></button>
                                    </div>
                                `).join('')}
                                <button onclick="addGridRow(${idx})" class="w-full mt-2 py-1 text-[11px] font-bold text-gray-500 bg-gray-50 border border-dashed border-gray-300 rounded">+ æ–°å¢åˆ—</button>
                            </div>
						` : b.type === 'split' ? `
                            <div class="space-y-2">
                                <span class="text-[11px] font-bold text-[#0369a1]"><i class="fas fa-columns mr-1"></i>æ»‘å‹•å¼åˆ†æµå¡ç‰‡è¨­å®š</span>
                                
                                <div class="mb-3 p-2 rounded bg-white border border-dashed border-gray-300 shadow-sm overflow-hidden">
                                    <span class="text-[10px] font-bold text-gray-400 block mb-2 uppercase">æ¨£å¼é è¦½ Preview (å¯å‘å³æ»‘å‹•)</span>
                                    <div class="flex overflow-x-auto snap-x snap-mandatory gap-2 pb-2 hide-scrollbar w-full pointer-events-auto">
                                        ${b.routes.map(r => {
                                            let dHtml = '';
											if(r.details && r.details.length > 0) {
                                                dHtml = '<div class="mt-1.5 flex flex-wrap gap-1 border-t border-black/5 pt-1.5">' + r.details.map(d => {
                                                    if(!d.text) return '';
                                                    let textTrimmed = d.text.trim();
                                                    let isOnlyUrl = /^https?:\/\/[^\s]+$/.test(textTrimmed);
                                                    if(isOnlyUrl || d.isLink) return '<span class="inline-block bg-white/60 text-gray-800 border border-black/10 px-1.5 py-0.5 rounded text-[9px] w-fit shadow-sm">ğŸ”— å°èˆªæŒ‰éˆ•</span>';
                                                    let txt = d.text.replace(/(https?:\/\/[^\s\)]+)/g, 'ğŸ”—ç¶²å€');
                                                    // â˜… å·²ç§»é™¤é è¦½å€çš„é»‘é»é»
                                                    return '<div class="w-full text-[9px] text-gray-600 break-words mb-0.5">' + txt + '</div>';
                                                }).join('') + '</div>';
                                            }
                                            return `
                                            <div class="snap-center shrink-0 w-[80%] p-3 rounded-lg shadow-sm flex flex-col border border-black/5 relative overflow-hidden" style="background-color: ${toHex(r.style)};">
                                                <div class="flex items-center mb-1.5 border-b border-black/5 pb-1.5">
                                                    <span class="text-[10px] px-1.5 py-0.5 rounded-md mr-1.5 shrink-0 font-bold bg-white/60 shadow-sm border border-black/5" style="color: ${toHex(r.textColor)};">${r.badge || 'æ¨™ç±¤'}</span>
                                                    <span class="text-xs font-bold truncate pr-2" style="color: ${toHex(r.titleColor)};">${r.title || 'çŸ­æ¨™é¡Œ'}</span>
                                                </div>
                                                ${r.text ? `<div class="text-[10px] leading-relaxed whitespace-pre-wrap line-clamp-2" style="color: ${toHex(r.titleColor)};">${r.text}</div>` : ''}
                                                ${dHtml}
                                            </div>`;
                                        }).join('')}
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-2">
                                    ${b.routes.map((r, rIdx) => `
                                        <div class="p-2 border border-gray-200 rounded bg-white shadow-sm space-y-1.5 relative pb-6">
                                            ${b.routes.length > 1 ? `<button onclick="delSplitRoute(${idx}, ${rIdx})" class="absolute top-1 right-1 text-red-500 hover:text-red-700 bg-red-50 w-5 h-5 flex items-center justify-center rounded"><i class="fas fa-times text-[10px]"></i></button>` : ''}
                                            <div class="font-bold text-[10px] text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded inline-block">æ»‘å‹•å¡ç‰‡ ${rIdx + 1}</div>
                                            <input type="text" value="${r.badge}" oninput="usplit(${idx}, ${rIdx}, 'badge', this.value); updateInfoModalUI()" placeholder="ç¾¤çµ„(ä¾‹:Açµ„)" class="w-full border border-gray-300 rounded p-1.5 text-xs font-bold bg-white outline-none">
                                            <input type="text" value="${r.title}" oninput="usplit(${idx}, ${rIdx}, 'title', this.value); updateInfoModalUI()" placeholder="çŸ­æ¨™é¡Œ" class="w-full border border-gray-300 rounded p-1.5 text-xs font-bold bg-white outline-none">
                                            <textarea oninput="usplit(${idx}, ${rIdx}, 'text', this.value); updateInfoModalUI()" rows="2" placeholder="ä¸»è¦èªªæ˜(é¸å¡«)" class="w-full border border-gray-300 rounded p-1.5 text-xs font-bold bg-white outline-none leading-relaxed">${r.text}</textarea>
                                            
                                            <div class="space-y-1 mt-2 bg-gray-50 p-1.5 rounded border border-gray-200">
                                                <div class="text-[10px] font-bold text-gray-500 mb-1">ğŸ“‹ æ˜ç´°åˆ— (è‡ªå‹•åµæ¸¬ç¶²å€)</div>
                                                ${(r.details||[]).map((d, dIdx) => `
                                                    <div class="flex items-start space-x-1 mb-1.5 bg-white p-1 rounded border border-gray-200">
                                                        <textarea oninput="udgSplit(${idx}, ${rIdx}, ${dIdx}, 'text', this.value); updateInfoModalUI()" rows="2" placeholder="å…§å®¹æˆ–è²¼ä¸Šç¶²å€..." class="flex-1 min-w-0 border-transparent rounded p-1 text-xs font-bold outline-none bg-white leading-relaxed">${d.text||''}</textarea>
                                                        <button onclick="delSplitDetail(${idx}, ${rIdx}, ${dIdx})" class="text-red-400 p-1 shrink-0 hover:bg-red-50 rounded mt-0.5"><i class="fas fa-times-circle text-sm"></i></button>
                                                    </div>
                                                `).join('')}
                                                <button onclick="addSplitDetail(${idx}, ${rIdx})" class="w-full mt-1 py-1.5 text-[10px] font-bold text-gray-500 bg-white border border-dashed border-gray-300 rounded hover:bg-gray-100 transition">+ æ–°å¢æ˜ç´°åˆ—</button>
                                            </div>

                                            <div class="space-y-1 mt-2 border-t border-gray-100 pt-1.5">
                                                <div class="flex items-center"><span class="text-[10px] font-bold text-gray-400 w-8 shrink-0">åº•è‰²</span>${colorPaletteHTML(r.style, `usplit(${idx}, ${rIdx}, 'style', '$$VAL$$'); renderBlocksEditor()`)}</div>
                                                <div class="flex items-center"><span class="text-[10px] font-bold text-gray-400 w-8 shrink-0">æ¨™ç±¤</span>${colorPaletteHTML(r.textColor, `usplit(${idx}, ${rIdx}, 'textColor', '$$VAL$$'); renderBlocksEditor()`)}</div>
                                                <div class="flex items-center"><span class="text-[10px] font-bold text-gray-400 w-8 shrink-0">å…§æ–‡</span>${colorPaletteHTML(r.titleColor, `usplit(${idx}, ${rIdx}, 'titleColor', '$$VAL$$'); renderBlocksEditor()`)}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <button onclick="addSplitRoute(${idx})" class="w-full py-2 text-[11px] font-bold text-[#0369a1] bg-[#e0f2fe] border border-[#bae6fd] rounded hover:bg-[#bae6fd] transition mt-2">+ æ–°å¢ä¸€å¼µæ»‘å‹•å¡ç‰‡</button>
                            </div>
                        ` : `<textarea oninput="ub(${idx}, 'text', this.value)" rows="3" placeholder="è¼¸å…¥æ–‡å­—..." class="w-full border border-gray-300 rounded p-1.5 text-sm font-bold outline-none">${b.text}</textarea>`}
                    </div>
                </div>`).join('');
        }
		
		window.fetchWeather = async function(force = false) {
            // 1. è¨˜æ†¶é­”æ³•ï¼šå¦‚æœä¸å¼·åˆ¶æ›´æ–°ï¼Œä¸”è·é›¢ä¸Šæ¬¡ä¸åˆ° 30 åˆ†é˜ï¼Œç›´æ¥ç§’é–‹ï¼
            if (!force) {
                const cachedData = localStorage.getItem('korea_weather_cache');
                const cachedTime = localStorage.getItem('korea_weather_time');
                if (cachedData && cachedTime && (Date.now() - parseInt(cachedTime) < 30 * 60 * 1000)) {
                    weatherGlobalData = JSON.parse(cachedData);
                    renderWeatherContainer(false);
                    const d = new Date(parseInt(cachedTime));
                    document.getElementById('weather-update-time').innerText = `æ›´æ–°æ–¼ ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
                    return;
                }
            }

            renderWeatherContainer(true);
            document.getElementById('weather-update-time').innerText = "æ›´æ–°ä¸­...";
            try {
                // 2. åˆä½µè«‹æ±‚é­”æ³•ï¼šå°‡å¤šå€‹åœ°é»çš„ç¶“ç·¯åº¦çµ„åˆï¼Œåªç™¼å‡º 1 æ¬¡è«‹æ±‚ï¼
                const lats = weatherLocs.map(loc => loc.lat).join(',');
                const lons = weatherLocs.map(loc => loc.lon).join(',');
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lats}&longitude=${lons}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max&hourly=temperature_2m,precipitation_probability,weather_code&timezone=auto&forecast_days=2`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                // Open-Meteo APIï¼šå–®ç­†å›å‚³ Objectï¼Œå¤šç­†å›å‚³ Arrayï¼Œæˆ‘å€‘çµ±ä¸€è½‰æˆ Array
                weatherGlobalData = Array.isArray(data) ? data : [data];
                
                // å°‡æ–°æŠ“åˆ°çš„è³‡æ–™å­˜å…¥è¨˜æ†¶é«”
                localStorage.setItem('korea_weather_cache', JSON.stringify(weatherGlobalData));
                localStorage.setItem('korea_weather_time', Date.now().toString());

                renderWeatherContainer(false);
                const n = new Date();
                document.getElementById('weather-update-time').innerText = `æ›´æ–°æ–¼ ${String(n.getHours()).padStart(2, '0')}:${String(n.getMinutes()).padStart(2, '0')}`;
            } catch (err) {
                console.error("å¤©æ°£è®€å–å¤±æ•—:", err);
                document.getElementById('weather-update-time').innerText = "æ›´æ–°å¤±æ•—";
                renderWeatherContainer(false, true);
            }
        }
		
        window.renderWeatherContainer = function(isLoading, isError = false) {
            const c = document.getElementById('weather-container');
            c.innerHTML = weatherLocs.map((loc, i) => {
                if(isLoading) return `<div class="min-w-[115px] flex-shrink-0 p-3 rounded flex flex-col items-center text-center animate-pulse border border-black/5 shadow-sm" style="background-color: ${loc.color}"><div class="h-4 w-12 bg-black/10 rounded mb-2"></div><div class="h-8 w-8 bg-black/10 rounded-full my-1"></div><div class="h-4 w-10 bg-black/10 rounded mt-2"></div></div>`;
                if(isError) return `<div class="min-w-[115px] flex-shrink-0 p-3 rounded border border-black/5 flex flex-col items-center text-center opacity-50" style="background-color: ${loc.color}"><span class="text-xs font-bold text-gray-800">${loc.name}</span><div class="text-sm mt-2">è®€å–å¤±æ•—</div></div>`;
                
                const d = weatherGlobalData[i]; if(!d) return '';
                const cur = d.current; const daily = d.daily; const w = weatherCodeMap[cur.weather_code] || {icon:'â˜ï¸'};
                const temp = Math.round(cur.temperature_2m);
                const cloth = getClothingSuggestion(temp);
                
                return `
                <div onclick="showWeatherDetail(${i}, '${loc.name}')" class="min-w-[115px] flex-shrink-0 p-3 rounded flex flex-col items-center text-center cursor-pointer transition hover:scale-95 shadow-sm border border-black/5" style="background-color: ${loc.color}">
                    <span class="text-xs font-bold text-gray-800 mb-1 opacity-80">${loc.name}</span>
                    <div class="weather-icon text-xl my-1">${w.icon}</div>
                    <div class="text-base font-bold text-gray-900 mt-0.5">${temp}Â°C</div>
                    <div class="text-[10px] text-gray-600 font-bold mt-0.5">${Math.round(daily.temperature_2m_min[0])}Â° / ${Math.round(daily.temperature_2m_max[0])}Â°</div>
                    <div class="text-[10px] text-[#0369a1] font-bold mt-0.5"><i class="fas fa-umbrella"></i> ${daily.precipitation_probability_max[0]}%</div>
                    <div class="text-[9px] text-gray-700 font-bold mt-1.5 bg-white/50 px-1.5 py-1 rounded w-full truncate border border-black/5" title="${cloth}">ğŸ‘• ${cloth}</div>
                </div>`;
            }).join('');
        }

        window.showWeatherDetail = function(idx, locName) {
            if (!weatherGlobalData[idx]) return;
            const h = weatherGlobalData[idx].hourly;
            document.getElementById('weather-detail-title').innerText = `${locName} è¿‘24å°æ™‚é å ±`;
            let html = '';
            for(let i=0; i<h.time.length; i++) {
                const timeStr = new Date(h.time[i]).getHours() + ':00';
                const temp = Math.round(h.temperature_2m[i]);
                const pop = h.precipitation_probability[i];
                const w = weatherCodeMap[h.weather_code[i]] || {icon:'â˜ï¸'};
                html += `<div class="flex justify-between items-center p-2.5 border-b border-gray-100 last:border-0 hover:bg-gray-50 transition rounded"><span class="text-sm font-bold text-gray-700 w-12">${timeStr}</span><span class="text-xl w-8 text-center">${w.icon}</span><span class="text-sm font-bold text-gray-800 w-12 text-right">${temp}Â°C</span><span class="text-xs font-bold ${pop>30?'text-[#0284c7]':'text-gray-400'} w-12 text-right"><i class="fas fa-umbrella mr-1"></i>${pop}%</span></div>`;
            }
            document.getElementById('weather-detail-content').innerHTML = html;
            document.getElementById('weather-detail-modal').classList.remove('hidden');
            document.getElementById('weather-detail-modal').classList.add('flex');
        }
        window.closeWeatherDetail = function() { document.getElementById('weather-detail-modal').classList.add('hidden'); document.getElementById('weather-detail-modal').classList.remove('flex'); }

        window.openWeatherSettings = function() { renderWeatherSettingsList(); document.getElementById('weather-settings-modal').classList.remove('hidden'); document.getElementById('weather-settings-modal').classList.add('flex'); }
		window.closeWeatherSettings = function() { document.getElementById('weather-settings-modal').classList.add('hidden'); document.getElementById('weather-settings-modal').classList.remove('flex'); fetchWeather(true); }        
		window.renderWeatherSettingsList = function() {
            const c = document.getElementById('weather-settings-list');
            
            let addHtml = '<div class="bg-blue-50 border border-blue-200 rounded-xl p-3 mb-4 shadow-sm relative">' +
                '<div class="font-bold text-[11px] text-blue-800 mb-2"><i class="fas fa-search-location mr-1"></i>æœå°‹ä¸¦æ–°å¢åŸå¸‚</div>' +
                '<div class="flex space-x-2">' +
                    '<input type="text" id="new-loc-name" placeholder="è¼¸å…¥åŸå¸‚å (ä¾‹: æ±äº¬, Osaka)" class="flex-1 text-xs p-2 border border-blue-200 rounded outline-none font-bold text-gray-800 bg-white shadow-inner">' +
                    '<button onclick="searchAndAddCity()" id="btn-add-city" class="bg-blue-600 text-white px-3 py-2 rounded text-[11px] font-bold shadow-sm hover:bg-blue-700 transition active:scale-95 shrink-0">æœå°‹æ–°å¢</button>' +
                '</div>' +
            '</div>';

            let listHtml = weatherLocs.map((loc, i) => {
                // â˜… æŠ“å–çœŸå¯¦å¤©æ°£è³‡æ–™ä¾†æ›¿æ›é è¨­çš„ 24åº¦ â˜…
                let tempStr = "--Â°C";
                let iconStr = "â³";
                let clothStr = "è®€å–ä¸­...";
                
                if (typeof weatherGlobalData !== 'undefined' && weatherGlobalData[i] && weatherGlobalData[i].current) {
                    const cur = weatherGlobalData[i].current;
                    const temp = Math.round(cur.temperature_2m);
                    tempStr = temp + "Â°C";
                    const w = weatherCodeMap[cur.weather_code] || {icon:'â˜ï¸'};
                    iconStr = w.icon;
                    clothStr = getClothingSuggestion(temp);
                }

                return '<div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm mb-3">' +
                    '<div class="flex justify-between items-center mb-4">' +
                        '<input type="text" value="' + loc.name + '" onchange="updateWeatherLocData(' + i + ', \'name\', this.value)" class="font-bold text-gray-800 border-b border-gray-300 outline-none bg-transparent pb-0.5 w-1/2 focus:border-blue-500 transition text-base">' +
                        '<div class="flex space-x-2">' +
                            '<button onclick="moveWeatherLoc(' + i + ', -1)" class="p-1.5 px-2.5 text-gray-500 bg-gray-50 hover:bg-gray-200 rounded border border-gray-200 transition shadow-sm"><i class="fas fa-arrow-up text-xs"></i></button>' +
                            '<button onclick="moveWeatherLoc(' + i + ', 1)" class="p-1.5 px-2.5 text-gray-500 bg-gray-50 hover:bg-gray-200 rounded border border-gray-200 transition shadow-sm"><i class="fas fa-arrow-down text-xs"></i></button>' +
                            '<button onclick="deleteWeatherLoc(' + i + ')" class="p-1.5 px-2.5 text-red-500 bg-red-50 hover:bg-red-100 rounded border border-red-200 transition ml-1 shadow-sm"><i class="fas fa-trash text-xs"></i></button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="mb-4">' +
                        '<span class="text-[10px] font-bold text-gray-400 block mb-2 uppercase tracking-wider">æ¨£å¼é è¦½ Preview</span>' +
                        '<div class="w-full flex justify-center py-3 bg-gray-50 rounded-lg border border-dashed border-gray-300">' +
                             '<div class="w-[115px] p-3 rounded flex flex-col items-center text-center shadow-sm border border-black/5" style="background-color: ' + loc.color + '">' +
                                '<span class="text-[10px] font-bold text-gray-800 mb-1 opacity-70">' + loc.name + '</span>' +
                                '<div class="text-xl my-1">' + iconStr + '</div>' +
                                '<div class="text-sm font-bold text-gray-900 mt-0.5">' + tempStr + '</div>' +
                                '<div class="text-[9px] text-gray-700 font-bold mt-1.5 bg-white/50 px-1.5 py-1 rounded w-full truncate border border-black/5">ğŸ‘• ' + clothStr + '</div>' +
                             '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div>' +
                        '<span class="text-[10px] font-bold text-gray-500 block mb-1">æ›´æ›èƒŒæ™¯è‰²</span>' +
                        colorPaletteHTML(loc.color, "updateWeatherColor(" + i + ", '$$VAL$$')") +
                    '</div>' +
                '</div>';
            }).join('');

            c.innerHTML = addHtml + listHtml;
        }

        window.searchAndAddCity = async function() {
            const input = document.getElementById('new-loc-name');
            const btn = document.getElementById('btn-add-city');
            const query = input.value.trim();
            if(!query) { if(typeof showMsg==='function') showMsg('è«‹è¼¸å…¥è¦æœå°‹çš„åŸå¸‚åç¨±ï¼'); else alert('è«‹è¼¸å…¥åŸå¸‚'); return; }
            
            btn.innerText = "æœå°‹ä¸­..."; btn.disabled = true;
            try {
                // è‡ªå‹•æ‰“ API å¹«ä½ æŠŠåœ°åè½‰æˆç¶“ç·¯åº¦ï¼
                const res = await fetch("https://geocoding-api.open-meteo.com/v1/search?name=" + encodeURIComponent(query) + "&count=1&language=zh");
                const data = await res.json();
                if(data.results && data.results.length > 0) {
                    const city = data.results[0];
                    weatherLocs.push({ id: 'loc_' + Date.now(), name: query, lat: city.latitude, lon: city.longitude, color: '#f3f4f6' });
                    window.saveGlobalState({ weatherLocs: weatherLocs });
                    
                    // â˜… æˆåŠŸæ–°å¢å¾Œï¼Œç«‹åˆ»å»æŠ“æœ€æ–°çš„çœŸå¯¦å¤©æ°£è³‡æ–™ï¼Œä¸¦æ›´æ–°ç•«é¢ â˜…
                    await fetchWeather(true); 
                    renderWeatherSettingsList();
                    
                    if(typeof showMsg==='function') showMsg("âœ… æˆåŠŸæ–°å¢ï¼š" + city.name + " (" + city.country + ")");
                } else {
                    if(typeof showMsg==='function') showMsg('æ‰¾ä¸åˆ°é€™å€‹åŸå¸‚ï¼Œè«‹è©¦è‘—è¼¸å…¥è‹±æ–‡æˆ–å…¶ä»–é—œéµå­—ï¼(å¦‚: Jeju, Osaka)');
                }
            } catch(e) {
                if(typeof showMsg==='function') showMsg('æœå°‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚');
            }
            btn.innerText = "æœå°‹æ–°å¢"; btn.disabled = false;
        }

        window.deleteWeatherLoc = function(idx) {
            if(confirm("ç¢ºå®šè¦ç§»é™¤ã€Œ" + weatherLocs[idx].name + "ã€å—ï¼Ÿ")) {
                weatherLocs.splice(idx, 1);
                window.saveGlobalState({ weatherLocs: weatherLocs });
                // â˜… åˆªé™¤å¾Œä¹ŸåŒæ­¥æ›´æ–°å¤©æ°£è³‡æ–™ï¼Œä»¥å…éŒ¯ä½ â˜…
                fetchWeather(true).then(() => renderWeatherSettingsList());
            }
        }

        window.updateWeatherLocData = function(idx, field, val) {
            weatherLocs[idx][field] = val;
            window.saveGlobalState({ weatherLocs: weatherLocs });
            renderWeatherSettingsList();
        }

        window.moveWeatherLoc = function(idx, dir) {
            if(dir===-1 && idx>0) { let t = weatherLocs[idx]; weatherLocs[idx]=weatherLocs[idx-1]; weatherLocs[idx-1]=t; }
            if(dir===1 && idx<weatherLocs.length-1) { let t = weatherLocs[idx]; weatherLocs[idx]=weatherLocs[idx+1]; weatherLocs[idx+1]=t; }
            window.saveGlobalState({ weatherLocs: weatherLocs });
            // â˜… ç§»å‹•å¾Œä¹ŸåŒæ­¥æ›´æ–°å¤©æ°£è³‡æ–™ï¼Œä»¥å…éŒ¯ä½ â˜…
            fetchWeather(true).then(() => renderWeatherSettingsList()); 
        }

        window.updateWeatherColor = function(idx, hex) { 
            weatherLocs[idx].color = hex; 
            window.saveGlobalState({ weatherLocs: weatherLocs });
            renderWeatherSettingsList(); 
        }
		
        // --- â˜… éŒ¢åŒ…èˆ‡è¨˜å¸³æ¨¡çµ„ â˜… ---
        window.renderExpColorPicker = function() {
            const container = document.getElementById('exp-color-picker');
            if(container) {
                container.innerHTML = colorPaletteHTML(currentExpColor, `currentExpColor='$$VAL$$'; renderExpColorPicker()`);
            }
            const formArea = document.getElementById('expense-form-area');
            if (formArea) {
                formArea.style.backgroundColor = toHex(currentExpColor);
            }
        }

	window.fetchExchangeRate = async function(isManual = false) {
            try {
                if (isManual) document.getElementById('exchange-update-time').innerText = "æ›´æ–°ä¸­...";
                const res = await fetch('https://open.er-api.com/v6/latest/TWD'); const data = await res.json();
                if (data && data.rates && data.rates.KRW) {
                    document.getElementById('base-rate').value = data.rates.KRW.toFixed(2);
                    // â˜… æ–°å¢é€™è¡Œï¼šè‡ªå‹•æŠŠå³æ™‚åŒ¯ç‡åŒæ­¥åˆ°è¨˜å¸³è¡¨å–®çš„æ ¼å­è£¡
                    if(document.getElementById('exp-rate')) document.getElementById('exp-rate').value = data.rates.KRW.toFixed(2);
                    updateCalcDisplay(); calcExpTwd(); 
                    const n = new Date(); document.getElementById('exchange-update-time').innerText = `æ›´æ–°æ–¼ ${String(n.getHours()).padStart(2, '0')}:${String(n.getMinutes()).padStart(2, '0')}`;
                    if (isManual) showMsg("âœ… åŒ¯ç‡æ›´æ–°æˆåŠŸï¼\n\n1 TWD = " + data.rates.KRW.toFixed(2) + " KRW");
                }
            } catch (err) { document.getElementById('exchange-update-time').innerText = "æ›´æ–°å¤±æ•—"; if (isManual) showMsg("ç²å–åŒ¯ç‡å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯ç‹€æ…‹ã€‚"); }
        }
		
        window.pressKey = function(key) { currentCalc = currentCalc === "0" || currentCalc === "" ? key : currentCalc + key; updateCalcDisplay(); }
		window.clearCalc = function() { currentCalc = ""; updateCalcDisplay(); }
        window.backspaceCalc = function() { if(currentCalc.length > 0) { currentCalc = currentCalc.slice(0, -1); updateCalcDisplay(); } }
        window.evalCalc = function() { try { currentCalc = String(eval(currentCalc.replace('Ã—','*').replace('Ã·','/')) || ""); updateCalcDisplay(); } catch(e) { currentCalc = "Error"; updateCalcDisplay(); } }
        window.updateCalcDisplay = function() {
            const r = parseFloat(document.getElementById('base-rate').value) || 41; document.getElementById('calc-display').innerText = currentCalc ? `â‚© ${currentCalc}` : "â‚© 0";
            const v = parseFloat(currentCalc); document.getElementById('calc-result-twd').innerText = !isNaN(v) ? `â‰ˆ NT$ ${Math.round(v/r).toLocaleString()}` : `â‰ˆ NT$ 0`;
        }
        window.copyCalcToExpense = function() { const v = parseFloat(currentCalc); if (!isNaN(v)) { document.getElementById('exp-krw').value = v; calcExpTwd(); } }
window.calcExpTwd = function() { 
            const krw = parseFloat(document.getElementById('exp-krw').value);
            const r = parseFloat(document.getElementById('exp-rate').value) || parseFloat(document.getElementById('base-rate').value) || 41; 
            if (!isNaN(krw)) document.getElementById('exp-twd').value = Math.round(krw / r); else document.getElementById('exp-twd').value = '';
        }
        window.calcExpKrw = function() { 
            const twd = parseFloat(document.getElementById('exp-twd').value);
            const r = parseFloat(document.getElementById('exp-rate').value) || parseFloat(document.getElementById('base-rate').value) || 41; 
            if (!isNaN(twd)) document.getElementById('exp-krw').value = Math.round(twd * r); else document.getElementById('exp-krw').value = '';
        }

        window.previewExpPhoto = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 400; let width = img.width; let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                    currentExpBase64 = canvas.toDataURL('image/jpeg', 0.6);
                    document.getElementById('exp-img-tag').src = currentExpBase64; document.getElementById('exp-photo-preview').classList.remove('hidden');
                };
            };
        }
        window.removeExpPhoto = function() { currentExpBase64 = null; document.getElementById('exp-photo').value = ""; document.getElementById('exp-photo-preview').classList.add('hidden'); }
		// â˜… è£œé½Šï¼šç…§ç‰‡æ”¾å¤§é è¦½åŠŸèƒ½ â˜…
        window.openPhotoModal = function(src) {
            document.getElementById('photo-modal-img').src = src;
            document.getElementById('photo-modal').classList.remove('hidden');
            document.getElementById('photo-modal').classList.add('flex');
        }
        window.closePhotoModal = function() {
            document.getElementById('photo-modal').classList.add('hidden');
            document.getElementById('photo-modal').classList.remove('flex');
        }
		
        window.editMembers = function() { renderMembersEditList(); document.getElementById('members-modal').classList.remove('hidden'); document.getElementById('members-modal').classList.add('flex'); }
        window.closeMembersModal = function() { document.getElementById('members-modal').classList.add('hidden'); document.getElementById('members-modal').classList.remove('flex'); renderPayerRadios(); renderSplitMembersCheckboxes(); }
        window.renderMembersEditList = function() {
            const container = document.getElementById('members-edit-list');
            container.innerHTML = travelMembers.map((m, idx) => `<div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded p-2"><span class="text-sm font-bold text-gray-800">${m}</span><button onclick="removeMember(${idx})" class="text-red-400 hover:text-red-600"><i class="fas fa-times-circle"></i></button></div>`).join('');
        }
        window.addMember = function() { 
            const input = document.getElementById('new-member-name'); const val = input.value.trim(); 
            if(val && !travelMembers.includes(val)) { travelMembers.push(val); window.saveGlobalState({ travelMembers: travelMembers }); input.value = ''; renderMembersEditList(); } 
        }
        window.removeMember = function(idx) { travelMembers.splice(idx, 1); window.saveGlobalState({ travelMembers: travelMembers }); renderMembersEditList(); }

		window.renderPayerRadios = function() {
            const container = document.getElementById('payer-members-container');
            container.innerHTML = `<label class="inline-flex items-center bg-white/50 border border-[#fde047] px-2 py-1 rounded cursor-pointer hover:bg-white transition-all duration-75 active:scale-[0.85] active:brightness-95 select-none"><input type="radio" name="payer-radio" value="" onchange="selectedPayer = this.value" class="w-3 h-3 accent-gray-500 rounded-full mr-1.5" ${!selectedPayer ? 'checked' : ''}><span class="text-[11px] font-bold text-[#854d0e]">ç„¡(å„ä»˜å„)</span></label>` + 
            travelMembers.map(m => `<label class="inline-flex items-center bg-white/50 border border-[#fde047] px-2 py-1 rounded cursor-pointer hover:bg-white transition-all duration-75 active:scale-[0.85] active:brightness-95 select-none"><input type="radio" name="payer-radio" value="${m}" onchange="selectedPayer = this.value" class="w-3 h-3 accent-[#ca8a04] rounded-full mr-1.5" ${selectedPayer === m ? 'checked' : ''}><span class="text-[11px] font-bold text-[#854d0e]">${m}</span></label>`).join('');
        }

        window.toggleAllSplitMembers = function(cb) { if(cb.checked) { selectedSplitMembers = [...travelMembers]; } else { selectedSplitMembers = []; } renderSplitMembersCheckboxes(); };
        window.renderSplitMembersCheckboxes = function() {
            const container = document.getElementById('split-members-container');
            const allChecked = travelMembers.length > 0 && selectedSplitMembers.length === travelMembers.length;
            // ğŸ’¡ å…¨é¸æŒ‰éˆ•æ¯”è¼ƒå¤§é¡†ï¼Œç¸®å°åˆ° 95% è¦–è¦ºæœ€å‰›å¥½
            let html = `<label class="inline-flex items-center bg-white/80 border border-[#bae6fd] px-2 py-1.5 rounded cursor-pointer hover:bg-white transition-all duration-75 active:scale-[0.95] active:brightness-95 mb-2 w-full justify-center shadow-sm select-none"><input type="checkbox" onchange="toggleAllSplitMembers(this)" class="w-4 h-4 accent-[#0284c7] rounded mr-2" ${allChecked ? 'checked' : ''}><span class="text-[12px] font-bold text-[#0369a1]">å…¨é¸åˆ†æ”¤æˆå“¡</span></label><div class="w-full h-0"></div>`;
            // ğŸ’¡ å€‹äººæŒ‰éˆ•è·Ÿè¨ˆç®—æ©Ÿä¸€æ¨£ï¼Œç¸®å°åˆ° 85%
            html += travelMembers.map(m => `<label class="inline-flex items-center bg-white/50 border border-[#bae6fd] px-2 py-1 rounded cursor-pointer hover:bg-white transition-all duration-75 active:scale-[0.85] active:brightness-95 select-none"><input type="checkbox" value="${m}" onchange="toggleSplitMember(this)" class="w-3 h-3 accent-[#0284c7] rounded mr-1.5" ${selectedSplitMembers.includes(m) ? 'checked' : ''}><span class="text-[11px] font-bold text-[#0369a1]">${m}</span></label>`).join('');
            container.innerHTML = html;
        }
        window.toggleSplitMember = function(checkbox) { if(checkbox.checked) { if(!selectedSplitMembers.includes(checkbox.value)) selectedSplitMembers.push(checkbox.value); } else { selectedSplitMembers = selectedSplitMembers.filter(m => m !== checkbox.value); } renderSplitMembersCheckboxes(); }

// â˜… æ–°å¢ï¼šè² è²¬å°‡æ—¥æœŸç¿»è­¯æˆç¾è§€æ ¼å¼ (å«æ˜ŸæœŸå¹¾) çš„å°ç²¾éˆ
        window.updateDateTimeDisplay = function() {
            const dateVal = document.getElementById('exp-date').value;
            const timeVal = document.getElementById('exp-time-only').value;
            if (dateVal) {
                const d = new Date(dateVal);
                const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const displayDiv = document.getElementById('exp-date-display');
                if (displayDiv) displayDiv.innerText = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} (${days[d.getDay()]})`;
            }
            if (timeVal) {
                const timeDiv = document.getElementById('exp-time-display');
                if (timeDiv) timeDiv.innerText = timeVal;
            }
        };

        window.setCurrentTimeToInput = function() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const iso = now.toISOString();
            if(document.getElementById('exp-date')) document.getElementById('exp-date').value = iso.slice(0,10);
            if(document.getElementById('exp-time-only')) document.getElementById('exp-time-only').value = iso.slice(11,16);
            if(document.getElementById('exp-rate')) document.getElementById('exp-rate').value = document.getElementById('base-rate').value || 41; 
            if(window.updateDateTimeDisplay) updateDateTimeDisplay(); // è§¸ç™¼ç•«é¢æ›´æ–°
        }

        window.saveExpense = async function() {
            const title = document.getElementById('exp-name').value || 'æœªå‘½åæ¶ˆè²»';
            const category = document.getElementById('exp-category').value;
            const krw = parseFloat(document.getElementById('exp-krw').value) || 0; 
            const twd = parseFloat(document.getElementById('exp-twd').value) || 0;
            const rate = parseFloat(document.getElementById('exp-rate').value) || parseFloat(document.getElementById('base-rate').value) || 41;
            const payer = selectedPayer;
            const dateVal = document.getElementById('exp-date').value;
            const timeVal = document.getElementById('exp-time-only').value;
            
            if (krw === 0 && twd === 0) { showMsg('è«‹è¼¸å…¥æ¶ˆè²»é‡‘é¡'); return; }

            // çµ„åˆæ—¥æœŸèˆ‡æ™‚é–“
            let d = new Date();
            if (dateVal && timeVal) { d = new Date(`${dateVal}T${timeVal}`); }
            
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const timeStr = `${d.getMonth()+1}/${d.getDate()}(${days[d.getDay()]}) ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            const rawDate = d.getTime();

            const expData = { title, category, krw, twd, rate, payer, splitMembers: [...selectedSplitMembers], image: currentExpBase64, time: timeStr, rawDate: rawDate };

            let finalId = editingExpId || ('exp' + Date.now());
            const idx = expenses.findIndex(x => x.id === finalId);
            if (idx >= 0) expenses[idx] = { id: finalId, ...expData }; else expenses.push({ id: finalId, ...expData });
            
            expenses.sort((a,b) => {
                const dateA = a.rawDate || parseInt(a.id.replace('exp','')) || 0;
                const dateB = b.rawDate || parseInt(b.id.replace('exp','')) || 0;
                return dateB - dateA;
            });

            localStorage.setItem('korea_expenses_v3', JSON.stringify(expenses));
            renderExpenses();
            cancelEditExp();

            if (currentUser) {
                try {
                    const expRef = window.fsCollections.collection(db, 'artifacts', appId, 'public', 'data', 'expenses');
                    await window.fsCollections.setDoc(window.fsCollections.doc(expRef, finalId), expData, { merge: true });
                } catch(e) { console.log('èƒŒæ™¯åŒæ­¥å¤±æ•—ã€‚'); }
            }
        };

        window.editExpense = function(id) {
            const ex = expenses.find(x => x.id === id);
            if(!ex) return;
            editingExpId = id;
            document.getElementById('exp-form-title').innerText = 'ä¿®æ”¹è¨˜å¸³ç´€éŒ„';
            document.getElementById('exp-name').value = ex.title || '';
            document.getElementById('exp-category').value = ex.category || 'food';
            document.getElementById('exp-krw').value = ex.krw || '';
            document.getElementById('exp-twd').value = ex.twd || '';
            if(document.getElementById('exp-rate')) document.getElementById('exp-rate').value = ex.rate || '';
            selectedPayer = ex.payer || ''; renderPayerRadios();
            selectedSplitMembers = [...(ex.splitMembers || [])]; renderSplitMembersCheckboxes();

            if(ex.rawDate) {
                const d = new Date(ex.rawDate);
                d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                const iso = d.toISOString();
                if(document.getElementById('exp-date')) document.getElementById('exp-date').value = iso.slice(0,10);
                if(document.getElementById('exp-time-only')) document.getElementById('exp-time-only').value = iso.slice(11,16);
                if(window.updateDateTimeDisplay) updateDateTimeDisplay();
            }

            if (ex.image) { currentExpBase64 = ex.image; document.getElementById('exp-img-tag').src = currentExpBase64; document.getElementById('exp-photo-preview').classList.remove('hidden'); } 
            else { removeExpPhoto(); }
            document.getElementById('btn-save-exp').innerText = 'æ›´æ–°ç´€éŒ„';
            document.getElementById('btn-cancel-exp').classList.remove('hidden');
            document.getElementById('expense-form-area').scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        window.cancelEditExp = function() {
            editingExpId = null;
            document.getElementById('exp-form-title').innerText = 'æ–°å¢è¨˜å¸³ç´€éŒ„';
            document.getElementById('exp-name').value = '';
            document.getElementById('exp-category').value = 'food';
            document.getElementById('exp-krw').value = '';
            document.getElementById('exp-twd').value = '';
            if(document.getElementById('exp-rate')) document.getElementById('exp-rate').value = '';
            selectedPayer = ''; renderPayerRadios();
            selectedSplitMembers = []; renderSplitMembersCheckboxes();
            setCurrentTimeToInput();
            removeExpPhoto();
            document.getElementById('btn-save-exp').innerText = 'å„²å­˜è¨˜å¸³';
            document.getElementById('btn-cancel-exp').classList.add('hidden');
        };

        window.deleteExpense = function(id) { 
            showMsg('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜å¸³ç´€éŒ„å—ï¼Ÿ', true, async () => { 
                expenses = expenses.filter(x => x.id !== id);
                localStorage.setItem('korea_expenses_v3', JSON.stringify(expenses));
                renderExpenses();
                if(currentUser) {
                    try { await window.fsCollections.deleteDoc(window.fsCollections.doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id)); } 
                    catch(e) {}
                }
            });
        };
		window.renderExpenses = function() {
            const list = document.getElementById('expense-list');
            if(!list) return;
            const catMap = { food: {icon:'fa-utensils', c:'text-[#9a3412]', bg:'bg-[#ffedd5] border-[#fed7aa]'}, shop: {icon:'fa-shopping-bag', c:'text-[#0369a1]', bg:'bg-[#e0f2fe] border-[#bae6fd]'}, traffic: {icon:'fa-bus', c:'text-[#166534]', bg:'bg-[#dcfce7] border-[#bbf7d0]'}, ticket: {icon:'fa-ticket-alt', c:'text-[#9d174d]', bg:'bg-[#fce7f3] border-[#fbcfe8]'}, stay: {icon:'fa-bed', c:'text-[#581c87]', bg:'bg-[#f3e8ff] border-[#e9d5ff]'}, other: {icon:'fa-receipt', c:'text-[#374151]', bg:'bg-[#f3f4f6] border-[#e5e7eb]'} };
            
            list.innerHTML = expenses.map(ex => {
                const cat = catMap[ex.category] || catMap.other;
                let splitText = '';
                if (ex.splitMembers && ex.splitMembers.length > 0) {
                    let pKrw = Math.round(ex.krw / ex.splitMembers.length); let pTwd = Math.round(ex.twd / ex.splitMembers.length);
                    splitText = `<span class="bg-[#f0f9ff] px-1.5 py-0.5 rounded border border-[#bae6fd] whitespace-normal break-words leading-relaxed w-fit"><i class="fas fa-users text-[#0284c7] mr-1"></i>åˆ†æ”¤: ${ex.splitMembers.join(', ')} (æ¯äººâ‚©${pKrw.toLocaleString()} / NT$${pTwd.toLocaleString()})</span>`;
                }
                return `
                <div class="p-3 rounded-lg border border-gray-200 shadow-sm flex flex-col mb-3 transition-colors duration-300 bg-white">
                    <div class="flex items-start justify-between w-full">
                        <div class="flex items-start space-x-3 overflow-hidden flex-1">
                            ${ex.image ? `<img src="${ex.image}" onclick="openPhotoModal('${ex.image}')" class="w-12 h-12 object-cover rounded border border-gray-200 cursor-pointer shrink-0 shadow-sm">` : `<div class="w-12 h-12 ${cat.bg} rounded border flex items-center justify-center shrink-0 ${cat.c} shadow-sm"><i class="fas ${cat.icon} text-xl"></i></div>`}
                            <div class="truncate pr-2 w-full">
                                <p class="text-sm font-bold text-gray-900 truncate">${ex.title}</p>
                                <p class="text-[10px] font-bold text-gray-500">${ex.time} ${ex.rate ? `(åŒ¯ç‡ ${ex.rate})` : ''}</p>
                                ${ex.payer || splitText ? `<div class="mt-1.5 flex flex-col gap-1 text-[10px] text-muji-dark font-bold">${ex.payer ? `<span class="bg-[#fef9c3] px-1.5 py-0.5 rounded border border-[#fde047] w-fit"><i class="fas fa-user-check text-[#a16207] mr-1"></i>å¢Š: ${ex.payer}</span>` : ''}${splitText}</div>` : ''}
                            </div>
                        </div>
                        <div class="text-right shrink-0">
                            <p class="text-sm font-bold text-gray-900">â‚©${ex.krw.toLocaleString()}</p>
                            <p class="text-xs text-muji-accent font-bold">NT$${ex.twd.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-end space-x-2 mt-3 pt-2 border-t border-gray-100 w-full">
                        <button onclick="editExpense('${ex.id}')" class="text-[11px] text-gray-600 hover:text-[#0284c7] px-3 py-1 bg-gray-50 hover:bg-[#e0f2fe] border border-gray-200 rounded transition font-bold shadow-sm"><i class="fas fa-pen mr-1"></i> ä¿®æ”¹</button>
                        <button onclick="deleteExpense('${ex.id}')" class="text-[11px] text-[#e11d48] hover:text-[#be185d] px-3 py-1 bg-[#fff1f2] border border-[#fecdd3] rounded transition font-bold shadow-sm"><i class="fas fa-trash-alt mr-1"></i> åˆªé™¤</button>
                    </div>
                </div>`;
            }).join('');
        }
		
        // -----------------------------------------------------
        // â˜… å‚™å¿˜èˆ‡æ¸…å–® â˜…
        // -----------------------------------------------------
        window.renderChecklist = function() { 
            const c = document.getElementById('checklist-container');
            if(!c) return; 
            c.innerHTML = checklist.map((item, idx) => {
                if (editingChecklistIdx === idx) {
                    return `<div class="flex items-center space-x-2 bg-gray-50 p-1 rounded border border-gray-200"><input type="text" id="edit-check-${idx}" value="${item.text}" class="flex-1 text-sm font-bold p-1 bg-transparent outline-none text-gray-900 min-w-0"><button onclick="saveEditCheck(${idx})" class="text-[#14532d] font-bold p-1 bg-[#dcfce7] rounded shrink-0 transition px-2"><i class="fas fa-check"></i></button><button onclick="cancelEditCheck()" class="text-[#9d174d] font-bold p-1 bg-[#fce7f3] rounded shrink-0 transition px-2"><i class="fas fa-times"></i></button></div>`;
                }
                return `<div class="flex items-center justify-between text-sm font-bold text-gray-900 group"><label class="flex items-center space-x-3 overflow-hidden w-full pr-2 cursor-pointer"><input type="checkbox" ${item.checked?'checked':''} onchange="toggleCheck(${idx})" class="w-4 h-4 accent-[#9b89b3] shrink-0 cursor-pointer shadow-sm rounded-sm"> <span class="truncate transition-all duration-300 ease-in-out ${item.checked?'line-through text-gray-400 opacity-60 decoration-2':'text-gray-900'}">${item.text}</span></label><div class="flex space-x-2 shrink-0"><button onclick="startEditCheck(${idx})" class="text-gray-400 hover:text-[#0284c7] p-1 transition"><i class="fas fa-pen text-xs"></i></button><button onclick="deleteChecklistItem(${idx})" class="text-gray-400 hover:text-[#e11d48] p-1 transition"><i class="fas fa-trash-alt text-xs"></i></button></div></div>`;
            }).join(''); 
        }
        window.startEditCheck = function(idx) { editingChecklistIdx = idx; renderChecklist(); }
        window.cancelEditCheck = function() { editingChecklistIdx = -1; renderChecklist(); }
        window.saveEditCheck = function(idx) { 
            const val = document.getElementById(`edit-check-${idx}`).value;
            if (val) { checklist[idx].text = val; localStorage.setItem('korea_chk_2026_v7', JSON.stringify(checklist)); } 
            editingChecklistIdx = -1; renderChecklist(); 
        }
        window.toggleCheck = function(idx) { 
            checklist[idx].checked = !checklist[idx].checked; localStorage.setItem('korea_chk_2026_v7', JSON.stringify(checklist)); renderChecklist();
        }
        window.addChecklistItem = function() { 
            const i = document.getElementById('new-check-item');
            if(i.value) { checklist.push({text:i.value,checked:false}); localStorage.setItem('korea_chk_2026_v7', JSON.stringify(checklist)); i.value=''; renderChecklist(); } 
        }
        window.deleteChecklistItem = function(idx) { 
            checklist.splice(idx, 1); localStorage.setItem('korea_chk_2026_v7', JSON.stringify(checklist)); renderChecklist(); 
        }

        let memoList = [];
        window.renderMemoCards = function() {
            if (memoList.length === 0 && memo) { memoList = [{ id: 'm1', text: memo }]; }
            const container = document.getElementById('memo-cards-container');
            if(!container) return;
            if(memoList.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 text-xs py-5 font-bold bg-gray-50 rounded border border-dashed border-gray-200">ç›®å‰æ²’æœ‰å‚™å¿˜ç´€éŒ„ï¼Œé»æ“Šå³ä¸Šè§’æ–°å¢å§ï¼</div>';
                return;
            }
            container.innerHTML = memoList.map((m, idx) => {
                let textHtml = m.text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s\)]+)\)/g, '<br><a href="$2" target="_blank" class="text-[10px] font-bold text-[#0369a1] bg-[#e0f2fe] border border-[#bae6fd] px-2 py-1.5 rounded shadow-sm hover:bg-[#bae6fd] transition inline-block mt-1 mb-1"><i class="fas fa-link mr-1"></i>$1</a><br>');
                textHtml = textHtml.replace(/(?<!")https?:\/\/[^\s\)]+(?!")/g, match => `<br><a href="${match}" target="_blank" class="text-[10px] font-bold text-[#0369a1] bg-[#e0f2fe] border border-[#bae6fd] px-2 py-1.5 rounded shadow-sm hover:bg-[#bae6fd] transition inline-block mt-1 mb-1"><i class="fas fa-external-link-alt mr-1"></i>é–‹å•Ÿé€£çµ</a><br>`);
                textHtml = textHtml.replace(/<br>\s*<br>/g, '<br>');

                return `<div class="bg-white border border-gray-200 rounded p-3 shadow-sm relative group hover:border-gray-300 transition mb-3"><div class="absolute top-2 right-2 flex space-x-1"><button onclick="openMemoEditModal(${idx})" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-[#0369a1] bg-gray-50 hover:bg-gray-100 rounded border border-gray-200 transition"><i class="fas fa-pen text-[10px]"></i></button><button onclick="deleteMemoCard(${idx})" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-red-500 bg-gray-50 hover:bg-gray-100 rounded border border-gray-200 transition"><i class="fas fa-trash text-[10px]"></i></button></div><div class="text-[13px] font-bold text-gray-800 whitespace-pre-wrap leading-relaxed pr-16">${textHtml}</div></div>`;
            }).join('');
        }

        let editingMemoIdx = -1;
        window.openMemoEditModal = function(idx = -1) {
            editingMemoIdx = idx; document.getElementById('memo-edit-title').innerText = idx === -1 ? 'æ–°å¢å‚™å¿˜å¡ç‰‡' : 'ç·¨è¼¯å‚™å¿˜å…§å®¹';
            document.getElementById('memo-edit-input').value = idx === -1 ? '' : memoList[idx].text;
            document.getElementById('memo-edit-modal').classList.remove('hidden'); document.getElementById('memo-edit-modal').classList.add('flex');
        }
        window.closeMemoEditModal = function() { document.getElementById('memo-edit-modal').classList.add('hidden'); document.getElementById('memo-edit-modal').classList.remove('flex'); }
        window.saveMemoCard = function() {
            const val = document.getElementById('memo-edit-input').value;
            if(!val.trim()) return;
            if(editingMemoIdx === -1) memoList.push({ id: 'm'+Date.now(), text: val }); else memoList[editingMemoIdx].text = val;
            window.saveGlobalState({ memoList: memoList }); renderMemoCards(); closeMemoEditModal();
        }
        window.deleteMemoCard = function(idx) { showMsg('ç¢ºå®šè¦åˆªé™¤é€™å¼µå‚™å¿˜å¡ç‰‡å—ï¼Ÿ', true, () => { memoList.splice(idx, 1); window.saveGlobalState({ memoList: memoList }); renderMemoCards(); }); }            

        window.showTab = function(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(`tab-${id}`); if(target) target.classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('nav-active'));
            const btn = document.getElementById(`btn-${id}`); if(btn) btn.classList.add('nav-active');
            window.scrollTo(0,0); if(id === 'info') fetchWeather();
        }

        window.showMsg = function(text, isConfirm = false, onOk = null) {
            document.getElementById('msg-modal-text').innerText = text;
            const btns = document.getElementById('msg-modal-btns');
            btns.innerHTML = isConfirm 
                ? `<button onclick="closeMsg()" class="px-6 py-2 bg-gray-100 text-gray-700 rounded text-sm font-bold shadow-sm transition hover:bg-gray-200">å–æ¶ˆ</button><button id="msg-ok-btn" class="px-6 py-2 bg-gray-800 text-white rounded text-sm font-bold shadow-sm transition hover:bg-gray-900">ç¢ºå®š</button>` 
                : `<button onclick="closeMsg()" class="px-8 py-2 bg-gray-800 text-white rounded text-sm font-bold shadow-sm transition hover:bg-gray-900">æˆ‘çŸ¥é“äº†</button>`;
            if(isConfirm && onOk) { document.getElementById('msg-ok-btn').onclick = () => { onOk(); closeMsg(); }; }
            document.getElementById('msg-modal').classList.remove('hidden'); document.getElementById('msg-modal').classList.add('flex');
        }
        window.closeMsg = function() { document.getElementById('msg-modal').classList.add('hidden'); document.getElementById('msg-modal').classList.remove('flex'); }

// --- åˆ†å¸³çµç®—é‚è¼¯åŠŸèƒ½ ---
window.currentSettlementData = {};
window.currentTransfers = { global: [], p2p: [] }; 

window.openSettlementModal = function() {
    let balances = {};
    travelMembers.forEach(m => balances[m] = { paid: 0, shouldPay: 0, paidList: [], shouldPayList: [] });
    
    expenses.forEach(ex => {
        if (!ex.splitMembers || ex.splitMembers.length === 0) return;
        let totalAmount = ex.twd || 0; 
        let splitCount = ex.splitMembers.length;
        let splitAmount = totalAmount / splitCount;

        if (ex.payer && balances[ex.payer]) {
            balances[ex.payer].paid += totalAmount;
            // â˜… ä¿®å¾©ï¼šè£œä¸Š rawDateï¼Œè®“å ±è¡¨èƒ½æŠ“åˆ°æ­£ç¢ºæ™‚é–“èˆ‡æ’åº
            balances[ex.payer].paidList.push({ title: ex.title, amount: totalAmount, splitMembers: ex.splitMembers, time: ex.time, krw: ex.krw, rate: ex.rate, rawDate: ex.rawDate });
        }

        ex.splitMembers.forEach(m => {
            if (balances[m]) {
                balances[m].shouldPay += splitAmount;
                // â˜… ä¿®å¾©ï¼šè£œä¸Š rawDateï¼Œè®“å ±è¡¨èƒ½æŠ“åˆ°æ­£ç¢ºæ™‚é–“èˆ‡æ’åº
                balances[m].shouldPayList.push({ title: ex.title, amount: splitAmount, time: ex.time, krw: ex.krw, rate: ex.rate, rawDate: ex.rawDate });
            }
        });
    });
    
    window.currentSettlementData = balances;

    let creditors = []; let debtors = [];
    travelMembers.forEach(m => {
        let b = balances[m].paid - balances[m].shouldPay;
        if (b > 1) creditors.push({ name: m, amount: b }); else if (b < -1) debtors.push({ name: m, amount: Math.abs(b) });
    });
    creditors.sort((a, b) => b.amount - a.amount); debtors.sort((a, b) => b.amount - a.amount);
    
    let globalTransfers = [];
    let i = 0, j = 0;
    while (i < debtors.length && j < creditors.length) {
        let debt = debtors[i];
        let cred = creditors[j]; let amount = Math.min(debt.amount, cred.amount);
        if(amount > 0) globalTransfers.push({ from: debt.name, to: cred.name, amount: amount });
        debt.amount -= amount; cred.amount -= amount;
        if (debt.amount < 1) i++; if (cred.amount < 1) j++;
    }

    let owes = {};
    travelMembers.forEach(m => { owes[m] = {}; travelMembers.forEach(c => owes[m][c] = 0); });
    expenses.forEach(ex => {
        if (!ex.splitMembers || ex.splitMembers.length === 0 || !ex.payer) return;
        let splitAmount = (ex.twd || 0) / ex.splitMembers.length;
        ex.splitMembers.forEach(m => {
            if (m !== ex.payer && owes[m] && owes[m][ex.payer] !== undefined) { owes[m][ex.payer] += splitAmount; }
        });
    });
    
    let p2pTransfers = [];
    for (let x = 0; x < travelMembers.length; x++) {
        for (let y = x + 1; y < travelMembers.length; y++) {
            let m1 = travelMembers[x];
            let m2 = travelMembers[y];
            let m1OwesM2 = owes[m1][m2] || 0; let m2OwesM1 = owes[m2][m1] || 0;
            if (m1OwesM2 > m2OwesM1) {
                let net = m1OwesM2 - m2OwesM1;
                if (net > 0.5) p2pTransfers.push({ from: m1, to: m2, amount: net });
            } else if (m2OwesM1 > m1OwesM2) {
                let net = m2OwesM1 - m1OwesM2;
                if (net > 0.5) p2pTransfers.push({ from: m2, to: m1, amount: net });
            }
        }
    }

    window.currentTransfers = { global: globalTransfers, p2p: p2pTransfers };
    let html = '';
    travelMembers.forEach(m => {
        let data = balances[m];
        let finalBalance = data.paid - data.shouldPay; 
        let balanceColor = finalBalance >= 0 ? 'text-[#15803d]' : 'text-[#e11d48]';
        let balanceText = finalBalance >= 0 ? 'æ‡‰æ”¶å›' : 'éœ€æ”¯ä»˜'; 
        if(data.paid === 0 && data.shouldPay === 0) return;
        
        html += `
            <div onclick="showSettlementDetail('${m}')" class="p-3 bg-white border border-gray-200 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 transition mb-3">
                <div class="font-bold text-gray-800 border-b border-gray-100 pb-1 mb-2 text-base flex justify-between">
                    <span><i class="fas fa-user-circle text-gray-400 mr-1"></i> ${m}</span>
                    <span class="text-[10px] text-gray-400 font-normal mt-1"><i class="fas fa-search mr-1"></i>çœ‹æ˜ç´° / è½‰å¸³</span>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mb-1 font-bold">
                    <span>ç¸½ä»£å¢Š: NT$ ${Math.round(data.paid).toLocaleString()}</span>
                    <span>æ‡‰åˆ†æ”¤: NT$ ${Math.round(data.shouldPay).toLocaleString()}</span>
                </div>
                <div class="flex justify-between text-sm font-bold ${balanceColor} pt-1.5 border-t border-gray-100 mt-1">
                    <span>${balanceText}</span>
                    <span>NT$ ${Math.round(Math.abs(finalBalance)).toLocaleString()}</span>
                </div>
            </div>
        `;
    });

    if(html === '') html = '<div class="text-center text-gray-500 text-sm font-bold py-4">ç›®å‰é‚„æ²’æœ‰ä»»ä½•åˆ†å¸³ç´€éŒ„å–”ï¼</div>';
    document.getElementById('settlement-content').innerHTML = html;
    document.getElementById('settlement-modal').classList.remove('hidden'); 
    document.getElementById('settlement-modal').classList.add('flex');
}

window.getPaidForText = function(splitArr, payerName) {
    if (!splitArr || splitArr.length === 0) return 'æ‰€æœ‰äºº';
    if (splitArr.length === travelMembers.length) return 'æ‰€æœ‰äºº';
    let others = splitArr.filter(m => m !== payerName);
    if (others.length === 0) return 'è‡ªå·±';
    return others.join('ã€');
};

window.showSettlementDetail = function(memberName) {
    let data = window.currentSettlementData[memberName];
    if(!data) return;
    document.getElementById('detail-member-name').innerText = memberName + " çš„å¸³å‹™æ˜ç´°";

    const buildTransferHtml = (payArr, recvArr) => {
        let tHtml = '';
        if (payArr.length > 0) tHtml += payArr.map(t => `<div class="flex justify-between items-center text-sm py-1.5 border-b border-gray-200/50 last:border-0"><span class="font-bold text-gray-700"><i class="fas fa-arrow-right text-[#e11d48] mr-2"></i>è½‰çµ¦ <span class="text-gray-900">${t.to}</span></span><span class="font-bold text-[#e11d48]">NT$ ${Math.round(t.amount).toLocaleString()}</span></div>`).join('');
        if (recvArr.length > 0) tHtml += recvArr.map(t => `<div class="flex justify-between items-center text-sm py-1.5 border-b border-gray-200/50 last:border-0"><span class="font-bold text-gray-700"><i class="fas fa-arrow-left text-[#15803d] mr-2"></i>å‘ <span class="text-gray-900">${t.from}</span> æ”¶</span><span class="font-bold text-[#15803d]">NT$ ${Math.round(t.amount).toLocaleString()}</span></div>`).join('');
        if (tHtml === '') tHtml = '<div class="text-xs text-gray-500 font-bold py-1.5 text-center">ğŸ‰ ç„¡é ˆè½‰å¸³</div>';
        return tHtml;
    };

    let globalHtml = buildTransferHtml(window.currentTransfers.global.filter(t => t.from === memberName), window.currentTransfers.global.filter(t => t.to === memberName));
    let p2pHtml = buildTransferHtml(window.currentTransfers.p2p.filter(t => t.from === memberName), window.currentTransfers.p2p.filter(t => t.to === memberName));

    let finalTransferHtml = `
        <div class="mb-3 shadow-sm rounded">
            <div class="text-[11px] font-bold text-white bg-gray-800 px-2 py-1.5 rounded-t flex items-center justify-between"><span><i class="fas fa-bolt mr-1 text-yellow-400"></i>æœ€ç°¡è½‰å¸³æ³• (æ¨è–¦ç…§è‘—åŒ¯)</span><span class="text-[9px] font-normal opacity-70">å…¨å±€å¤§æŠµéŠ·</span></div>
            <div class="bg-gray-50 border-x border-b border-gray-300 rounded-b p-2">${globalHtml}</div>
        </div>
        <div class="mb-2 rounded">
            <div class="text-[11px] font-bold text-gray-600 bg-gray-200 px-2 py-1.5 rounded-t flex items-center justify-between"><span><i class="fas fa-search mr-1"></i>ä¸€å°ä¸€å¸³ç›®æ ¸å°</span><span class="text-[9px] font-normal opacity-70">ä¸€å°ä¸€æŠµéŠ·</span></div>
            <div class="bg-white border-x border-b border-gray-200 rounded-b p-2">${p2pHtml}</div>
        </div>
    `;

    let transferContainer = document.getElementById('detail-transfer-list');
    if (transferContainer) transferContainer.innerHTML = finalTransferHtml;

    // â˜… ä¿®å¾©æ˜ç´°æ’åº (ç”±èˆŠåˆ°æ–°)
    let sortedPaid = [...data.paidList].sort((a, b) => (a.rawDate || 0) - (b.rawDate || 0));
    let sortedShouldPay = [...data.shouldPayList].sort((a, b) => (a.rawDate || 0) - (b.rawDate || 0));

    let paidHtml = sortedPaid.map(item => {
        let paidFor = window.getPaidForText(item.splitMembers, memberName);
        return `<div class="flex justify-between items-center text-xs py-1.5 border-b border-gray-100 last:border-0"><span class="truncate text-gray-700 w-2/3">${item.title} <span class="text-[10px] text-gray-400 font-normal">(å¹« ${paidFor} ä»˜)</span></span><span class="font-bold text-[#15803d]">+ $${Math.round(item.amount).toLocaleString()}</span></div>`;
    }).join('');
    if(!paidHtml) paidHtml = '<div class="text-xs text-gray-400 py-1">ç„¡ä»£å¢Šç´€éŒ„</div>';

    let payHtml = sortedShouldPay.map(item => `<div class="flex justify-between text-xs py-1.5 border-b border-gray-100 last:border-0"><span class="truncate text-gray-700 w-2/3">${item.title}</span><span class="font-bold text-[#e11d48]">- $${Math.round(item.amount).toLocaleString()}</span></div>`).join('');
    if(!payHtml) payHtml = '<div class="text-xs text-gray-400 py-1">ç„¡åˆ†æ”¤ç´€éŒ„</div>';

    document.getElementById('detail-paid-list').innerHTML = paidHtml;
    document.getElementById('detail-shouldpay-list').innerHTML = payHtml;
    document.getElementById('settlement-detail-modal').classList.remove('hidden'); document.getElementById('settlement-detail-modal').classList.add('flex');
}

window.closeSettlementDetail = function() { 
    document.getElementById('settlement-detail-modal').classList.add('hidden');
    document.getElementById('settlement-detail-modal').classList.remove('flex'); 
}
window.closeSettlementModal = function() { 
    document.getElementById('settlement-modal').classList.add('hidden'); 
    document.getElementById('settlement-modal').classList.remove('flex'); 
}

// â˜… çµ‚æ¥µç‰ˆï¼šæ”¯æ´å½©è‰²ã€å¯¬åº¦è‡ªé©æ‡‰ã€æ¼æ–—ç¯©é¸èˆ‡ä¸€å°ä¸€è©³ç´°æ˜ç´°çš„ Excel
window.exportSettlementCSV = function() {
    if (typeof XLSX === 'undefined') { showMsg('è¼‰å…¥ Excel æ¨¡çµ„ä¸­ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šã€‚'); return; }
    let wb = XLSX.utils.book_new();

    const getFullTime = (rawDate) => {
        const d = new Date(rawDate || Date.now());
        const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}(${days[d.getDay()]}) ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    };

    const bStyle = { 
        top: { style: "thin", color: { rgb: "BDC3C7" } }, bottom: { style: "thin", color: { rgb: "BDC3C7" } }, 
        left: { style: "thin", color: { rgb: "BDC3C7" } }, right: { style: "thin", color: { rgb: "BDC3C7" } } 
    };

    const HeadCell = (v) => ({ v, t: 's', s: { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "4B5563" } }, alignment: { vertical: "center", horizontal: "center" }, border: bStyle } });
    const TextCell = (v, bg="FFFFFF", wrap=false) => ({ v: v || '', t: 's', s: { fill: { fgColor: { rgb: bg } }, alignment: { vertical: "center", horizontal: "center", wrapText: wrap }, border: bStyle } });
    const NumCell = (v, bg="FFFFFF") => ({ v: v || 0, t: 'n', s: { fill: { fgColor: { rgb: bg } }, alignment: { vertical: "center", horizontal: "center" }, border: bStyle } });
    const KRWCell = (v, bg="FFFFFF") => ({ v: v || 0, t: 'n', z: '"â‚©"#,##0', s: { fill: { fgColor: { rgb: bg } }, alignment: { vertical: "center", horizontal: "center" }, border: bStyle } });
    const TWDCell = (v, bg="FFFFFF") => ({ v: v || 0, t: 'n', z: '"NT$"#,##0', s: { fill: { fgColor: { rgb: bg } }, alignment: { vertical: "center", horizontal: "center" }, border: bStyle } });
    const GreenCell = (v, bg="FFFFFF") => ({ v: v || 0, t: 'n', z: '"NT$"#,##0', s: { fill: { fgColor: { rgb: bg } }, font: { color: { rgb: "15803D" }, bold: true }, alignment: { vertical: "center", horizontal: "center" }, border: bStyle } });
    const RedCell = (v, bg="FFFFFF") => ({ v: v || 0, t: 'n', z: '"NT$"#,##0', s: { fill: { fgColor: { rgb: bg } }, font: { color: { rgb: "B91C1C" }, bold: true }, alignment: { vertical: "center", horizontal: "center" }, border: bStyle } });
    const CatCell = (v, bg="FFFFFF") => { let cMap={food:'ğŸ½ï¸ ç”¨é¤',shop:'ğŸ›ï¸ è³¼ç‰©',traffic:'ğŸšŒ äº¤é€š',ticket:'ğŸ« é–€ç¥¨',stay:'ğŸ›ï¸ ä½å®¿',other:'ğŸ§¾ å…¶ä»–'}; return TextCell(cMap[v]||'ğŸ§¾ å…¶ä»–', bg); };

    const applySmartFormat = (ws, dataArr, specialRowHeight = {}, disableFilter = false) => {
        if (!ws['!ref']) return;
        let headerRow = dataArr.find(row => row && row.some(cell => cell && typeof cell.v === 'string' && (cell.v.includes("æ—¥æœŸ/æ™‚é–“") || cell.v.includes("åŒ¯ç‡") || cell.v.includes("ç•¶æ—¥ç¸½ä»£å¢Š")))) || dataArr[0];
        let numCols = headerRow.length;
        if (!disableFilter) { ws['!autofilter'] = { ref: `A1:${XLSX.utils.encode_col(numCols-1)}${dataArr.length}` }; }
        ws['!rows'] = dataArr.map((_, i) => ({ hpt: specialRowHeight[i] || 25 }));
        
        let colWidths = headerRow.map(cell => {
            let name = cell.v || '';
            if (name === "æ—¥æœŸ/æ™‚é–“") return { wch: 21.5 }; 
            if (name === "åˆ†æ”¤æˆå“¡") return { wch: 51.7 }; 
            if (name === "æœ€ç°¡è½‰å¸³å‹•ä½œ") return { wch: 19 }; 
            if (["ç•¶æ—¥ç¸½ä»£å¢Š", "ç•¶æ—¥ç¸½æ‡‰åˆ†æ”¤", "ç•¶æ—¥çµé¤˜", "æœ€çµ‚ç¸½çµé¤˜"].includes(name)) return { wch: 14 }; 
            if (name.includes("éŸ“å¹£é‡‘é¡") || name.includes("å°å¹£é‡‘é¡") || name.includes("ä»£å¢Šé‡‘é¡")) return { wch: 12 };
            if (name.includes("åŒ¯ç‡")) return { wch: 7 };
            if (name.includes("æ¶ˆè²»é¡åˆ¥")) return { wch: 9.5 };
            if (name === "æˆå“¡" || name === "ä»£å¢Šäºº") return { wch: 7.5 };
            if (name.includes("NT$çµé¤˜")) return { wch: 14 };
            if (name.includes("å¸³å‹™æ˜ç´°")) return { wch: 12 };
            if (name.includes("æ¶ˆè²»åç¨±")) return { wch: 18 };
            if (name.includes("è¨ˆç®—å…¬å¼")) return { wch: 15 };
            return { wch: 12 }; 
        });
        ws['!cols'] = colWidths;
    };

    let sortedExpenses = [...expenses].sort((a, b) => (a.rawDate || 0) - (b.rawDate || 0));

    // --- ç¬¬ä¸€é  [1.æ­·å²æ¶ˆè²»ç¸½è¡¨] ---
    let ws1_data = [[HeadCell("æ—¥æœŸ/æ™‚é–“"), HeadCell("æ¶ˆè²»é¡åˆ¥"), HeadCell("æ¶ˆè²»åç¨±"), HeadCell("åŒ¯ç‡"), HeadCell("éŸ“å¹£é‡‘é¡"), HeadCell("å°å¹£é‡‘é¡"), HeadCell("ä»£å¢Šäºº"), HeadCell("åˆ†æ”¤æˆå“¡")]];
    sortedExpenses.forEach(ex => {
        let split = ex.splitMembers && ex.splitMembers.length > 0 ? ex.splitMembers.join('ã€') : 'ç„¡';
        ws1_data.push([TextCell(getFullTime(ex.rawDate)), CatCell(ex.category), TextCell(ex.title), NumCell(ex.rate || 41), KRWCell(ex.krw), TWDCell(ex.twd), TextCell(ex.payer || 'å„ä»˜å„'), TextCell(split)]);
    });
    let ws1 = XLSX.utils.aoa_to_sheet(ws1_data); applySmartFormat(ws1, ws1_data); XLSX.utils.book_append_sheet(wb, ws1, "1.æ­·å²æ¶ˆè²»ç¸½è¡¨");

    // --- ç¬¬äºŒé  [2.å€‹äººå¸³å‹™æ˜ç´°] ---
    let ws2_data = [];
    let ws2_merges = []; 
    
    travelMembers.forEach((m) => {
        let mBg = "FFFFFF"; 
        let data = window.currentSettlementData[m];
        if (!data || (data.paidList.length === 0 && data.shouldPayList.length === 0)) return;

        if (ws2_data.length > 0) { ws2_data.push([]); }

        let titleRowIdx = ws2_data.length;
        // â˜… é€™è£¡åº•è‰²æ”¹æˆ E0F2FEï¼Œå­—é«”æ”¹æˆ 0369A1 â˜…
        ws2_data.push([
            { v: `ğŸ‘¤ ${m} çš„å°ˆå±¬å¸³å‹™æ˜ç´°`, t: 's', s: { font: { bold: true, color: { rgb: "0369A1" }, sz: 12 }, fill: { fgColor: { rgb: "E0F2FE" } }, alignment: { vertical: "center", horizontal: "center" }, border: bStyle } },
            TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE")
        ]);
        ws2_merges.push({ s: { r: titleRowIdx, c: 0 }, e: { r: titleRowIdx, c: 7 } }); 

        ws2_data.push([HeadCell("æˆå“¡"), HeadCell("æ—¥æœŸ/æ™‚é–“"), HeadCell("æ¶ˆè²»é¡åˆ¥"), HeadCell("æ¶ˆè²»åç¨±"), HeadCell("åŒ¯ç‡"), HeadCell("éŸ“å¹£é‡‘é¡"), HeadCell("å°å¹£é‡‘é¡"), HeadCell("NT$çµé¤˜")]);

        let mPaid = 0; let mShouldPay = 0;
        let combinedList = [];
        data.paidList.forEach(item => combinedList.push({ type: 'paid', ...item }));
        data.shouldPayList.forEach(item => combinedList.push({ type: 'shouldPay', ...item }));
        combinedList.sort((a, b) => (a.rawDate || 0) - (b.rawDate || 0));

        combinedList.forEach(item => {
            if (item.type === 'paid') {
                mPaid += item.amount;
                ws2_data.push([TextCell(m, mBg), TextCell(getFullTime(item.rawDate), mBg), CatCell(item.category, mBg), TextCell(`[ä»£å¢Š] ${item.title}`, mBg), NumCell(item.rate, mBg), KRWCell(item.krw, mBg), TWDCell(item.amount, mBg), GreenCell(item.amount, mBg)]);
            } else {
                mShouldPay += item.amount;
                ws2_data.push([TextCell(m, mBg), TextCell(getFullTime(item.rawDate), mBg), CatCell(item.category, mBg), TextCell(`[åˆ†æ”¤] ${item.title}`, mBg), NumCell(item.rate, mBg), KRWCell(item.krw, mBg), TWDCell(item.amount, mBg), RedCell(-item.amount, mBg)]);
            }
        });

        let balance = mPaid - mShouldPay;
        let subtotalRowIdx = ws2_data.length;
        ws2_data.push([
            { v: `ğŸ’° ${m} çµç®—ç¸½è¨ˆ`, t: 's', s: { font: { bold: true, color: { rgb: "374151" } }, fill: { fgColor: { rgb: "FEF9C3" } }, alignment: { vertical: "center", horizontal: "right" }, border: bStyle } },
            TextCell("","FEF9C3"), TextCell("","FEF9C3"), TextCell("","FEF9C3"), TextCell("","FEF9C3"), TextCell("","FEF9C3"), TextCell("","FEF9C3"),
            balance > 0 ? GreenCell(balance, "FEF9C3") : (balance < 0 ? RedCell(balance, "FEF9C3") : TWDCell(0, "FEF9C3"))
        ]);
        ws2_merges.push({ s: { r: subtotalRowIdx, c: 0 }, e: { r: subtotalRowIdx, c: 6 } });
    });
    
    let ws2 = XLSX.utils.aoa_to_sheet(ws2_data); 
    if (ws2_merges.length > 0) ws2['!merges'] = ws2_merges; 
    applySmartFormat(ws2, ws2_data, {}, true); 
    XLSX.utils.book_append_sheet(wb, ws2, "2.å€‹äººå¸³å‹™æ˜ç´°");

    // --- ç¬¬ä¸‰é  [3.æœ€ç°¡è½‰å¸³æ³•] ---
    let ws3_data = [];
    let ws3_merges = [];
    let ws3_heights = {};
    const getJustDate = (rawDate) => { const d = new Date(rawDate || Date.now()); const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']; return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}(${days[d.getDay()]})`; };

    travelMembers.forEach(m => {
        let data = window.currentSettlementData[m];
        if (!data || (data.paidList.length === 0 && data.shouldPayList.length === 0)) return;
        
        if (ws3_data.length > 0) ws3_data.push([]);

        let titleRowIdx = ws3_data.length;
        // â˜… é€™è£¡åº•è‰²æ”¹æˆ E0F2FEï¼Œå­—é«”æ”¹æˆ 0369A1 â˜…
        ws3_data.push([
            { v: `ğŸ‘¤ ${m} çš„æœ€ç°¡è½‰å¸³æ³• (æ¯æ—¥çµç®—æ˜ç´°)`, t: 's', s: { font: { bold: true, color: { rgb: "0369A1" }, sz: 12 }, fill: { fgColor: { rgb: "E0F2FE" } }, alignment: { vertical: "center", horizontal: "center" }, border: bStyle } },
            TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE")
        ]);
        ws3_merges.push({ s: { r: titleRowIdx, c: 0 }, e: { r: titleRowIdx, c: 6 } });

        ws3_data.push([HeadCell("æˆå“¡"), HeadCell("æ—¥æœŸ/æ™‚é–“"), HeadCell("ç•¶æ—¥ç¸½ä»£å¢Š"), HeadCell("ç•¶æ—¥ç¸½æ‡‰åˆ†æ”¤"), HeadCell("ç•¶æ—¥çµé¤˜"), HeadCell("æœ€çµ‚ç¸½çµé¤˜"), HeadCell("æœ€ç°¡è½‰å¸³å‹•ä½œ")]);

        let dailyStats = {};
        data.paidList.forEach(item => { let date = getJustDate(item.rawDate); if(!dailyStats[date]) dailyStats[date] = { paid: 0, share: 0 }; dailyStats[date].paid += item.amount; });
        data.shouldPayList.forEach(item => { let date = getJustDate(item.rawDate); if(!dailyStats[date]) dailyStats[date] = { paid: 0, share: 0 }; dailyStats[date].share += item.amount; });

        let balance = data.paid - data.shouldPay;
        let transfers = [];
        window.currentTransfers.global.filter(t => t.from === m).forEach(t => transfers.push(`è½‰çµ¦ ${t.to} $${Math.round(t.amount).toLocaleString()}`));
        window.currentTransfers.global.filter(t => t.to === m).forEach(t => transfers.push(`å‘ ${t.from} æ”¶ $${Math.round(t.amount).toLocaleString()}`));
        let transferStr = transfers.length > 0 ? transfers.join('\n') : 'ğŸ‰ çµæ¸…'; 
        
        let isFirstRow = true;
        Object.keys(dailyStats).sort().forEach(dateStr => {
            let dStat = dailyStats[dateStr];
            let dBal = dStat.paid - dStat.share;
            
            if (isFirstRow) {
                if(transfers.length > 1) ws3_heights[ws3_data.length] = transfers.length * 20;
                ws3_data.push([ TextCell(m), TextCell(dateStr), TWDCell(dStat.paid), TWDCell(dStat.share), dBal > 0 ? GreenCell(dBal) : (dBal < 0 ? RedCell(dBal) : TWDCell(0)), balance > 0 ? GreenCell(balance) : (balance < 0 ? RedCell(balance) : TWDCell(0)), TextCell(transferStr, "FFFFFF", true) ]);
                isFirstRow = false;
            } else {
                ws3_data.push([ TextCell(m), TextCell(dateStr), TWDCell(dStat.paid), TWDCell(dStat.share), dBal > 0 ? GreenCell(dBal) : (dBal < 0 ? RedCell(dBal) : TWDCell(0)), TextCell(""), TextCell("") ]);
            }
        });

        let subtotalRowIdx = ws3_data.length;
        ws3_data.push([
            { v: `ğŸ’° ${m} çµç®—ç¸½è¨ˆ`, t: 's', s: { font: { bold: true, color: { rgb: "374151" } }, fill: { fgColor: { rgb: "FEF9C3" } }, alignment: { vertical: "center", horizontal: "right" }, border: bStyle } },
            TextCell("","FEF9C3"), TWDCell(data.paid, "FEF9C3"), TWDCell(data.shouldPay, "FEF9C3"), TextCell("","FEF9C3"), balance > 0 ? GreenCell(balance, "FEF9C3") : (balance < 0 ? RedCell(balance, "FEF9C3") : TWDCell(0, "FEF9C3")), TextCell("","FEF9C3")
        ]);
        ws3_merges.push({ s: { r: subtotalRowIdx, c: 0 }, e: { r: subtotalRowIdx, c: 1 } });
    });
    
    let ws3 = XLSX.utils.aoa_to_sheet(ws3_data); 
    if (ws3_merges.length > 0) ws3['!merges'] = ws3_merges;
    applySmartFormat(ws3, ws3_data, ws3_heights, true); 
    XLSX.utils.book_append_sheet(wb, ws3, "3.æœ€ç°¡è½‰å¸³æ³•");
	
    // --- ç¬¬å››é  [4.ä¸€å°ä¸€å¸³ç›®æ ¸å°] ---
    let ws4_data = [];
    let ws4_merges = [];

    travelMembers.forEach((m) => {
        let mExpenses = [];
        sortedExpenses.forEach(ex => { 
            if (!ex.splitMembers || ex.splitMembers.length === 0) return;
            let splitCount = ex.splitMembers.length;
            let splitAmt = ex.twd / splitCount;
            let formulaStr = `${Math.round(ex.twd)}/${splitCount}=${Math.round(splitAmt)}/äºº`;
            if (ex.payer === m) {
                let validSplits = ex.splitMembers.filter(sm => sm !== m);
                validSplits.forEach(sm => { mExpenses.push({ time: getFullTime(ex.rawDate), cat: ex.category, title: ex.title, rate: ex.rate, krw: ex.krw, twd: ex.twd, payer: m, desc: `å¹«${sm}ä»˜`, amt: splitAmt, form: formulaStr }); });
            } else if (ex.splitMembers.includes(m) && ex.payer) {
                mExpenses.push({ time: getFullTime(ex.rawDate), cat: ex.category, title: ex.title, rate: ex.rate, krw: ex.krw, twd: ex.twd, payer: ex.payer, desc: `ç”±${ex.payer}ä»£å¢Š`, amt: -splitAmt, form: formulaStr });
            }
        });

        if (mExpenses.length === 0) return;
        if (ws4_data.length > 0) ws4_data.push([]);

        let titleRowIdx = ws4_data.length;
        // â˜… é€™è£¡åº•è‰²æ”¹æˆ E0F2FEï¼Œå­—é«”æ”¹æˆ 0369A1 â˜…
        ws4_data.push([
            { v: `ğŸ‘¤ ${m} çš„ä¸€å°ä¸€å¸³ç›®æ ¸å°`, t: 's', s: { font: { bold: true, color: { rgb: "0369A1" }, sz: 12 }, fill: { fgColor: { rgb: "E0F2FE" } }, alignment: { vertical: "center", horizontal: "center" }, border: bStyle } },
            TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE"), TextCell("","E0F2FE")
        ]);
        ws4_merges.push({ s: { r: titleRowIdx, c: 0 }, e: { r: titleRowIdx, c: 9 } });

        ws4_data.push([HeadCell("æ—¥æœŸ/æ™‚é–“"), HeadCell("æ¶ˆè²»é¡åˆ¥"), HeadCell("æ¶ˆè²»åç¨±"), HeadCell("åŒ¯ç‡"), HeadCell("éŸ“å¹£é‡‘é¡"), HeadCell("å°å¹£é‡‘é¡"), HeadCell("ä»£å¢Šäºº"), HeadCell("å¸³å‹™æ˜ç´°"), HeadCell("ä»£å¢Šé‡‘é¡"), HeadCell("è¨ˆç®—å…¬å¼")]);

        let mTotal = 0;
        mExpenses.forEach(item => {
            mTotal += item.amt;
            ws4_data.push([ TextCell(item.time), CatCell(item.cat), TextCell(item.title), NumCell(item.rate || 41), KRWCell(item.krw), TWDCell(item.twd), TextCell(item.payer), TextCell(item.desc), item.amt > 0 ? GreenCell(item.amt) : RedCell(item.amt), TextCell(item.form) ]);
        });

        let subtotalRowIdx = ws4_data.length;
        ws4_data.push([
            { v: `ğŸ’° ${m} çµç®—ç¸½è¨ˆ`, t: 's', s: { font: { bold: true, color: { rgb: "374151" } }, fill: { fgColor: { rgb: "FEF9C3" } }, alignment: { vertical: "center", horizontal: "right" }, border: bStyle } },
            TextCell("","FEF9C3"), TextCell("","FEF9C3"), TextCell("","FEF9C3"), TextCell("","FEF9C3"), TextCell("","FEF9C3"), TextCell("","FEF9C3"), TextCell("","FEF9C3"),
            mTotal > 0 ? GreenCell(mTotal, "FEF9C3") : (mTotal < 0 ? RedCell(mTotal, "FEF9C3") : TWDCell(0, "FEF9C3")), TextCell("","FEF9C3")
        ]);
        ws4_merges.push({ s: { r: subtotalRowIdx, c: 0 }, e: { r: subtotalRowIdx, c: 7 } });
    });

    let ws4 = XLSX.utils.aoa_to_sheet(ws4_data); 
    if (ws4_merges.length > 0) ws4['!merges'] = ws4_merges;
    applySmartFormat(ws4, ws4_data, {}, true); 
    XLSX.utils.book_append_sheet(wb, ws4, "4.ä¸€å°ä¸€å¸³ç›®æ ¸å°");

    XLSX.writeFile(wb, `éŸ“åœ‹æ—…éŠçµ‚æ¥µå°å¸³è¡¨_${new Date().toISOString().slice(0,10)}.xlsx`);
}

		// ==========================================
        // â˜ï¸ é›²ç«¯åŒæ­¥æ ¸å¿ƒé‚è¼¯ (ä½¿ç”¨ç¾æœ‰ ES Module ç’°å¢ƒ)
        // ==========================================
        
        // ã€åŠŸèƒ½Aã€‘ä¸Šå‚³è¨­å®šåˆ°é›²ç«¯
        window.uploadSettingsToCloud = async function(members, baseRate) {
            // æª¢æŸ¥ç¾æœ‰ç’°å¢ƒæ˜¯å¦å·²ç¶“é€£ä¸Š Firebase
            if (!window.db || !window.fsCollections) {
                console.log("å°šæœªé€£ç·š Firebaseï¼Œç¶­æŒå–®æ©Ÿæ¨¡å¼å„²å­˜ã€‚");
                return;
            }
            try {
                // ä½¿ç”¨ä½ ç¾æœ‰çš„è³‡æ–™åº«è·¯å¾‘çµæ§‹
                const settingsRef = window.fsCollections.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'settings');
                await window.fsCollections.setDoc(settingsRef, {
                    members: members,
                    baseRate: baseRate,
                    lastUpdated: Date.now()
                }, { merge: true });
                console.log("â˜ï¸ è¨­å®šå·²æˆåŠŸå‚™ä»½åˆ°é›²ç«¯ï¼");
            } catch (error) {
                console.log("é›²ç«¯ä¸Šå‚³å¤±æ•—ï¼Œå¯èƒ½æ¬Šé™ä¸è¶³:", error);
            }
        };

        // ã€åŠŸèƒ½Bã€‘æœ‹å‹æ‰“é–‹ç¶²é æ™‚ï¼Œå¾é›²ç«¯ä¸‹è¼‰æœ€æ–°è¨­å®š
        window.downloadSettingsFromCloud = async function() {
            if (!window.db || !window.fsCollections) return;
            try {
                const settingsRef = window.fsCollections.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'settings');
                const docSnap = await window.fsCollections.getDoc(settingsRef);
                
                if (docSnap && docSnap.exists && docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // 1. åŒæ­¥åå–®
                    if(data.members && Array.isArray(data.members)) {
                        window.settingMembers = data.members;
                        localStorage.setItem('korea_members_v1', JSON.stringify(data.members));
                        
                        // å¼·åˆ¶è¦†å¯«ç³»çµ±æ­£åœ¨ä½¿ç”¨çš„åå–®
                        if (typeof travelMembers !== 'undefined') {
                            travelMembers.length = 0;
                            data.members.forEach(m => travelMembers.push(m));
                        }
                    }
                    
                    // 2. åŒæ­¥åŒ¯ç‡
                    if(data.baseRate) {
                        if(document.getElementById('base-rate')) document.getElementById('base-rate').value = data.baseRate;
                        localStorage.setItem('korea_base_rate', data.baseRate);
                    }
                    
                    // 3. é‡æ–°æ¸²æŸ“ç•«é¢
                    if(typeof renderPayerRadios === 'function') renderPayerRadios();
                    if(typeof renderSplitMembersCheckboxes === 'function') renderSplitMembersCheckboxes();
                    
                    console.log("â˜ï¸ å·²æˆåŠŸå¾é›²ç«¯ä¸‹è¼‰æœ€æ–°åå–®èˆ‡è¨­å®šï¼");
                }
            } catch (error) {
                console.log("é›²ç«¯ä¸‹è¼‰å¤±æ•—:", error);
            }
        };

        // ç¶²é è¼‰å…¥å®Œæˆå¾Œ 1.5 ç§’ï¼Œè‡ªå‹•å»é›²ç«¯æŠ“å–æœ€æ–°è³‡æ–™ (é¿å…æ“‹åˆ°åŸæœ¬çš„è¼‰å…¥)
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if(typeof downloadSettingsFromCloud === 'function') downloadSettingsFromCloud();
            }, 1500); 
        });
		
		// ==========================================
        // â˜… è¦–è¦ºåŒ–è¨­å®šä¸­å¿ƒé‚è¼¯ (çµ‚æ¥µé€£å‹•ç‰ˆ) â˜…
        // ==========================================
        
        // ç¢ºä¿æˆ‘å€‘æ“ä½œçš„æ˜¯ç¨ç«‹çš„è¨­å®šé™£åˆ—
        window.settingMembers = JSON.parse(localStorage.getItem('korea_members_v1')) || ['ç‘‹ç³', 'é‡‘å³°', 'å† ä¼¶', 'è±«é™½', 'å®¶èŒµ'];
        
        // å•Ÿå‹•æ™‚è‡ªå‹•æŠŠè¨˜æ†¶é«”è£¡çš„åå–®ï¼ŒåŒæ­¥çµ¦ç³»çµ±
        setTimeout(() => {
            if (typeof travelMembers !== 'undefined' && Array.isArray(travelMembers)) {
                travelMembers.length = 0; // æ¸…ç©ºç³»çµ±èˆŠåå–®
                window.settingMembers.forEach(m => travelMembers.push(m)); // å¡å…¥æœ€æ–°åå–®
                if(typeof renderPayerRadios === 'function') renderPayerRadios();
                if(typeof renderSplitMembersCheckboxes === 'function') renderSplitMembersCheckboxes();
            }
        }, 500);

        window.openSettings = function() {
            document.getElementById('setting-base-rate').value = document.getElementById('base-rate') ? document.getElementById('base-rate').value : 41;
            renderSettingsMembers();
            document.getElementById('settings-modal').classList.remove('hidden');
        };

        window.closeSettings = function() {
            document.getElementById('settings-modal').classList.add('hidden');
        };

        window.renderSettingsMembers = function() {
            const container = document.getElementById('settings-members-list');
            if(!container) return;
            container.innerHTML = '';
            window.settingMembers.forEach((m, idx) => {
                container.innerHTML += `
                    <div class="flex justify-between items-center bg-white border border-gray-200 px-3 py-2 mb-2 rounded-lg shadow-sm">
                        <span class="font-bold text-gray-700 text-sm"><i class="fas fa-user text-gray-400 mr-2 text-xs"></i>${m}</span>
                        <button onclick="removeMember(${idx})" class="text-red-500 hover:text-white hover:bg-red-500 border border-red-100 bg-red-50 px-3 py-1 rounded text-xs font-bold transition">ç§»é™¤</button>
                    </div>
                `;
            });
        };

        window.addNewMember = function() {
            const nameInput = document.getElementById('new-member-name');
            const name = nameInput.value.trim();
            if(!name) return;
            if(window.settingMembers.includes(name)) { showMsg('æˆå“¡å·²ç¶“åœ¨åå–®ä¸­å›‰ï¼'); return; }
            window.settingMembers.push(name);
            nameInput.value = '';
            renderSettingsMembers();
        };

        window.removeMember = function(idx) {
            if(confirm('ç¢ºå®šè¦ç§»é™¤é€™ä½æˆå“¡å—ï¼Ÿ\n(æ³¨æ„ï¼šå¦‚æœä»–å·²ç¶“æœ‰è¨˜å¸³ç´€éŒ„ï¼Œå»ºè­°ä¿ç•™)')) {
                window.settingMembers.splice(idx, 1);
                renderSettingsMembers();
            }
        };

        window.saveSettings = function() {
            // å„²å­˜åŒ¯ç‡
            const newRate = parseFloat(document.getElementById('setting-base-rate').value) || 41;
            if(document.getElementById('base-rate')) document.getElementById('base-rate').value = newRate;
            localStorage.setItem('korea_base_rate', newRate);

            // å„²å­˜æˆå“¡åå–®åˆ°è¨˜æ†¶é«”
            localStorage.setItem('korea_members_v1', JSON.stringify(window.settingMembers));
            
            // â˜… ç¥å¥‡åŒæ­¥è¡“ï¼šå¼·åˆ¶æŠŠæ–°åå–®è¦†å¯«é€²ç³»çµ±è£¡ â˜…
            if (typeof travelMembers !== 'undefined' && Array.isArray(travelMembers)) {
                travelMembers.length = 0; // æŠŠèˆŠç³»çµ±çš„é™£åˆ—æ¸…ç©º
                window.settingMembers.forEach(m => travelMembers.push(m)); // æŠŠæ–°è¨­å®šçš„äººå¡é€²å»
            }

            // é‡æ–°åˆ·æ–°ç•«é¢ä¸Šçš„æŒ‰éˆ•èˆ‡æ¸…å–®
            if(typeof renderPayerRadios === 'function') renderPayerRadios();
            if(typeof renderSplitMembersCheckboxes === 'function') renderSplitMembersCheckboxes();
            if(typeof calculateSettlement === 'function') calculateSettlement();

            closeSettings();
            
            // æç¤ºæˆåŠŸ
            if(typeof showMsg === 'function') showMsg('è¨­å®šå·²æˆåŠŸå„²å­˜ä¸¦å¥—ç”¨ï¼âœ¨');
            else alert('è¨­å®šå·²æˆåŠŸå„²å­˜ä¸¦å¥—ç”¨ï¼âœ¨');
        };

        // æ””æˆªåŸæœ¬çš„åå–®ç®¡ç†æŒ‰éˆ•
        window.editMembers = window.openSettings;
		
document.addEventListener('DOMContentLoaded', () => {
            // è‡ªå‹•æ¬ç§»ã€Œå…¥å¢ƒæ•™å­¸ã€åˆ°èˆªç­é é¢
            const entryCardIdx = infoCardsData.findIndex(c => c.id === 'c_entry2026');
            if (entryCardIdx !== -1) {
                const entryCard = infoCardsData.splice(entryCardIdx, 1)[0];
                if (!flightCardsData.some(c => c.id === 'c_entry2026')) {
                    flightCardsData.push(entryCard);
                }
            }

            // â˜… è‡ªå‹•æ–°å¢ã€Œè¡Œæå¯„å­˜èˆ‡åœ°åœ–æŸ¥è©¢ã€å¡ç‰‡åˆ°è³‡è¨Šé é¢
            if (!infoCardsData.some(c => c.id === 'c_luggage')) {
                infoCardsData.unshift({
                    id: 'c_luggage', title: 'é¦–çˆ¾/é‡œå±± è¡Œæå¯„å­˜æŸ¥è©¢', icon: 'fa-suitcase-rolling', color: '#b45309',
                    blocks: [
                        { type: 'badge', items: [
                            { style: '#f3f4f6', textColor: '#374151', titleColor: '#111827', badge: 'é¦–çˆ¾', title: 'é¦–çˆ¾ T-Luggage', details: [{text: 'https://tluggage.co.kr/', isLink: true, linkName: 'åœ°éµç½®ç‰©æ«ƒé ç´„'}] },
                            { style: '#e0f2fe', textColor: '#0284c7', titleColor: '#0369a1', badge: 'é‡œå±±', title: 'é‡œå±± Zim Carry', details: [{text: 'https://zimcarry.net/', isLink: true, linkName: 'è»Šç«™æ©Ÿå ´è¡Œæé‹é€'}] },
                            { style: '#dcfce7', textColor: '#15803d', titleColor: '#14532d', badge: 'åœ°åœ–', title: 'æ‰¾å°‹æˆ‘é™„è¿‘çš„ç½®ç‰©æ«ƒ', details: [{text: 'https://www.google.com/maps/search/ë¬¼í’ˆë³´ê´€í•¨/', isLink: true, linkName: 'ğŸ“ Google åœ°åœ–æœå°‹é™„è¿‘'}] }
                        ]}
                    ]
                });
            }

            // â˜… è‡ªå‹•è½‰æ›èˆŠçš„å‚™å¿˜éŒ„
            if (listsCardsData.length === 0 && typeof memoList !== 'undefined' && memoList.length > 0) {
                listsCardsData.push({
                    id: 'l1', title: 'æˆ‘çš„æ—…éŠå‚™å¿˜éŒ„', icon: 'fa-edit', color: '#0369a1',
                    blocks: memoList.map(m => ({ type: 'text', text: m.text }))
                });
            }
            window.saveGlobalState({ infoCardsStr: JSON.stringify(infoCardsData), flightCardsStr: JSON.stringify(flightCardsData), listsCardsStr: JSON.stringify(listsCardsData) });

            // ç¬é–“è¼‰å…¥é›¢ç·šè³‡æ–™
            initTitlesUI();
            showTab('plan'); 
            renderCards('plan'); 
            renderCards('flight'); 
            renderCards('info'); 
            renderCards('lists'); // â˜… æ¸²æŸ“æ–°ç‰ˆå‚™å¿˜éŒ„å¡ç‰‡
            renderChecklist(); 
            renderPayerRadios(); 
            renderSplitMembersCheckboxes(); 
            renderExpColorPicker();
			renderExpenses(); 
            fetchWeather();
            fetchExchangeRate(false); 
            if(window.setCurrentTimeToInput) window.setCurrentTimeToInput();
        });
		
// ==========================================
        // â˜… çµ‚æ¥µå®‰å…¨ç‰ˆï¼šè¦–è¦ºåŒ–è¨­å®šä¸­å¿ƒå¤–æ› (ä¿®å¾©æ–°å¢èˆ‡é›²ç«¯åŒæ­¥) â˜…
        // ==========================================
        setTimeout(() => {
            // 1. å‹•æ…‹å¹«ä½ ç”¢ç”Ÿè¨­å®šè¦–çª— HTML (ä¿®æ­£ ID è¡çª)
            if (!document.getElementById('settings-modal')) {
                const modalHTML = `
                <div id="settings-modal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center backdrop-blur-sm transition-opacity">
                    <div class="bg-white rounded-2xl w-11/12 max-w-md max-h-[85vh] overflow-hidden shadow-2xl flex flex-col">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <h3 class="font-bold text-gray-800 flex items-center"><i class="fas fa-cog text-gray-500 mr-2"></i>APP åå–®è¨­å®š</h3>
                            <button onclick="closeSettings()" class="text-gray-400 hover:text-red-500 transition p-1"><i class="fas fa-times text-xl"></i></button>
                        </div>
                        <div class="p-4 space-y-4 overflow-y-auto flex-1 bg-white">
                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                                <label class="block text-xs font-bold text-gray-700 mb-2"><i class="fas fa-user-friends mr-1"></i>åŒè¡Œæˆå“¡ç®¡ç†</label>
                                <div class="flex space-x-2 mb-3">
                                    <input type="text" id="setting-new-member" placeholder="è¼¸å…¥æ–°æˆå“¡..." class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm font-bold text-gray-800 outline-none focus:border-blue-500 bg-white">
                                    <button onclick="addNewMember()" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm font-bold shadow active:scale-95 transition">æ–°å¢</button>
                                </div>
                                <div id="settings-members-list" class="space-y-2 max-h-48 overflow-y-auto pr-1"></div>
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end">
                            <button onclick="saveSettings()" class="w-full bg-blue-600 text-white px-6 py-2.5 rounded-xl text-sm font-bold shadow-md active:scale-95 transition">å„²å­˜ä¸¦å¥—ç”¨</button>
                        </div>
                    </div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            // 2. è®€å–è¨˜æ†¶é«”åå–®
            const savedMembers = JSON.parse(localStorage.getItem('korea_members_v1'));
            if (savedMembers && typeof travelMembers !== 'undefined') {
                travelMembers.length = 0;
                savedMembers.forEach(m => travelMembers.push(m));
            }

            // 3. ç¶å®šå¤§è…¦é‚è¼¯
            window.openSettings = function() {
                renderSettingsMembers();
                document.getElementById('settings-modal').classList.remove('hidden');
            };

            window.closeSettings = function() {
                document.getElementById('settings-modal').classList.add('hidden');
            };

            window.renderSettingsMembers = function() {
                const container = document.getElementById('settings-members-list');
                if(!container) return;
                container.innerHTML = '';
                travelMembers.forEach((m, idx) => {
                    container.innerHTML += `
                        <div class="flex justify-between items-center bg-white border border-gray-200 px-3 py-2 mb-2 rounded-lg shadow-sm">
                            <span class="font-bold text-gray-700 text-sm"><i class="fas fa-user text-gray-400 mr-2 text-xs"></i>${m}</span>
                            <button onclick="removeMember(${idx})" class="text-red-500 hover:text-white hover:bg-red-500 border border-red-100 bg-red-50 px-3 py-1 rounded text-xs font-bold transition">ç§»é™¤</button>
                        </div>
                    `;
                });
            };

			window.addNewMember = function() {
                const nameInput = document.getElementById('setting-new-member');
                const name = nameInput.value.trim();
                if(!name) return;
                
                // æª¢æŸ¥æ˜¯å¦é‡è¤‡
                if(travelMembers.includes(name)) { 
                    showMsg('âŒ ã€Œ' + name + 'ã€å·²ç¶“åœ¨åå–®ä¸­å›‰ï¼'); 
                    return; 
                }
                
                travelMembers.push(name);
                nameInput.value = '';
                renderSettingsMembers();
                
                // â˜… æ–°å¢ï¼šåŠ å…¥æˆåŠŸå¾Œçš„å½ˆçª—æé†’ â˜…
                showMsg('âœ… å·²æˆåŠŸå°‡ã€Œ' + name + 'ã€åŠ å…¥æˆå“¡åå–®ï¼');
            };

            window.removeMember = function(idx) {
                const name = travelMembers[idx];
                // â˜… ä¿®æ”¹ï¼šä½¿ç”¨è‡ªè¨‚çš„ showMsg ä»£æ›¿ç³»çµ± confirmï¼Œä¿æŒé¢¨æ ¼ä¸€è‡´ â˜…
                showMsg('ç¢ºå®šè¦ç§»é™¤ã€Œ' + name + 'ã€å—ï¼Ÿ\n(æ³¨æ„ï¼šå¦‚æœä»–å·²ç¶“æœ‰è¨˜å¸³ç´€éŒ„ï¼Œå»ºè­°ä¿ç•™å–”ï¼)', true, () => {
                    travelMembers.splice(idx, 1);
                    renderSettingsMembers();
                });
            };
			
            window.saveSettings = function() {
                localStorage.setItem('korea_members_v1', JSON.stringify(travelMembers));
                if(typeof renderPayerRadios === 'function') renderPayerRadios();
                if(typeof renderSplitMembersCheckboxes === 'function') renderSplitMembersCheckboxes();
                if(typeof calculateSettlement === 'function') calculateSettlement();
                
                // â˜… æ–°å¢ï¼šå„²å­˜æ™‚é †ä¾¿åŒæ­¥ä¸Šå‚³åˆ° Firebase é›²ç«¯ï¼
                if(typeof saveGlobalState === 'function') {
                    saveGlobalState({ travelMembers: travelMembers });
                }
                
                closeSettings();
                showMsg('è¨­å®šå·²æˆåŠŸå„²å­˜ä¸¦åŒæ­¥è‡³é›²ç«¯ï¼âœ¨');
            };

            // 4. æŠŠç•«é¢ä¸ŠåŸæœ¬çš„åå–®ç®¡ç†æŒ‰éˆ•é€£æ¥éä¾†
            window.editMembers = window.openSettings;
            if(typeof renderPayerRadios === 'function') renderPayerRadios();
            if(typeof renderSplitMembersCheckboxes === 'function') renderSplitMembersCheckboxes();
        }, 800);
		
		</script>
		
	<div id="settlement-modal" class="fixed inset-0 bg-black/60 z-[200] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg border border-gray-200 p-5 w-full max-w-[320px] shadow-2xl animate-fade-in">
			<div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-2">
                <h3 class="font-bold text-gray-900 text-lg"><i class="fas fa-file-invoice-dollar text-[#0369a1] mr-2"></i>åˆ†å¸³çµç®—æ¸…å–®</h3>
                <div class="flex space-x-2">
                    <button onclick="exportSettlementCSV()" class="text-[#15803d] hover:bg-[#dcfce7] bg-[#f0fdf4] border border-[#bbf7d0] px-2 py-1 rounded text-xs font-bold transition shadow-sm flex items-center"><i class="fas fa-file-excel mr-1"></i>åŒ¯å‡ºæ˜ç´°</button>
                    <button onclick="closeSettlementModal()" class="text-gray-500 hover:text-gray-800 transition p-1"><i class="fas fa-times text-lg"></i></button>
                </div>
            </div>            <div id="settlement-content" class="space-y-3 max-h-[60vh] overflow-y-auto hide-scrollbar">
                </div>
            <button onclick="closeSettlementModal()" class="mt-5 text-sm bg-gray-800 text-white px-4 py-2 rounded font-bold shadow w-full hover:bg-gray-900 transition">å®Œæˆ</button>
        </div>
    </div>

<div id="settlement-detail-modal" class="fixed inset-0 bg-black/70 z-[300] hidden items-center justify-center p-4 backdrop-blur-sm" onclick="closeSettlementDetail()">
        <div class="bg-white rounded-lg border border-gray-200 p-5 w-full max-w-[300px] shadow-2xl animate-fade-in" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-3 border-b border-gray-200 pb-2">
                <h3 id="detail-member-name" class="font-bold text-gray-900 text-base">å¸³å‹™æ˜ç´°</h3>
                <button onclick="closeSettlementDetail()" class="text-gray-400 hover:text-gray-800 transition p-1"><i class="fas fa-times"></i></button>
            </div>
            
			<div class="max-h-[50vh] overflow-y-auto hide-scrollbar">
                <div id="detail-transfer-list" class="mb-4"></div>

                <h4 class="text-[11px] font-bold text-[#15803d] bg-[#dcfce7] px-2 py-1 rounded mb-1">ğŸ’° ä»–ä»£å¢Šçš„é …ç›® (å¹«å¤§å®¶ä»˜çš„)</h4>
                <div id="detail-paid-list" class="mb-4 bg-gray-50 p-2 rounded border border-gray-100"></div>

                <h4 class="text-[11px] font-bold text-[#e11d48] bg-[#ffe4e6] px-2 py-1 rounded mb-1">ğŸ’¸ ä»–æ‡‰åˆ†æ”¤çš„é …ç›® (è‡ªå·±è©²å‡ºçš„)</h4>
                <div id="detail-shouldpay-list" class="bg-gray-50 p-2 rounded border border-gray-100"></div>
            </div>            
            <button onclick="closeSettlementDetail()" class="mt-4 text-xs bg-gray-100 text-gray-700 px-4 py-2 rounded font-bold shadow-sm w-full hover:bg-gray-200 transition border border-gray-300">é—œé–‰æ˜ç´°</button>
        </div>
    </div>
		
</body>
</html>
